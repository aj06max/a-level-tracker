<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>A Level Revision Tracker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=Geist+Mono:wght@400;500;600;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f0f0f;--white:#1a1a1a;--border:#2a2a2a;--text:#f0f0f0;--muted:#666;
  --light:#222;--light2:#1e1e1e;
  --red:#ff4444;--orange:#ff6b00;--green:#22c55e;--blue:#ff6b00;--teal:#f59e0b;
  --redbg:#2a1010;--bluebg:#1a1200;
  --surface:#161616;--surface2:#1c1c1c;--accent:#ff6b00;--accent2:#ff8c40;
  --mono:'Geist Mono',monospace;
}

/* ── CLASSIC LIGHT THEME (when body.classic-theme is active) ── */
body.classic-theme{
  --bg:#f5f5f7;--white:#fff;--border:#e5e5e7;--text:#1d1d1f;--muted:#6e6e73;
  --light:#f0f0f2;--light2:#f8f8fa;
  --red:#ff3b30;--orange:#ff9500;--green:#34c759;--blue:#007aff;--teal:#32ade6;
  --redbg:#fff2f1;--bluebg:#f0f6ff;
  --surface:#fff;--surface2:#f8f8fa;--accent:#007aff;--accent2:#0066dd;
}
body.classic-theme .header{background:rgba(255,255,255,0.92)}
body.classic-theme .logo-dot{box-shadow:0 0 0 transparent}
body.classic-theme .tab.on{box-shadow:0 1px 5px rgba(0,0,0,.11)}
body.classic-theme .scard:hover{border-color:var(--blue)}
body.classic-theme .alert.on{border-color:#ffd0ce;background:var(--redbg)}
body.classic-theme .syncpill.ok{border-color:rgba(52,199,89,.3);background:rgba(52,199,89,.08)}
body.classic-theme .syncpill.sync{border-color:rgba(0,122,255,.3);background:rgba(0,122,255,.08)}
body.classic-theme .syncpill.off{border-color:rgba(255,59,48,.3);background:rgba(255,59,48,.08)}
body.classic-theme{font-family:'Inter',sans-serif}
body.classic-theme .snum,body.classic-theme .sw-time,body.classic-theme .alert-rank,
body.classic-theme .alert-score,body.classic-theme .bval,body.classic-theme .syncpill{font-family:'Inter',sans-serif}

/* ── PINK THEME (secret unlock) ── */
body.pink-theme{
  --bg:#1a0d1a;--white:#2d1a2d;--border:#4d2d4d;--text:#ffeef9;--muted:#d4a5c9;
  --light:#3d2a3d;--light2:#2d1a2d;
  --red:#ff6b9d;--orange:#ff85d4;--green:#b794f6;--blue:#ff85d4;--teal:#e879f9;
  --redbg:#2d1a25;--bluebg:#2d1a2d;
  --surface:#251825;--surface2:#2d1a2d;--accent:#ff85d4;--accent2:#ffa3e3;
}
body.pink-theme .header{background:rgba(26,13,26,0.95)}
body.pink-theme .logo-dot{box-shadow:0 0 12px #ff85d4}
body.pink-theme .tab.on{box-shadow:0 2px 8px rgba(255,133,212,.3)}
body.pink-theme .scard:hover{border-color:#ff85d4}
body.pink-theme .alert.on{border-color:#ff6b9d;background:#2d1a25}
body.pink-theme .syncpill.ok{border-color:rgba(183,148,246,.4);background:rgba(183,148,246,.12)}
body.pink-theme .syncpill.sync{border-color:rgba(255,133,212,.4);background:rgba(255,133,212,.12)}
body.pink-theme .syncpill.off{border-color:rgba(255,107,157,.4);background:rgba(255,107,157,.12)}
body.pink-theme #profileScreen::after{background-image:linear-gradient(rgba(255,133,212,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,133,212,.03) 1px,transparent 1px)}
body.pink-theme .profile-floater{color:rgba(255,133,212,.15)}
body.pink-theme .floater{color:rgba(255,133,212,.18)}

/* ── LIGHT PINK THEME (secret unlock) ── */
body.light-pink-theme{
  --bg:#fff0f9;--white:#fff;--border:#f5d9ed;--text:#5c2b4d;--muted:#a8678f;
  --light:#fce8f7;--light2:#fff5fc;
  --red:#d63384;--orange:#e85d9c;--green:#9b6fb8;--blue:#e85d9c;--teal:#c74aa8;
  --redbg:#ffe8f5;--bluebg:#fff0f9;
  --surface:#fff;--surface2:#fff5fc;--accent:#e85d9c;--accent2:#d63384;
}
body.light-pink-theme .header{background:rgba(255,240,249,0.95)}
body.light-pink-theme .logo-dot{box-shadow:0 0 12px #e85d9c}
body.light-pink-theme .tab.on{box-shadow:0 2px 8px rgba(232,93,156,.2)}
body.light-pink-theme .scard:hover{border-color:#e85d9c}
body.light-pink-theme .alert.on{border-color:#d63384;background:#ffe8f5}
body.light-pink-theme .syncpill.ok{border-color:rgba(155,111,184,.3);background:rgba(155,111,184,.08)}
body.light-pink-theme .syncpill.sync{border-color:rgba(232,93,156,.3);background:rgba(232,93,156,.08)}
body.light-pink-theme .syncpill.off{border-color:rgba(214,51,132,.3);background:rgba(214,51,132,.08)}
body.light-pink-theme #profileScreen::after{background-image:linear-gradient(rgba(232,93,156,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(232,93,156,.03) 1px,transparent 1px)}
body.light-pink-theme .profile-floater{color:rgba(232,93,156,.15)}
body.light-pink-theme .floater{color:rgba(232,93,156,.18)}

body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:14px;-webkit-font-smoothing:antialiased;overflow-x:hidden;transition:background .3s,color .3s}

/* ═══ PROFILE SELECTION SCREEN ═══════════════════════════════ */
#profileScreen{position:fixed;inset:0;z-index:10000;background:var(--bg);display:flex;align-items:center;justify-content:center;opacity:1;transition:opacity .5s;overflow:hidden}
#profileScreen.hidden{opacity:0;pointer-events:none}
#profileScreen::after{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(255,107,0,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,107,0,.03) 1px,transparent 1px);background-size:44px 44px;pointer-events:none;animation:gridDrift 30s linear infinite}
@keyframes gridDrift{0%{transform:translate(0,0)}100%{transform:translate(44px,44px)}}

/* Profile floaters */
.profile-floaters{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0}
.profile-floater{position:absolute;font-size:13px;font-weight:700;font-family:var(--mono);color:rgba(255,107,0,.35);letter-spacing:1px;white-space:nowrap;user-select:none;text-transform:uppercase;opacity:0.35;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1)}
.profile-floater:hover{opacity:0.6;transform:scale(1.2);color:rgba(255,107,0,.6)}

.profile-topbar{position:fixed;top:16px;right:20px;z-index:10002;display:flex;align-items:center;gap:8px}
.profile-topbar .design-toggle{background:var(--surface);border-color:var(--border)}
.profile-container{max-width:620px;width:90%;text-align:center;position:relative;z-index:1}
.profile-title{font-size:40px;font-weight:800;color:var(--text);margin-bottom:8px;letter-spacing:-2px;font-family:'DM Sans',sans-serif;animation:pFadeUp 0.7s cubic-bezier(.2,.8,.2,1)}
.profile-title span{color:var(--accent)}
.profile-subtitle{font-size:11px;color:var(--muted);margin-bottom:56px;font-weight:500;font-family:var(--mono);letter-spacing:2px;text-transform:uppercase;animation:pFadeUp 0.7s cubic-bezier(.2,.8,.2,1) 0.1s backwards}
.profile-cards{display:flex;gap:36px;justify-content:center;align-items:flex-start;flex-wrap:wrap;max-width:480px;margin:0 auto}
.profile-card-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;animation:pFadeUp 0.6s cubic-bezier(.34,1.56,.64,1)}
.profile-card-wrap:nth-child(2){animation-delay:0.12s;animation-fill-mode:backwards}
.profile-card{width:148px;height:148px;border-radius:50%;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;transition:all .35s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
.profile-card::after{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 50% 25%,rgba(255,107,0,.1),transparent 65%);opacity:0;transition:opacity .3s}
.profile-card:hover{border-color:var(--accent);transform:translateY(-6px) scale(1.06);box-shadow:0 0 0 1px rgba(255,107,0,.3),0 24px 48px rgba(255,107,0,.12)}
.profile-card:hover::after{opacity:1}
.profile-card:active{transform:scale(0.96)}
.profile-icon{font-size:40px;line-height:1}
.profile-name{font-size:12px;font-weight:700;color:var(--text);letter-spacing:-.2px;font-family:'DM Sans',sans-serif}
.profile-desc{display:none}
.profile-card-label{font-size:11px;color:var(--muted);line-height:1.6;font-family:var(--mono);text-align:center;max-width:148px}
.profile-badge{position:absolute;top:8px;right:8px;background:var(--accent);color:#fff;width:20px;height:20px;border-radius:50%;font-size:8px;font-weight:800;display:flex;align-items:center;justify-content:center;box-shadow:0 0 10px rgba(255,107,0,.5)}
@keyframes pFadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* ═══ PASSWORD MODAL ═══════════════════════════════════════ */
#passwordModal{position:fixed;inset:0;z-index:10001;background:rgba(0,0,0,.75);backdrop-filter:blur(14px);display:none;align-items:center;justify-content:center;padding:20px}
#passwordModal.on{display:flex;animation:fadeIn 0.25s}
.password-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px 32px;max-width:360px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,.6),0 0 0 1px rgba(255,107,0,.06);animation:scaleIn 0.35s cubic-bezier(.34,1.56,.64,1)}
.password-title{font-size:18px;font-weight:700;color:var(--text);margin-bottom:6px;text-align:center;letter-spacing:-.3px;font-family:'DM Sans',sans-serif}
.password-subtitle{font-size:11px;color:var(--muted);margin-bottom:28px;text-align:center;font-family:var(--mono);letter-spacing:.5px;text-transform:uppercase}
.password-input{width:100%;padding:14px 18px;border:1.5px solid var(--border);border-radius:12px;font-size:22px;text-align:center;font-weight:700;letter-spacing:6px;transition:all .2s;font-family:var(--mono);background:var(--bg);color:var(--text)}
.password-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,0,.12)}
.password-input.error{border-color:var(--red);animation:shake 0.4s}
.password-input::placeholder{letter-spacing:4px;color:var(--border);font-size:16px}
.password-actions{display:flex;gap:10px;margin-top:18px}
.password-btn{flex:1;padding:13px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
.password-btn.primary{background:var(--accent);color:#fff}
.password-btn.primary:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(255,107,0,.3)}
.password-btn.secondary{background:var(--light);color:var(--muted);border:1px solid var(--border)}
.password-btn.secondary:hover{background:var(--border);color:var(--text)}
@keyframes scaleIn{from{opacity:0;transform:scale(0.93)}to{opacity:1;transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ═══ LOADING SCREEN ═══════════════════════════════════════ */
#loadingScreen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:none;align-items:center;justify-content:center;flex-direction:column;overflow:hidden}
#loadingScreen.on{display:flex;animation:fadeIn 0.35s cubic-bezier(.2,.8,.2,1)}
.loading-floaters{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:1}
.floater{position:absolute;font-size:13px;font-weight:700;font-family:var(--mono);color:rgba(255,107,0,.35);letter-spacing:1px;white-space:nowrap;user-select:none;text-transform:uppercase;opacity:0.35;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1)}
.floater:hover{opacity:0.6;transform:scale(1.2);color:rgba(255,107,0,.6)}
@keyframes floatWord{0%{opacity:0.15}100%{opacity:0.15}}
.loading-content{text-align:center;max-width:480px;padding:40px;position:relative;z-index:2}
.loading-logo{display:none}
.loading-brand{font-size:52px;font-weight:800;color:var(--text);letter-spacing:-2.5px;margin-bottom:6px;font-family:'DM Sans',sans-serif;line-height:1}
.loading-brand span{color:var(--accent)}
.loading-text{font-size:13px;font-weight:600;color:var(--text);margin-bottom:3px;font-family:var(--mono);letter-spacing:.5px;transition:opacity .4s;min-height:20px}
.loading-subtext{font-size:11px;color:var(--muted);margin-bottom:32px;font-family:var(--mono);transition:opacity .4s;min-height:16px}
.loading-bar-wrap{width:180px;height:1.5px;background:var(--light);border-radius:2px;margin:0 auto;position:relative}
.loading-bar{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width 0.5s cubic-bezier(.4,0,.2,1);box-shadow:0 0 8px var(--accent),0 0 16px rgba(255,107,0,.35);position:relative}
.loading-bar::after{content:'';position:absolute;right:-2px;top:-2px;width:5px;height:5px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent)}
.loading-tip{display:none}
@keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-20px)}}
@keyframes shimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes fadeInOut{0%,100%{opacity:0.5}50%{opacity:1}}

/* ═══════════════════════════════════════════════════════════
   MOBILE OPTIMIZATIONS 
   ══════════════════════════════════════════════════════════ */

/* Mobile: Auto-hide header on scroll */
@media(max-width:720px){
  /* Fix iPhone notch background */
  html {
    background: var(--bg);
  }

  body {
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    transform: translateY(0);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--bg);
    padding: 8px 0 0;
    padding-top: calc(8px + env(safe-area-inset-top));
  }
  
  .header.header-hidden {
    transform: translateY(-100%);
  }
  
  .header.header-show {
    transform: translateY(0);
  }
  
  body.classic-theme .header {
    background: var(--bg);
  }
  
  /* Hide subtabs completely on mobile - shown via popup */
  .header-row2 {
    display: none !important;
  }
  
  .header-row1{padding:0 12px 6px;gap:6px;min-height:48px}
  .logo{gap:6px}
  .logo-dot{width:6px;height:6px}
  .app-title{font-size:13px;letter-spacing:-0.2px}
  .app-sub{display:none}
  .design-toggle{padding:4px 8px;gap:4px;border-radius:8px}
  .design-toggle-icon{font-size:12px}
  .design-toggle-label{display:none}
  .syncpill{font-size:10px;padding:4px 8px;gap:4px}
  .tabs{padding:2px;gap:1px;border-radius:8px}
  .tab{padding:6px 10px;font-size:11px;border-radius:6px}
  .hprog{display:none}
  
  /* Main content spacing */
  .main {
    margin-top: 0;
    padding-top: calc(70px + env(safe-area-inset-top));
  }
  
  /* Overview tiles container */
  .overview-tiles {
    position: sticky;
    top: calc(60px + env(safe-area-inset-top));
    z-index: 100;
    margin: 0 -12px 20px;
    padding: 12px;
    background: var(--bg);
    transform: translateX(0);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
  }
  
  .overview-tiles.tiles-hidden {
    transform: translateX(-120%);
    opacity: 0;
    pointer-events: none;
  }
  
  /* Zoom topics when overview tiles hidden */
  .page {
    padding: 14px 12px 100px;
  }
  
  .grid {
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Subject selection popup for mobile */
  .subject-popup {
    position: fixed;
    inset: 0;
    z-index: 500;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(20px);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .subject-popup.on {
    display: flex;
    animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .subject-popup-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 28px 24px;
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }

  .subject-popup-title {
    font-size: 20px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 6px;
    font-family: 'DM Sans', sans-serif;
    letter-spacing: -0.4px;
    text-align: center;
  }

  .subject-popup-subtitle {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 24px;
    font-family: var(--mono);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
  }

  .subject-popup-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .subject-option {
    padding: 16px 18px;
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 14px;
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .subject-option:active {
    transform: scale(0.98);
  }

  .subject-option:hover {
    border-color: var(--accent);
    background: var(--surface);
  }

  .subject-option-arrow {
    font-size: 16px;
    color: var(--muted);
  }

  .subject-popup-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 18px;
  }

  /* Topic modal (full screen zoom-in) */
  .topic-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(30, 60, 114, 0.3);
    backdrop-filter: blur(24px);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
    overflow: hidden;
  }

  .topic-modal.on {
    display: flex;
    animation: fadeIn 0.25s ease-out;
  }

  .topic-modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    width: 100%;
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    animation: zoomIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }

  .topic-modal-header {
    position: sticky;
    top: 0;
    background: var(--surface);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 20px 20px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
  }

  .topic-modal-title {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    letter-spacing: -0.3px;
    flex: 1;
  }

  .topic-modal-close {
    width: 36px;
    height: 36px;
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text);
    font-size: 20px;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .topic-modal-close:active {
    transform: scale(0.9);
  }

  .topic-modal-body {
    padding: 24px 20px 40px;
  }

  /* Mobile AI Panel - Hidden on mobile */
  #aiPanel {
    display: none !important;
  }
  
  .ai-btn {
    display: none !important;
  }

  /* Mobile AI toggle button */
  .ai-toggle {
    display: none !important; /* Completely hidden on mobile */
  }
  
  /* Hide AI button on mobile */
  .ai-btn {
    display: none !important;
  }
  
  /* Hide AI panel on mobile */
  #aiPanel {
    display: none !important;
  }
}

/* Animations used by mobile features */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(40px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes zoomIn {
  from {
    opacity: 0;
    transform: scale(0.85);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* ══ DESIGN TOGGLE BUTTON ══ */
.design-toggle{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px 12px;cursor:pointer;user-select:none;transition:all .2s}
.design-toggle:hover{border-color:var(--accent)}
.design-toggle-icon{font-size:14px}
.design-toggle-label{font-size:11px;font-weight:600;color:var(--muted);font-family:var(--mono)}

/* ── HEADER ── */
.header{background:rgba(15,15,15,0.95);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;padding:10px 0 0}
.header-row1{max-width:1160px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:0 28px 8px 28px}
.header-row2{max-width:1160px;margin:0 auto;padding:0 28px 8px 28px}

/* Desktop: Ensure tabs stay on the right */
@media(min-width:721px){
  .header-mob-tabs{display:none !important}
  .tabs{order:10}
  /* Hide mobile popups on desktop */
  .subject-popup, .topic-modal{display:none !important}
}
.logo{display:flex;align-items:center;gap:10px}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent)}
.app-title{font-size:15px;font-weight:700;letter-spacing:-.4px;color:var(--text)}
.app-sub{font-size:11px;color:var(--muted)}
.hright{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* ── CLOUD SYNC PILL ── */
.syncpill{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:999px;padding:5px 10px;font-size:11px;font-weight:600;color:var(--muted);user-select:none;font-family:var(--mono)}
.syncpill b{font-weight:700;color:var(--text)}
.syncpill.ok{color:var(--green);border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.08)}
.syncpill.sync{color:var(--accent);border-color:rgba(255,107,0,.3);background:rgba(255,107,0,.08)}
.syncpill.off{color:var(--red);border-color:rgba(255,68,68,.3);background:rgba(255,68,68,.08)}
button,input,select,textarea{touch-action:manipulation}
/* prevent iOS zoom on input focus */
@media(max-width:720px){
  input,select,textarea{font-size:16px !important}
  .sinput{font-size:18px !important}
}

/* ── IMPROVED TOUCH INTERFACE ── */
/* These work on touch devices without breaking desktop */
@media (hover: none) and (pointer: coarse) {
  /* Touch-only improvements */
  button, .ai-chip, .tab, .stab, .qcard, .scard, .ccard, .ai-hbtn {
    -webkit-tap-highlight-color: rgba(255,107,0,0.1);
  }
  
  /* Larger tap targets */
  .sinput { min-height: 48px; }
  .ai-send, .swb { min-width: 44px; min-height: 44px; }
  .tab { min-height: 44px; padding: 11px 14px; }
  .stab { min-height: 40px; padding: 9px 12px; }
  
  /* Better scrolling */
  .ai-msgs, .qbank-body, .page { 
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
  }
  
  /* Remove hover effects on touch */
  .scard:hover, .ccard:hover, .qcard:hover {
    transform: none;
  }
  
  /* Touch feedback */
  button:active, .ai-chip:active, .tab:active, .stab:active {
    transform: scale(0.97);
    transition: transform 0.1s;
  }
}

/* ── MOBILE / TOUCH OPTIMISATIONS ── */
@media(max-width:720px){
  .charts,.alert,.legend{display:none !important}
  .header-row1{padding:0 12px 8px 9px;gap:8px}
  .page,#examPage{padding:14px 12px 100px}
  .tab{padding:9px 10px;font-size:12px}
  .stab{padding:7px 9px;font-size:11px}
  .stopwatch{display:none}
  .sinput{width:64px;height:48px;font-size:18px;border-radius:12px}
  .chdr{padding:15px 14px}
  .srow{padding:13px 14px;gap:8px}
  .note-btn{display:none !important}
  .qgrid{min-width:0}
  .qgrid-wrap{display:none !important}
  #en_practice{display:none !important}
  .snum{font-size:22px}
  .scard{padding:11px 11px}
  .summary{grid-template-columns:repeat(3,1fr);gap:7px}
  .grid{grid-template-columns:1fr;gap:8px}
  .cname{font-size:14px}
  .sname{font-size:13px}
  .pill{width:30px;height:30px}
  .design-toggle .design-toggle-label{display:none}
  .hright{gap:6px}
  #viewerModal .modal{width:100vw !important;max-height:100dvh;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0}
  #viewerModal{align-items:flex-end;padding:0}
  #attModal .modal{width:100vw !important;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0}
  #attModal{align-items:flex-end;padding:0}
  #addQModal .modal{width:100vw !important;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0;max-height:90dvh}
  #addQModal{align-items:flex-end;padding:0}
  .att-score-in,.att-out-in{width:80px;height:52px;font-size:22px}
  .att-score-row{gap:12px;justify-content:center}
  .att-submit-btn{min-height:50px;font-size:15px;border-radius:12px}
  #examLogModal .elm-box{width:100%;border-radius:16px 16px 0 0;position:fixed;bottom:0;left:0;right:0}
  #examLogModal{align-items:flex-end;padding:0}
  .elm-input{min-height:52px;font-size:22px}
  .vatt-in{min-height:48px;font-size:17px}
  .vatt-submit{min-height:48px;font-size:15px}
  .aq-upload-grid{grid-template-columns:1fr;gap:10px}
  .aq-zone{min-height:90px;border-radius:14px;cursor:pointer;-webkit-tap-highlight-color:rgba(255,107,0,.15)}
  .aq-zone-icon{font-size:28px}
  .aq-zone-label{font-size:14px}
  .aqstar{width:36px;height:36px;border-radius:8px}
  .modal-foot{padding:14px 16px;padding-bottom:calc(14px + env(safe-area-inset-bottom))}
  .btn{min-height:48px;font-size:14px;border-radius:12px}
}

/* ── AI PANEL MOBILE: full-screen ── */
.ai-mobile-back{display:none;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--light);cursor:pointer;font-size:20px;color:var(--muted);margin-right:2px;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.ai-mobile-back:active{background:var(--border)}
@media(max-width:720px){
  .ai-btn{bottom:20px;right:16px;width:58px;height:58px;border-radius:18px;font-size:26px;box-shadow:0 6px 28px rgba(255,107,0,.55)}
  .ai-btn.open{display:none !important}
  #aiPanel{
    position:fixed !important;
    top:0 !important;left:0 !important;bottom:0 !important;right:0 !important;
    width:100vw !important;max-width:100vw !important;
    height:calc(var(--vh,1vh)*100) !important;max-height:calc(var(--vh,1vh)*100) !important;min-height:unset !important;
    border-radius:0 !important;border:none !important;
    transform:translateY(100%) !important;
    z-index:1000;
    transition:transform .3s cubic-bezier(.2,.9,.2,1) !important;
    -webkit-overflow-scrolling:touch;
  }
  #aiPanel.on{transform:translateY(0) !important}
  .ai-head{padding:16px 14px 12px;padding-top:calc(env(safe-area-inset-top,0px) + 16px)}
  .ai-head-title{font-size:16px}
  .ai-head-sub{font-size:12px}
  .ai-msgs{padding:14px 14px 8px;gap:12px}
  .ai-bubble{font-size:14px;padding:12px 14px;max-width:88%}
  .ai-avatar{width:28px;height:28px;font-size:12px}
  .ai-chips{padding:0 12px 10px;gap:8px;overflow-x:auto;flex-wrap:nowrap}
  .ai-chip{font-size:13px;padding:8px 16px;border-radius:20px;flex-shrink:0;white-space:nowrap}
  .ai-input-row{padding:10px 12px;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 12px);border-top:1.5px solid var(--border)}
  .ai-input{font-size:16px;padding:11px 14px;min-height:46px;border-radius:14px;-webkit-appearance:none}
  .ai-send{width:46px;height:46px;border-radius:14px;font-size:20px}
  .ai-empty{font-size:14px;padding:40px 24px}
  .ai-empty-icon{font-size:40px}
  .ai-hbtn{width:36px;height:36px;font-size:15px}
  .ai-mobile-back{display:flex !important}
}
/* subject tabs (larger) */
.tabs{display:flex;background:var(--surface);border-radius:10px;padding:3px;gap:2px;border:1px solid var(--border)}
.tab{padding:7px 18px;border-radius:8px;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s}
.tab.on{background:var(--accent);color:#fff;font-weight:700;box-shadow:0 2px 8px rgba(255,107,0,.35)}
.tab:hover:not(.on){color:var(--text);background:var(--light)}
/* sub-tabs (smaller) */
.subtabs{display:flex;gap:4px;flex-wrap:wrap}
.stab{padding:5px 14px;border-radius:7px;border:1px solid transparent;background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s}
.stab.on{background:var(--surface2);border-color:var(--border);color:var(--accent);font-weight:600}
.stab:hover:not(.on){background:var(--light);color:var(--text)}

/* ── STOPWATCH ── */
.stopwatch{display:flex;align-items:center;gap:7px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px 12px;user-select:none}
.sw-time{font-size:14px;font-weight:600;letter-spacing:2px;font-variant-numeric:tabular-nums;min-width:54px;text-align:center;color:var(--text);transition:color .2s;font-family:var(--mono)}
.sw-time.run{color:var(--accent)}.sw-time.pau{color:var(--teal)}
.swb{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s;background:var(--light);color:var(--muted)}
.swb:hover{border-color:var(--accent);color:var(--accent);background:var(--bluebg)}

/* ── PAGE ── */
.page{max-width:1160px;margin:0 auto;padding:22px 28px 80px}

/* ── SUMMARY ── */
.summary{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px}
@media(max-width:640px){.summary{grid-template-columns:repeat(3,1fr)}}
.scard{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;transition:border-color .2s,transform .2s}
.scard:hover{border-color:var(--accent);transform:translateY(-1px)}
.snum{font-size:26px;font-weight:700;letter-spacing:-1px;line-height:1;font-family:var(--mono)}
.slbl{font-size:10px;color:var(--muted);margin-top:4px;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.scard-bar{height:2px;border-radius:2px;margin-top:12px;background:var(--light);overflow:hidden}
.scard-bar-fill{height:100%;border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1)}

/* ── ALERT ── */
.alert{border:1px solid transparent;border-radius:12px;padding:0;margin-bottom:18px;overflow:hidden;max-height:0;opacity:0;transition:max-height .45s cubic-bezier(.4,0,.2,1),opacity .35s,border-color .3s}
.alert.on{max-height:400px;opacity:1;border-color:rgba(255,68,68,.3);background:rgba(255,68,68,.06)}
.alert-inner{padding:14px 18px}
.alert-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.alert-icon{width:28px;height:28px;background:rgba(255,68,68,.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.alert-title{font-size:12px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.5px}
.alert-desc{font-size:11px;color:var(--muted);margin-top:1px}
.alert-body{display:flex;flex-direction:column;gap:7px}
.alert-row{display:flex;align-items:center;gap:10px}
.alert-rank{width:18px;height:18px;background:rgba(255,68,68,.15);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--red);flex-shrink:0;font-family:var(--mono)}
.alert-info{flex:1;min-width:0}
.alert-name{font-size:12px;font-weight:600;color:var(--text)}
.alert-reason{font-size:10px;color:var(--muted);margin-top:1px}
.alert-score{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums;font-family:var(--mono)}

/* ── CHARTS ── */
.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px}
@media(max-width:720px){.charts{grid-template-columns:1fr}}
.ccrd{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px}
.ctitle{font-size:12px;font-weight:700;margin-bottom:1px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)}
.csub{font-size:11px;color:var(--muted);margin-bottom:14px;opacity:.6}

/* bar chart */
.barchart{display:flex;align-items:flex-end;gap:3px;height:160px;padding-bottom:20px;position:relative}
.barchart::before{content:'';position:absolute;bottom:calc(20px + 70%);left:0;right:0;border-top:1px dashed rgba(255,107,0,.2);pointer-events:none}
.barchart::after{content:'7';position:absolute;bottom:calc(18px + 70%);right:0;font-size:8px;color:var(--accent);opacity:.5;font-family:var(--mono)}
.bcol{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;cursor:pointer;gap:2px;position:relative;min-width:0}
.bcol:hover .bfill{filter:brightness(1.15)}
.bcol:hover .bval{opacity:1}
.bval{font-size:8px;font-weight:700;color:var(--accent);position:absolute;top:-16px;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .2s;font-family:var(--mono);white-space:nowrap}
.bfill{width:100%;border-radius:3px 3px 0 0;transition:height .6s cubic-bezier(.34,1.56,.64,1);min-height:3px}
.blabel{font-size:8px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;padding:0 1px}

/* radar */
#radarSvg{width:100%;height:198px;cursor:crosshair}
.rtip{position:absolute;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:11px;font-weight:600;pointer-events:none;display:none;box-shadow:0 4px 14px rgba(0,0,0,.5);z-index:50;color:var(--text)}

/* ── CHAPTER GRID ── */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:10px}
.ccard{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .2s,transform .2s;opacity:0;transform:translateY(8px);animation:cardIn .3s cubic-bezier(.4,0,.2,1) forwards}
@keyframes cardIn{to{opacity:1;transform:none}}
.ccard:hover:not(.open){border-color:rgba(255,107,0,.35);transform:translateY(-1px)}
.ccard.open{border-color:rgba(255,107,0,.4)}
.chdr{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;user-select:none}
.cinfo{flex:1;min-width:0}
.cname{font-size:13px;font-weight:600;margin-bottom:7px;letter-spacing:-.1px;line-height:1.3;color:var(--text)}

/* ── WATER PROGRESS BAR ── */
.wbar-outer{flex:1;height:5px;background:var(--light);border-radius:4px;overflow:hidden;position:relative}
.wbar-fill{position:absolute;inset:0;right:auto;border-radius:4px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.wbar-wave{position:absolute;top:0;bottom:0;right:-1px;width:18px;overflow:hidden;pointer-events:none}
.wbar-wave svg{position:absolute;top:-2px;left:0;height:calc(100% + 4px);animation:ww 1.8s ease-in-out infinite alternate}
@keyframes ww{from{transform:translateY(-2px)}to{transform:translateY(2px)}}
.pbar-wrap{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.pbar-pct{font-size:10px;color:var(--muted);flex-shrink:0;min-width:30px;text-align:right;font-variant-numeric:tabular-nums;font-family:var(--mono)}
.cmeta{font-size:10px;color:var(--muted)}
.cweak{font-size:10px;color:var(--red);margin-top:2px;font-weight:500}
.chev{color:var(--muted);font-size:11px;flex-shrink:0;transition:transform .25s cubic-bezier(.4,0,.2,1),color .2s}
.ccard.open .chev{transform:rotate(180deg);color:var(--accent)}

/* subtopics */
.subs{border-top:1px solid var(--border);animation:slideDown .24s cubic-bezier(.4,0,.2,1)}
@keyframes slideDown{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:none}}
.srow{display:flex;align-items:center;gap:10px;padding:8px 16px;border-bottom:1px solid var(--border);transition:background .1s}
.srow:last-of-type{border-bottom:none}
.srow:hover{background:var(--light)}
.pill{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;border:1px solid;transition:all .3s cubic-bezier(.4,0,.2,1);font-family:var(--mono)}
.sname{flex:1;font-size:12px;line-height:1.3;color:var(--text)}
.sinput{width:44px;background:var(--light);border:1px solid var(--border);border-radius:7px;font-family:var(--mono);font-size:13px;font-weight:700;text-align:center;padding:5px;color:var(--text);outline:none;transition:border-color .15s,box-shadow .15s,background .15s}
.sinput:focus{border-color:var(--accent);background:var(--surface2);box-shadow:0 0 0 2px rgba(255,107,0,.15)}
.sinput::placeholder{color:var(--muted);font-weight:400}

/* ── NOTES BUTTON ── */
.note-btn{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);background:var(--light);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;color:var(--muted)}
.note-btn:hover{border-color:var(--accent);background:var(--bluebg);color:var(--accent)}
.note-btn.has-note{background:var(--bluebg);border-color:var(--accent);color:var(--accent)}

/* ── NOTES MODAL ── */
#noteModal{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);padding:16px}
#noteModal.on{display:flex;animation:mfade .18s ease}
.note-modal-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 24px 80px rgba(0,0,0,.6);padding:20px;width:min(580px,96vw);display:flex;flex-direction:column;gap:10px}
.note-modal-title{font-size:13px;font-weight:700;color:var(--text);line-height:1.4}
.note-toolbar{display:flex;align-items:center;gap:3px;padding:6px 8px;background:var(--light);border:1px solid var(--border);border-radius:8px 8px 0 0;flex-wrap:wrap}
.ntb{min-width:28px;height:28px;padding:0 6px;border-radius:5px;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;color:var(--muted);cursor:pointer;transition:all .12s;display:flex;align-items:center;justify-content:center}
.ntb:hover{background:var(--border);color:var(--text)}
.ntb.on{background:var(--accent);color:#fff}
.ntb-sep{width:1px;height:18px;background:var(--border);margin:0 2px;flex-shrink:0}
.note-editor{width:100%;min-height:180px;max-height:50vh;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:13px;line-height:1.6;color:var(--text);outline:none;transition:border-color .15s;word-break:break-word;background:var(--surface2)}
.note-editor:focus{border-color:var(--accent)}
.note-editor:empty::before{content:attr(data-placeholder);color:var(--muted);pointer-events:none}
.note-editor h2{font-size:17px;font-weight:700;margin:4px 0 2px}
.note-editor h3{font-size:14px;font-weight:600;margin:3px 0 1px}
.note-editor img{max-width:100%;border-radius:8px;margin:6px 0;display:block;border:1px solid var(--border)}
.note-editor ul,.note-editor ol{padding-left:20px;margin:4px 0}
.note-modal-foot{display:flex;gap:8px;justify-content:flex-end}
.note-save-btn{padding:8px 18px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.note-save-btn:hover{background:var(--accent2)}
.note-clear-btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--light);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.note-clear-btn:hover{border-color:var(--red);color:var(--red);background:var(--redbg)}

/* ── INLINE PROGRESS ── */
.hprog-inline{display:flex;align-items:center;gap:6px;margin-top:4px}
.hprog-inline-track{width:70px;height:3px;background:var(--light);border-radius:3px;overflow:hidden;flex-shrink:0}
.hprog-fill{height:100%;border-radius:3px;transition:width .6s cubic-bezier(.4,0,.2,1),background .4s}
.hprog-inline-pct{font-size:10px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1;font-family:var(--mono)}
.hprog-inline-detail{font-size:10px;color:var(--muted);line-height:1;font-family:var(--mono)}

/* sparkbars */
.spkwrap{padding:10px 16px 14px;border-top:1px solid var(--border);background:var(--surface2)}
.spklbl{font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px}
.sparks{display:flex;align-items:flex-end;gap:3px;height:34px}
.spk{flex:1;border-radius:2px 2px 0 0;min-height:2px;transition:height .5s cubic-bezier(.34,1.56,.64,1);cursor:pointer;position:relative}
.spk:hover::after{content:attr(data-t);position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:5px;padding:3px 8px;font-size:9px;white-space:nowrap;pointer-events:none;z-index:10}

/* ── QUESTION BANK ── */
.qbank{border-top:1px solid var(--border);background:var(--surface2)}
.qbank-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;cursor:pointer;user-select:none}
.qbank-title{font-size:11px;font-weight:700;color:var(--accent);display:flex;align-items:center;gap:6px;text-transform:uppercase;letter-spacing:.5px}
.qbank-badge{background:var(--accent);color:#fff;border-radius:100px;padding:1px 7px;font-size:10px;font-weight:700;font-family:var(--mono)}
.qbank-body{display:none;padding:0 16px 14px}
.qbank-body.open{display:block}
.qbank-chev{font-size:10px;color:var(--muted);transition:transform .2s}

/* add question button */
.add-q-btn{width:100%;padding:10px;border:1px dashed var(--border);border-radius:10px;background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:6px}
.add-q-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--bluebg)}

/* sort */
.sort-bar{display:flex;align-items:center;gap:6px;margin-bottom:8px}
.sort-lbl{font-size:10px;color:var(--muted)}
.sort-btn{padding:3px 10px;border-radius:100px;border:1px solid var(--border);background:var(--surface);font-size:10px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .15s}
.sort-btn.on{background:var(--accent);border-color:var(--accent);color:#fff}

/* question cards */
.qcards{display:flex;flex-direction:column;gap:8px}
.qcard{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .2s}
.qcard:hover{border-color:rgba(255,107,0,.3)}
.qcard-row{display:flex;gap:10px;padding:10px 12px;align-items:center}
.qthumb{width:58px;height:46px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid var(--border);flex-shrink:0;transition:transform .15s,border-color .15s}
.qthumb:hover{transform:scale(1.05);border-color:var(--accent)}
.qthumb.no-ans{opacity:.4;border-style:dashed}
.qcard-info{flex:1;min-width:0}
.qcard-name{font-size:11px;font-weight:600;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--muted);font-family:var(--mono)}
.qcard-diff{font-size:10px;color:var(--muted);margin-bottom:5px}
.qstar-row{display:flex;flex-wrap:wrap;gap:2px}
.qstar{width:22px;height:22px;border-radius:4px;border:1px solid var(--border);background:var(--light);font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;color:var(--muted);flex-shrink:0;font-family:var(--mono)}
.qstar.on{border-color:currentColor}
.qcard-actions{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.qcard-del{background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;padding:3px 6px;border-radius:5px;transition:all .15s}
.qcard-del:hover{color:var(--red);background:var(--redbg)}
.attempt-btn{background:var(--bluebg);border:1px solid rgba(255,107,0,.25);border-radius:7px;color:var(--accent);font-size:10px;font-weight:600;padding:4px 9px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;white-space:nowrap}
.attempt-btn:hover{background:rgba(255,107,0,.15)}

/* ring */
svg.ring{overflow:visible;flex-shrink:0}
.ring-bg{fill:none;stroke:var(--light);stroke-width:4}
.ring-fg{fill:none;stroke-linecap:round;transition:stroke-dasharray .7s cubic-bezier(.4,0,.2,1),stroke .4s}
.ring-txt{font-family:var(--mono);font-weight:700}
/* legend */
.legend{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:22px;padding-top:18px;border-top:1px solid var(--border)}
.litem{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted)}
.ldot{width:8px;height:8px;border-radius:2px}

/* number animate */
@keyframes numPop{0%{transform:scale(.88);opacity:.5}60%{transform:scale(1.06)}100%{transform:scale(1);opacity:1}}
.npop{animation:numPop .3s cubic-bezier(.4,0,.2,1)}

/* MODALS shared */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);padding:16px}
.modal-bg.on{display:flex;animation:mfade .2s ease}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 24px 80px rgba(0,0,0,.6);display:flex;flex-direction:column;max-height:90vh;overflow:hidden}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-title{font-size:14px;font-weight:700;letter-spacing:-.2px;color:var(--text)}
.modal-close{width:28px;height:28px;border-radius:7px;background:var(--light);border:1px solid var(--border);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--muted);transition:all .15s}
.modal-close:hover{border-color:var(--red);color:var(--red)}
.modal-body{padding:18px 20px;overflow-y:auto;flex:1}
.modal-foot{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-shrink:0}
.btn{padding:8px 18px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-primary:disabled{background:rgba(255,107,0,.3);cursor:not-allowed;color:rgba(255,255,255,.5)}
.btn-ghost{background:var(--light);color:var(--muted);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--border);color:var(--text)}

/* ADD QUESTION MODAL */
#addQModal .modal{width:min(600px,94vw)}
.aq-upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.aq-zone{border:1px dashed var(--border);border-radius:12px;padding:20px 12px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;min-height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;background:var(--surface2)}
.aq-zone:hover{border-color:var(--accent);background:var(--bluebg)}
.aq-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.aq-zone.has-img{border-style:solid;border-color:var(--green);background:rgba(34,197,94,.08)}
.aq-zone img{width:100%;max-height:120px;object-fit:contain;border-radius:8px;margin-top:4px}
.aq-zone-icon{font-size:22px}
.aq-zone-label{font-size:11px;font-weight:700;color:var(--text)}
.aq-zone-sub{font-size:10px;color:var(--muted)}
.aq-diff-section{margin-bottom:4px}
.aq-diff-label{font-size:11px;font-weight:600;margin-bottom:8px;color:var(--text)}
.aq-diff-sub{font-size:10px;color:var(--muted);margin-bottom:10px}
.aq-stars{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.aqstar{padding:8px 4px;border-radius:8px;border:1px solid var(--border);background:var(--light);font-size:12px;font-weight:700;text-align:center;cursor:pointer;transition:all .15s;color:var(--muted);font-family:var(--mono)}
.aqstar:hover{border-color:var(--accent);color:var(--accent);background:var(--bluebg)}
.aqstar.on{color:#fff;border-color:currentColor}

/* ATTEMPT MODAL */
#attModal .modal{width:min(520px,94vw)}
.att-new-section{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px}
.att-new-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:12px}
.att-score-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.att-score-label{font-size:12px;color:var(--text);font-weight:500;flex-shrink:0}
.att-score-in{width:70px;padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-family:var(--mono);font-size:16px;font-weight:700;text-align:center;outline:none;transition:border-color .15s;background:var(--surface2);color:var(--text)}
.att-score-in:focus{border-color:var(--accent)}
.att-out-label{font-size:12px;color:var(--muted)}
.att-out-in{width:70px;padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-family:var(--mono);font-size:16px;font-weight:700;text-align:center;outline:none;transition:border-color .15s;background:var(--surface2);color:var(--text)}
.att-out-in:focus{border-color:var(--accent)}
.att-note-in{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:12px;outline:none;resize:none;transition:border-color .15s;background:var(--surface2);color:var(--text)}
.att-note-in:focus{border-color:var(--accent)}
.att-submit-btn{width:100%;padding:10px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:background .15s}
.att-submit-btn:hover{background:var(--accent2)}
.att-history-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:10px}
.att-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.att-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;display:flex;align-items:center;gap:10px}
.att-item-score{font-size:14px;font-weight:800;font-variant-numeric:tabular-nums;flex-shrink:0;font-family:var(--mono)}
.att-item-info{flex:1;min-width:0}
.att-item-date{font-size:10px;color:var(--muted);font-family:var(--mono)}
.att-item-note{font-size:11px;color:var(--text);margin-top:2px}
.att-empty{font-size:12px;color:var(--muted);text-align:center;padding:16px}

/* VIEWER MODAL */
#viewerModal .modal{width:min(900px,96vw);max-height:92vh}
.viewer-nav{display:flex;align-items:center;gap:10px;padding:10px 20px;border-bottom:1px solid var(--border);background:var(--surface2);flex-shrink:0}
.viewer-counter{font-size:12px;font-weight:700;color:var(--text);flex:1;text-align:center;font-family:var(--mono)}
.viewer-arrow{width:30px;height:30px;border-radius:7px;border:1px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .15s;flex-shrink:0;color:var(--muted)}
.viewer-arrow:hover{background:var(--accent);border-color:var(--accent);color:#fff}
.viewer-arrow:disabled{opacity:.25;cursor:not-allowed;pointer-events:none}
.viewer-body{display:grid;grid-template-columns:1fr 1fr;gap:0;overflow-y:auto;flex:1;will-change:opacity,transform;transition:opacity .22s cubic-bezier(.2,.8,.2,1), transform .22s cubic-bezier(.2,.8,.2,1)}
@media(max-width:600px){.viewer-body{grid-template-columns:1fr}}
.viewer-sec{padding:18px}
.viewer-sec+.viewer-sec{border-left:1px solid var(--border)}
@media(max-width:600px){.viewer-sec+.viewer-sec{border-left:none;border-top:1px solid var(--border)}}
.viewer-sec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.viewer-img{width:100%;border-radius:8px;display:block;border:1px solid var(--border)}
.ans-overlay{position:relative;border-radius:8px;overflow:hidden}
.ans-overlay .viewer-img{display:block}
.ans-cover{position:absolute;inset:0;background:rgba(5,5,10,.7);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity .38s cubic-bezier(.4,0,.2,1)}
.ans-cover.gone{opacity:0;pointer-events:none}
.ans-cover-inner{text-align:center;color:#fff;pointer-events:none}
.ans-cover-icon{font-size:30px;margin-bottom:6px}
.ans-cover-txt{font-size:13px;font-weight:700}
.ans-cover-sub{font-size:10px;opacity:.5;margin-top:3px}
.ans-reveal-btn{margin-top:12px;width:100%;padding:10px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.ans-reveal-btn:hover{background:var(--accent2)}
.ans-reveal-btn.hide{background:var(--light);color:var(--muted);border:1px solid var(--border)}
.ans-reveal-btn.hide:hover{background:var(--border)}
.viewer-no-ans{border:1px dashed var(--border);border-radius:8px;padding:40px 16px;text-align:center;color:var(--muted);font-size:12px}
.viewer-timer{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;border-top:1px solid var(--border);background:var(--surface2);flex-shrink:0}
.vt-lbl{font-size:10px;color:var(--muted);font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.vt-time{font-size:18px;font-weight:700;letter-spacing:2px;font-variant-numeric:tabular-nums;min-width:72px;text-align:center;transition:color .2s;font-family:var(--mono)}
.vt-time.run{color:var(--accent)}
.vtb{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);cursor:pointer;font-size:13px;transition:all .15s;display:flex;align-items:center;justify-content:center;background:var(--surface);color:var(--muted)}
.vtb:hover{border-color:var(--accent);color:var(--accent)}

/* VIEWER ATTEMPTS DRAWER */
.viewer-att-btn{margin-left:10px;height:30px;padding:0 12px;border-radius:7px;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);display:flex;align-items:center;gap:7px;transition:all .15s}
.viewer-att-btn:hover{border-color:var(--accent);color:var(--accent)}
.viewer-att-badge{min-width:18px;height:16px;padding:0 6px;border-radius:999px;background:var(--light);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:var(--muted);font-family:var(--mono)}
.vatt{position:absolute;top:52px;right:0;width:min(360px,92vw);height:calc(92vh - 52px - 50px);background:var(--surface);backdrop-filter:blur(18px);border-left:1px solid var(--border);box-shadow:-10px 0 40px rgba(0,0,0,.4);transform:translateX(102%);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.2,1), opacity .22s;display:flex;flex-direction:column;z-index:6}
.modal{position:relative}
.vatt.on{transform:translateX(0);opacity:1}
.vatt-h{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
.vatt-title{font-size:12px;font-weight:800;color:var(--text)}
.vatt-sub{font-size:10px;color:var(--muted);margin-top:2px;font-family:var(--mono)}
.vatt-x{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--light);cursor:pointer;color:var(--muted)}
.vatt-x:hover{border-color:var(--red);color:var(--red)}
.vatt-b{padding:12px 14px;overflow:auto;flex:1}
.vatt-form{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px}
.vatt-row{display:flex;gap:8px}
.vatt-in{flex:1;min-width:0;border:1px solid var(--border);border-radius:8px;padding:9px 10px;font-family:var(--mono);font-size:13px;background:var(--surface);color:var(--text)}
.vatt-in:focus{border-color:var(--accent);outline:none}
.vatt-note{width:100%;margin-top:8px;border:1px solid var(--border);border-radius:8px;padding:9px 10px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--surface);resize:vertical;color:var(--text)}
.vatt-note:focus{border-color:var(--accent);outline:none}
.vatt-submit{margin-top:10px;width:100%;padding:10px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer}
.vatt-submit:hover{background:var(--accent2)}
.vatt-list-title{margin-top:12px;font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.vatt-list{margin-top:8px}

/* ADD QUESTION: ANSWER TYPE */
.aq-ans-type{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.aq-ans-pill{display:flex;gap:6px;background:var(--light);border:1px solid var(--border);border-radius:999px;padding:3px;width:max-content}
.aq-pill{border:none;background:transparent;padding:6px 12px;border-radius:999px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;color:var(--muted);cursor:pointer;transition:all .15s}
.aq-pill.on{background:var(--surface);color:var(--accent);border:1px solid rgba(255,107,0,.3)}
.aq-vid{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--surface2);color:var(--text)}
.aq-vid-hint{font-size:11px;color:var(--muted)}

/* viewer image cards */
.viewer-img-card{position:relative;border-radius:8px;overflow:hidden;cursor:pointer;border:1px solid var(--border);transition:border-color .2s,transform .15s}
.viewer-img-card:hover{border-color:rgba(255,107,0,.4);transform:translateY(-1px)}
.viewer-img-card .viewer-img{display:block;width:100%;border-radius:0;border:none}
.viewer-img-hint{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);color:#fff;font-size:10px;font-weight:600;padding:7px 10px;opacity:0;transition:opacity .18s;pointer-events:none}
.viewer-img-card:hover .viewer-img-hint{opacity:1}
.ans-card .ans-overlay{border-radius:0}

/* FULLSCREEN PHOTO VIEWER */
#photoViewer{position:fixed;inset:0;z-index:2000;background:#0a0a0f;display:none;flex-direction:column;animation:pvIn .22s cubic-bezier(.2,.8,.2,1)}
#photoViewer.on{display:flex}
@keyframes pvIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
.pv-bar{display:flex;align-items:center;gap:12px;padding:14px 20px;background:rgba(10,10,15,.85);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.08);flex-shrink:0;z-index:5}
.pv-title{flex:1;font-size:13px;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:-.2px}
.pv-subtitle{font-size:11px;color:rgba(255,255,255,.4);margin-top:1px}
.pv-pill-wrap{display:flex;background:rgba(255,255,255,.1);border-radius:8px;padding:3px;gap:2px}
.pv-pill{padding:5px 14px;border-radius:6px;border:none;background:transparent;color:rgba(255,255,255,.5);font-family:'Inter',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.pv-pill.on{background:rgba(255,255,255,.18);color:#fff}
.pv-close{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.pv-close:hover{background:rgba(255,255,255,.18);color:#fff;border-color:rgba(255,255,255,.3)}
.pv-canvas{flex:1;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
.pv-img{max-width:none;max-height:none;display:block;transform-origin:center center;cursor:grab;user-select:none;-webkit-user-drag:none;transition:none;border-radius:4px}
.pv-img.grabbing{cursor:grabbing}
.pv-ans-cover{position:absolute;inset:0;background:rgba(8,8,20,.7);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity .38s cubic-bezier(.4,0,.2,1);z-index:4}
.pv-ans-cover.gone{opacity:0;pointer-events:none}
.pv-ans-cover-inner{text-align:center;color:#fff;pointer-events:none}
.pv-ans-icon{font-size:36px;margin-bottom:10px}
.pv-ans-txt{font-size:15px;font-weight:700;margin-bottom:4px}
.pv-ans-sub{font-size:12px;opacity:.5}
.pv-bottom{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 20px;background:rgba(10,10,15,.85);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.08);flex-shrink:0}
.pv-zoom-btns{display:flex;align-items:center;gap:6px}
.pvb{width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.07);color:rgba(255,255,255,.7);font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.pvb:hover{background:rgba(255,255,255,.15);color:#fff}
.pv-zoom-lbl{font-size:12px;font-weight:700;color:rgba(255,255,255,.5);min-width:42px;text-align:center;font-variant-numeric:tabular-nums}
.pv-reveal-btn{padding:9px 20px;border-radius:10px;border:none;background:var(--blue);color:#fff;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.pv-reveal-btn:hover{background:#0066dd}
.pv-reveal-btn.hide{background:rgba(255,255,255,.1);color:rgba(255,255,255,.6)}
.pv-reveal-btn.hide:hover{background:rgba(255,255,255,.15)}
.pv-hint{font-size:10px;color:rgba(255,255,255,.25);text-align:center}

/* ══════════════════════════════════════════════════════
   EXAM TRACKER
═══════════════════════════════════════════════════════ */
#examPage{display:none;max-width:1160px;margin:0 auto;padding:22px 28px 80px}
#examPage.on{display:block}
.exam-nav{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.exam-ntab{padding:6px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .2s}
.exam-ntab.on{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.exam-ntab:hover:not(.on){border-color:rgba(255,107,0,.4);color:var(--text)}
.exam-section{display:none}.exam-section.on{display:block}
.exam-form-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.exam-form-title{font-size:11px;font-weight:700;margin-bottom:16px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted)}
.exam-form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:flex-end}
.exam-field{display:flex;flex-direction:column;gap:4px;flex:1;min-width:140px}
.exam-field label{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.exam-input{padding:8px 11px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);background:var(--surface2);outline:none;transition:border-color .15s}
.exam-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,107,0,.12)}
.exam-select{padding:8px 11px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);background:var(--surface2);outline:none;cursor:pointer}
.qgrid-wrap{overflow-x:auto;margin-top:16px}
.qgrid{border-collapse:collapse;width:100%;min-width:500px;font-size:12px}
.qgrid th{background:var(--surface2);padding:7px 10px;text-align:left;font-weight:600;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap;text-transform:uppercase;letter-spacing:.3px;font-size:10px}
.qgrid td{padding:5px 6px;border-bottom:1px solid var(--border);vertical-align:middle}
.qgrid tr:hover td{background:var(--light)}
.qgrid-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:5px;transition:all .15s}
.qgrid-del:hover{color:var(--red);background:var(--redbg)}
.qi-sm{width:52px;padding:5px 7px;border:1px solid var(--border);border-radius:6px;font-family:var(--mono);font-size:12px;text-align:center;color:var(--text);outline:none;background:var(--surface2)}
.qi-sm:focus{border-color:var(--accent)}
.qgrid-add-row td{padding:6px}
.add-qrow-btn{padding:5px 14px;border-radius:7px;border:1px dashed var(--border);background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--muted);cursor:pointer;transition:all .15s}
.add-qrow-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--bluebg)}
.exam-save-btn{padding:9px 22px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;margin-top:14px}
.exam-save-btn:hover{background:var(--accent2)}

/* ── Exam entry layout helpers ── */
.ef-score-row{display:flex;align-items:center;gap:8px}
.ef-score-in{width:90px !important;flex:none !important}
.ef-score-sep{font-size:11px;color:var(--muted);font-weight:600;flex-shrink:0}

/* Mobile question rows */
.mob-qrows{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
.mob-qrow{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
.mob-qrow-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.mob-qrow-num{font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.4px}
.mob-qrow-del{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:2px 6px;border-radius:6px;line-height:1}
.mob-qrow-del:active{color:var(--red)}
.mob-qrow-fields{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.mob-qrow-full{grid-column:1/-1}
.mob-qrow-field{display:flex;flex-direction:column;gap:4px}
.mob-qrow-field label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
.mob-qrow-in{padding:9px 10px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:16px;color:var(--text);background:var(--surface);outline:none;width:100%;-webkit-appearance:none;transition:border-color .15s}
.mob-qrow-in:focus{border-color:var(--accent)}
.mob-qrow-sel{padding:9px 10px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--text);background:var(--surface);outline:none;width:100%}
.mob-add-qrow{width:100%;padding:12px;border:1.5px dashed var(--border);border-radius:12px;background:transparent;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;color:var(--muted);cursor:pointer;margin-bottom:12px;transition:all .2s;-webkit-tap-highlight-color:transparent}
.mob-add-qrow:active{border-color:var(--accent);color:var(--accent)}

@media(max-width:720px){
  .ef-row-2col{display:grid !important;grid-template-columns:1fr 1fr;gap:8px;flex-wrap:unset}
  .ef-row-2col .exam-field{min-width:0 !important;flex:unset !important}
  .eff-full .exam-input{width:100% !important}
  .ef-score-in{width:unset !important;flex:1 !important;min-width:0}
  .exam-input,.exam-select{min-height:48px;font-size:16px !important;border-radius:12px}
  .exam-form-title{font-size:11px}
  .mob-add-qrow{display:block !important}
  #mobQRows{display:flex !important}
  .exam-form-card{padding:14px}
  .exam-save-btn{width:100%;min-height:52px;font-size:16px;border-radius:14px;margin-top:14px}
  .exam-nav{gap:4px}
  .exam-ntab{flex:1;text-align:center;padding:9px 6px;font-size:11px;border-radius:9px}
}
.exam-save-btn:hover{background:var(--accent2)}
.exams-list{display:flex;flex-direction:column;gap:8px}
.exam-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .2s}
.exam-card:hover{border-color:rgba(255,107,0,.3)}
.exam-card-hdr{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;user-select:none}
.exam-card-hdr:hover{background:var(--light)}
.exam-badge{padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;flex-shrink:0;font-family:var(--mono)}
.exam-card-name{font-size:13px;font-weight:600;flex:1;color:var(--text)}
.exam-card-raw{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1.1;font-family:var(--mono)}
.exam-card-pct{font-size:11px;font-weight:700;font-variant-numeric:tabular-nums;opacity:.6;line-height:1.1;margin-left:auto;flex-shrink:0;font-family:var(--mono)}
.exam-card-detail{font-size:10px;color:var(--muted);margin-top:1px;font-family:var(--mono)}
.exam-card-body{display:none;border-top:1px solid var(--border)}
.exam-card-body.open{display:block}
.exam-card-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:4px 8px;border-radius:6px;transition:all .15s}
.exam-card-del:hover{color:var(--red);background:var(--redbg)}
.prac-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.prac-filter-lbl{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.pfilter{padding:5px 12px;border-radius:7px;border:1px solid var(--border);background:var(--surface);font-family:'DM Sans',sans-serif;font-size:12px;color:var(--muted);cursor:pointer;transition:all .15s}
.pfilter.on{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.prac-list{display:flex;flex-direction:column;gap:6px}
.prac-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:14px;transition:border-color .2s}
.prac-item:hover{border-color:rgba(255,107,0,.3)}
.prac-rank{width:26px;height:26px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;flex-shrink:0;border:1px solid;font-family:var(--mono)}
.prac-info{flex:1;min-width:0}
.prac-qname{font-size:13px;font-weight:600;color:var(--text)}
.prac-qsub{font-size:11px;color:var(--muted);margin-top:2px;font-family:var(--mono)}
.prac-score{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums;flex-shrink:0;font-family:var(--mono)}
.prac-attempts{font-size:10px;color:var(--muted);text-align:right;font-family:var(--mono)}
.prac-log-btn{padding:6px 12px;border-radius:7px;border:1px solid var(--border);background:var(--light);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .15s;flex-shrink:0}
.prac-log-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--bluebg)}
#examLogModal{position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);padding:16px}
#examLogModal.on{display:flex}
.elm-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 24px 80px rgba(0,0,0,.6);padding:22px;width:min(380px,94vw);display:flex;flex-direction:column;gap:12px}
.elm-title{font-size:13px;font-weight:700;color:var(--text)}
.elm-row{display:flex;gap:10px;align-items:flex-end}
.elm-field{display:flex;flex-direction:column;gap:4px;flex:1}
.elm-field label{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
.elm-input{padding:8px 11px;border:1px solid var(--border);border-radius:8px;font-family:var(--mono);font-size:14px;font-weight:700;text-align:center;color:var(--text);outline:none;transition:border-color .15s;background:var(--surface2)}
.elm-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,107,0,.12)}
.elm-hist{border-top:1px solid var(--border);padding-top:10px}
.elm-hist-title{font-size:10px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.3px}
.elm-hist-row{display:flex;justify-content:space-between;font-size:12px;padding:3px 0;border-bottom:1px solid var(--border);font-family:var(--mono)}
.elm-btns{display:flex;gap:8px;justify-content:flex-end}
.elm-cancel{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--light);color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer}
.elm-save{padding:8px 18px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer}
.elm-save:hover{background:var(--accent2)}
@media (max-width: 520px){
  .exam-input,.exam-select,.qi-sm,.elm-input,.pfilter,.prac-log-btn,.btn{font-size:16px}
  .exam-input,.exam-select,.qi-sm,.elm-input{min-height:44px}
  .prac-item{padding:12px 14px}
  .prac-qname{font-size:14px}
  .prac-qsub{font-size:12px}
  .qgrid-wrap{overflow-x:visible}
  .qgrid{min-width:0;width:100%}
  .qgrid thead{display:none}
  .qgrid tr{display:block;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:10px}
  .qgrid td{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)}
  .qgrid td:last-child{border-bottom:none;justify-content:flex-end}
  .qgrid td::before{content:attr(data-label);font-size:12px;font-weight:700;color:var(--muted);flex:0 0 auto}
  .qgrid td:last-child::before{content:''}
  .qgrid td input.qi-sm,.qgrid td select.qi-sm{width:140px !important;max-width:55vw;text-align:center}
  .qgrid-del{font-size:18px;padding:8px 10px}
}

/* ── AI TUTOR ─────────────────────── */
.ai-btn{position:fixed;bottom:24px;right:24px;z-index:400;width:52px;height:52px;border-radius:14px;border:none;background:var(--accent);color:#fff;font-size:22px;cursor:pointer;box-shadow:0 4px 20px rgba(255,107,0,.4);transition:all .2s;display:flex;align-items:center;justify-content:center}
.ai-btn:hover{transform:scale(1.08);box-shadow:0 6px 28px rgba(255,107,0,.55)}
.ai-btn.open{border-radius:12px;background:var(--surface2);border:1px solid var(--border);box-shadow:none}
#aiPanel{position:fixed;bottom:88px;right:24px;z-index:399;width:min(380px,calc(100vw - 32px));background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;transform:translateY(12px) scale(.97);opacity:0;pointer-events:none;transition:transform .22s cubic-bezier(.2,.9,.2,1),opacity .22s cubic-bezier(.2,.9,.2,1);max-height:min(520px,70vh);min-width:280px;min-height:200px}
#aiPanel.on{transform:none;opacity:1;pointer-events:auto}
#aiPanel.resizing{transition:none;user-select:none}
.ai-resize-handle{position:absolute;top:0;left:0;width:16px;height:16px;cursor:nw-resize;z-index:10;border-radius:16px 0 0 0}
.ai-resize-handle::before{content:'';position:absolute;top:5px;left:5px;width:6px;height:6px;border-top:2px solid var(--muted);border-left:2px solid var(--muted);border-radius:1px;opacity:.5}
.ai-head{padding:14px 16px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.ai-head-icon{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#c94000);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.ai-head-title{font-size:13px;font-weight:700;color:var(--text)}
.ai-head-sub{font-size:10px;color:var(--muted);margin-top:1px}
.ai-msgs{flex:1;overflow-y:auto;padding:14px 14px 8px;display:flex;flex-direction:column;gap:10px;min-height:0}
.ai-msg{display:flex;gap:8px;align-items:flex-start}
.ai-msg.user{flex-direction:row-reverse}
.ai-bubble{padding:9px 12px;border-radius:12px;font-size:12px;line-height:1.6;max-width:85%;color:var(--text)}
.ai-msg.ai .ai-bubble{background:var(--surface2);border:1px solid var(--border);border-radius:12px 12px 12px 3px}
.ai-msg.user .ai-bubble{background:var(--accent);color:#fff;border-radius:12px 12px 3px 12px}
.ai-avatar{width:22px;height:22px;border-radius:6px;background:linear-gradient(135deg,var(--accent),#c94000);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;margin-top:2px}
.ai-msg.user .ai-avatar{background:var(--light);border:1px solid var(--border)}
.ai-input-row{padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0}
.ai-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 12px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text);outline:none;resize:none;min-height:36px;max-height:100px;transition:border-color .15s}
.ai-input:focus{border-color:var(--accent)}
.ai-send{width:34px;height:34px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;transition:all .15s;align-self:flex-end}
.ai-send:hover{background:var(--accent2)}
.ai-send:disabled{background:var(--light);color:var(--muted);cursor:not-allowed}
.ai-chips{display:flex;gap:6px;flex-wrap:wrap;padding:0 12px 10px;flex-shrink:0}
.ai-chip{padding:4px 10px;border-radius:20px;border:1px solid var(--border);background:transparent;font-family:'DM Sans',sans-serif;font-size:11px;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap}
.ai-chip:hover{border-color:var(--accent);color:var(--accent);background:var(--bluebg)}
.ai-typing{display:flex;gap:4px;align-items:center;padding:2px 0}
.ai-typing span{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:aiDot 1.2s ease-in-out infinite}
.ai-typing span:nth-child(2){animation-delay:.2s}
.ai-typing span:nth-child(3){animation-delay:.4s}
@keyframes aiDot{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
.ai-empty{text-align:center;padding:20px 16px;color:var(--muted);font-size:12px;line-height:1.6}
.ai-empty-icon{font-size:28px;margin-bottom:8px}

/* ── API KEY SETUP MODAL ── */
.api-setup-modal{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:600;display:none;align-items:center;justify-content:center;padding:20px}
.api-setup-modal.on{display:flex}
.api-setup{background:var(--surface);border:1px solid var(--border);border-radius:18px;max-width:520px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.api-setup-head{padding:20px 24px;border-bottom:1px solid var(--border)}
.api-setup-title{font-size:17px;font-weight:700;margin-bottom:4px}
.api-setup-sub{font-size:12px;color:var(--muted)}
.api-setup-body{padding:24px}
.api-provider-choice{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.api-provider-btn{padding:18px 14px;border:2px solid var(--border);border-radius:12px;background:var(--light);cursor:pointer;transition:all .2s;text-align:center}
.api-provider-btn:hover{border-color:var(--accent);transform:translateY(-2px)}
.api-provider-btn.selected{border-color:var(--accent);background:rgba(255,107,0,.08);box-shadow:0 0 0 3px rgba(255,107,0,.15)}
.api-provider-icon{font-size:36px;margin-bottom:10px}
.api-provider-name{font-size:14px;font-weight:700;margin-bottom:4px;color:var(--text)}
.api-provider-desc{font-size:11px;color:var(--muted);line-height:1.4}
.api-key-input-group{margin-bottom:20px}
.api-key-label{font-size:12px;font-weight:700;margin-bottom:8px;display:block;color:var(--text)}
.api-key-input{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;background:var(--surface2);font-family:var(--mono);font-size:11px;color:var(--text);transition:border-color .2s}
.api-key-input:focus{outline:none;border-color:var(--accent);background:var(--light)}
.api-key-input::placeholder{color:var(--muted)}
.api-key-hint{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
.api-key-hint a{color:var(--accent);text-decoration:none}
.api-key-hint a:hover{text-decoration:underline}
.api-setup-actions{display:flex;gap:10px}
.api-setup-btn{flex:1;padding:13px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.api-setup-btn.primary{background:var(--accent);color:#fff}
.api-setup-btn.primary:hover:not(:disabled){background:var(--accent2);transform:scale(1.02)}
.api-setup-btn.primary:disabled{opacity:.4;cursor:not-allowed}
.api-setup-btn.secondary{background:var(--light);color:var(--text);border:1px solid var(--border)}
.api-setup-btn.secondary:hover{background:var(--border)}

/* ── CHAT SESSION SAVE MODAL ── */
.chat-save-modal{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:600;display:none;align-items:center;justify-content:center;padding:20px}
.chat-save-modal.on{display:flex}
.chat-save{background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:420px;width:100%;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.chat-save-title{font-size:16px;font-weight:700;margin-bottom:8px}
.chat-save-desc{font-size:12px;color:var(--muted);margin-bottom:20px;line-height:1.5}
.chat-save-name-group{margin-bottom:20px}
.chat-save-name-label{font-size:12px;font-weight:700;margin-bottom:8px;display:block}
.chat-save-name-input{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;background:var(--surface2);font-size:13px;color:var(--text)}
.chat-save-name-input:focus{outline:none;border-color:var(--accent);background:var(--light)}
.chat-save-actions{display:flex;gap:10px}
.chat-save-btn{flex:1;padding:12px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.chat-save-btn.save{background:var(--accent);color:#fff}
.chat-save-btn.save:hover{background:var(--accent2);transform:scale(1.02)}
.chat-save-btn.discard{background:var(--light);color:var(--muted);border:1px solid var(--border)}
.chat-save-btn.discard:hover{background:var(--border);color:var(--text)}
.chat-save-btn.cancel{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.chat-save-btn.cancel:hover{background:var(--light)}

/* ── SAVED CHATS LIST ── */
.saved-chats-modal{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:600;display:none;align-items:center;justify-content:center;padding:20px}
.saved-chats-modal.on{display:flex}
.saved-chats{background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:520px;width:100%;max-height:70vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.saved-chats-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.saved-chats-title{font-size:16px;font-weight:700}
.saved-chats-close{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--light);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
.saved-chats-close:hover{background:var(--border)}
.saved-chats-body{flex:1;overflow-y:auto;padding:12px}
.saved-chat-item{background:var(--light);border:1px solid var(--border);border-radius:10px;padding:13px 15px;margin-bottom:10px;transition:all .15s}
.saved-chat-item:hover{border-color:var(--accent);background:var(--surface2);transform:translateX(2px)}
.saved-chat-name{font-size:13px;font-weight:700;margin-bottom:6px;color:var(--text)}
.saved-chat-meta{font-size:11px;color:var(--muted);margin-bottom:10px}
.saved-chat-preview{font-size:11px;color:var(--muted);margin-bottom:10px;line-height:1.4;max-height:36px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.saved-chat-actions{display:flex;gap:8px}
.saved-chat-action{padding:5px 11px;border:1px solid var(--border);border-radius:7px;background:var(--surface);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.saved-chat-action:hover{background:var(--light);transform:scale(1.02)}
.saved-chat-action.delete{color:var(--red);border-color:rgba(255,68,68,.3)}
.saved-chat-action.delete:hover{background:rgba(255,68,68,.1)}
.saved-chats-empty{padding:60px 20px;text-align:center;color:var(--muted);font-size:12px}
.saved-chats-empty-icon{font-size:48px;margin-bottom:12px;opacity:.4}
.ai-head-btns{display:flex;gap:6px;margin-left:auto}
.ai-hbtn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--light);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s;color:var(--muted)}
.ai-hbtn:hover{background:var(--border);color:var(--text);transform:scale(1.05)}
.ai-hbtn.settings{font-size:13px}

/* ═══ MOBILE HAMBURGER MENU ════════════════════════════════ */
.mob-menu-btn{display:none;width:38px;height:38px;border-radius:10px;background:var(--surface);border:1px solid var(--border);cursor:pointer;align-items:center;justify-content:center;flex-shrink:0;flex-direction:column;gap:5px;transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);-webkit-tap-highlight-color:transparent;padding:0}
.mob-menu-btn span{display:block;width:16px;height:1.5px;background:var(--muted);border-radius:2px;transition:all .35s cubic-bezier(0.4, 0, 0.2, 1)}
.mob-menu-btn:active{background:var(--light)}
.mob-menu-btn.open span:nth-child(1){transform:rotate(45deg) translateY(5px) translateX(5px)}
.mob-menu-btn.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.mob-menu-btn.open span:nth-child(3){transform:rotate(-45deg) translateY(-5px) translateX(5px)}
@media(max-width:720px){
  .mob-menu-btn{display:flex}
  .hright .design-toggle,.hright label.design-toggle,.hright .stopwatch,.switch-profile-btn{display:none !important}
  .hright .syncpill{display:flex !important}
  .hright .tabs{display:none !important}
  .header-mob-tabs{display:flex !important}
  .ai-btn{display:none !important}
}
.header-mob-tabs{display:none;padding:0 12px 8px;gap:2px}
.header-mob-tabs .tab{flex:1;text-align:center}
/* Mobile menu overlay + drawer */
#mobMenu{position:fixed;inset:0;z-index:300;display:none;pointer-events:none}
#mobMenu.on{display:block}
#mobMenuOverlay{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);opacity:0;transition:opacity .35s cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none}
#mobMenu.on #mobMenuOverlay{opacity:1;pointer-events:auto}
#mobMenuDrawer{position:absolute;top:0;right:0;bottom:0;width:272px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .4s cubic-bezier(0.34, 1, 0.64, 1);pointer-events:none;box-shadow:-20px 0 60px rgba(0,0,0,.45)}
#mobMenu.on #mobMenuDrawer{transform:translateX(0);pointer-events:auto}
.mob-drawer-head{padding:20px 18px 14px;padding-top:calc(env(safe-area-inset-top,0px) + 20px);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.mob-drawer-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-family:var(--mono)}
.mob-drawer-close{width:30px;height:30px;border-radius:8px;background:var(--light);border:1px solid var(--border);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--muted);-webkit-tap-highlight-color:transparent}
.mob-drawer-close:active{background:var(--border)}
.mob-drawer-body{flex:1;overflow-y:auto;padding:8px 0}
.mob-menu-item{display:flex;align-items:center;gap:14px;padding:13px 18px;cursor:pointer;transition:background .12s;border:none;background:transparent;width:100%;text-align:left;font-family:'DM Sans',sans-serif;-webkit-tap-highlight-color:transparent}
.mob-menu-item:active{background:var(--light)}
.mob-menu-icon{width:36px;height:36px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.mob-menu-label{font-size:13px;font-weight:600;color:var(--text)}
.mob-menu-sub{font-size:11px;color:var(--muted);margin-top:1px;font-family:var(--mono)}
.mob-menu-sep{height:1px;background:var(--border);margin:6px 18px}
.mob-menu-item.danger .mob-menu-icon{background:rgba(255,68,68,.07);border-color:rgba(255,68,68,.2)}
.mob-menu-item.danger .mob-menu-label{color:var(--red)}
.mob-drawer-foot{padding:14px 18px;border-top:1px solid var(--border);padding-bottom:calc(14px + env(safe-area-inset-bottom,0px));flex-shrink:0}
.mob-drawer-version{font-size:10px;color:var(--muted);font-family:var(--mono)}
/* Switch profile button (desktop header only) */
.switch-profile-btn{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:6px 12px;cursor:pointer;user-select:none;transition:all .2s;font-family:var(--mono);font-size:11px;font-weight:600;color:var(--muted)}
.switch-profile-btn:hover{border-color:var(--accent);color:var(--accent)}

  
/* ===== FIX: Dark mode highlight text unreadable ===== */
body:not(.classic-theme) .srow[style],
body:not(.classic-theme) .srow.highlight,
body:not(.classic-theme) .ccard.highlight {

  /* darker transparent highlight instead of washed out grey */
  background: rgba(255,107,0,0.14) !important;

  /* ensure readable text */
  color: var(--text) !important;
}

/* force topic name to stay readable */
body:not(.classic-theme) .srow[style] .sname,
body:not(.classic-theme) .srow.highlight .sname {
  color: var(--text) !important;
  font-weight: 600;
}

/* force numbers and other text readable */
body:not(.classic-theme) .srow[style] .pill,
body:not(.classic-theme) .srow[style] span,
body:not(.classic-theme) .srow.highlight .pill,
body:not(.classic-theme) .srow.highlight span {
  color: var(--text) !important;
}

  
</style>
<script>
window.MathJax = {
  tex: { inlineMath: [['\\(','\\)']], displayMath: [['\\[','\\]']], processEscapes: true },
  options: { skipHtmlTags: ['script','noscript','style','textarea','pre'] },
  startup: { typeset: false }
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js" async></script>
</head>
<body>

<!-- ═══ PROFILE SELECTION SCREEN ═══════════════════════════ -->
<div id="profileScreen">
  <div class="profile-floaters" id="profileFloaters">
    <!-- Floating words will be added by JavaScript -->
  </div>
  <div class="profile-topbar">
    <div class="design-toggle" onclick="toggleDesign()" id="themeToggleBtn" title="Switch theme">
      <span class="design-toggle-icon" id="designIconProfile">🌙</span>
      <span class="design-toggle-label" id="designLabelProfile">DARK</span>
    </div>
  </div>
  <div class="profile-container">
    <div class="profile-title">Revision<span>.</span></div>
    <div class="profile-subtitle">select your workspace</div>
    <div class="profile-cards">
      <div class="profile-card-wrap">
        <div class="profile-card" onclick="selectProfile('guest')">
          <div class="profile-icon">👥</div>
          <div class="profile-name">Guest</div>
        </div>
        <div class="profile-card-label">Explore with sample data.<br>Local only.</div>
      </div>
      <div class="profile-card-wrap">
        <div class="profile-card" onclick="selectProfile('aj')">
          <div class="profile-badge">★</div>
          <div class="profile-icon">🎯</div>
          <div class="profile-name">AJ</div>
        </div>
        <div class="profile-card-label">Full access · cloud sync.<br>Cross-device.</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ PASSWORD MODAL ════════════════════════════════════ -->
<div id="passwordModal">
  <div class="password-box">
    <div class="password-title">Enter PIN</div>
    <div class="password-subtitle">AJ · secured workspace</div>
    <input type="password" inputmode="numeric" pattern="[0-9]*" class="password-input" id="passwordInput" placeholder="• • • • • •" maxlength="6" autocomplete="off" onkeypress="if(event.key==='Enter')checkPassword()" oninput="if(this.value.length===6)checkPassword()">
    <div class="password-actions">
      <button class="password-btn secondary" onclick="closePasswordModal()">Cancel</button>
      <button class="password-btn primary" onclick="checkPassword()">Unlock →</button>
    </div>
  </div>
</div>

<!-- ═══ LOADING SCREEN ════════════════════════════════════ -->
<div id="loadingScreen">
  <div class="loading-floaters" id="loadingFloaters"></div>
  <div class="loading-content">
    <div class="loading-brand">Revision<span>.</span></div>
    <div class="loading-text" id="loadingText">Initialising workspace...</div>
    <div class="loading-subtext" id="loadingSubtext">Getting things ready</div>
    <div class="loading-bar-wrap">
      <div class="loading-bar" id="loadingBar"></div>
    </div>
    <div class="loading-tip" id="loadingTip"></div>
  </div>
</div>

<!-- ══ HEADER ══ -->
<div class="header">
  <div class="header-row1">
    <div class="logo">
      <div class="logo-dot"></div>
      <div>
        <div class="app-title">A Level Revision Tracker</div>
        <div class="app-sub">Edexcel · auto-saves · cloud sync</div>
        <div class="hprog-inline">
          <div class="hprog-inline-track"><div class="hprog-fill" id="hprogFill" style="width:0%;background:var(--red)"></div></div>
          <span class="hprog-inline-pct" id="hprogPct" style="color:var(--red)">0%</span>
          <span class="hprog-inline-detail" id="hprogDetail"></span>
        </div>
      </div>
    </div>
    <div class="hright">
      <div class="design-toggle" onclick="exportAllData()" title="Export all your data as a backup file" style="background:var(--surface);border-color:var(--border)">
        <span class="design-toggle-icon">💾</span>
        <span class="design-toggle-label">EXPORT</span>
      </div>
      <label class="design-toggle" title="Import data from a backup file" style="cursor:pointer">
        <span class="design-toggle-icon">📂</span>
        <span class="design-toggle-label">IMPORT</span>
        <input type="file" accept=".json" onchange="importAllData(this)" style="display:none">
      </label>
      <div class="design-toggle" onclick="toggleDesign()" title="Switch between modern dark and classic light design">
        <span class="design-toggle-icon" id="designIcon">🌙</span>
        <span class="design-toggle-label" id="designLabel">DARK</span>
      </div>
      <div class="stopwatch">
        <div class="sw-time" id="swT">00:00</div>
        <button class="swb" id="swBtn" onclick="swToggle()" style="background:#eef4ff;color:var(--blue)">▶</button>
        <button class="swb" onclick="swReset()" style="background:var(--light);color:var(--muted)">↺</button>
      </div>
      <div class="syncpill sync" id="syncPill" title="Cloud sync status">☁️ <b id="syncTxt">Syncing</b></div>
      <button class="switch-profile-btn" onclick="switchProfile()" id="profileSwitchBtn" title="Switch profile">⇄ <span id="currentProfileLabel">Guest</span></button>
      <div class="tabs">
        <button class="tab on" onclick="switchSubject('maths')" id="tMaths">Maths</button>
        <button class="tab" onclick="switchSubject('fm')" id="tFM">Further Maths</button>
        <button class="tab" onclick="switchSubject('exams')" id="tExams">📋 Exams</button>
      </div>
      <button class="mob-menu-btn" onclick="toggleMobMenu()" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>
  <!-- Mobile subject tabs row (hidden on desktop) -->
  <div class="header-mob-tabs">
    <button class="tab on" onclick="switchSubject('maths')" id="tMaths_mob">Maths</button>
    <button class="tab" onclick="switchSubject('fm')" id="tFM_mob">Further Maths</button>
    <button class="tab" onclick="switchSubject('exams')" id="tExams_mob">📋 Exams</button>
  </div>
  <div class="header-row2">
    <div class="subtabs" id="subtabBar">
      <button class="stab on" onclick="switchSubTab('maths_py1')" id="st_maths_py1">Pure Y1</button>
      <button class="stab" onclick="switchSubTab('maths_py2')" id="st_maths_py2">Pure Y2</button>
      <button class="stab" onclick="switchSubTab('maths_sm1')" id="st_maths_sm1">Stats &amp; Mech Y1</button>
      <button class="stab" onclick="switchSubTab('maths_sm2')" id="st_maths_sm2">Stats &amp; Mech Y2</button>
    </div>
  </div>
</div>

<!-- MOBILE HAMBURGER MENU DRAWER -->
<div id="mobMenu">
  <div id="mobMenuOverlay" onclick="closeMobMenu()"></div>
  <div id="mobMenuDrawer">
    <div class="mob-drawer-head">
      <div class="mob-drawer-title">Menu</div>
      <button class="mob-drawer-close" onclick="closeMobMenu()">✕</button>
    </div>
    <div class="mob-drawer-body">
      <button class="mob-menu-item" onclick="closeMobMenu();toggleDesign()">
        <div class="mob-menu-icon" id="mobMenuThemeIcon">🌙</div>
        <div><div class="mob-menu-label" id="mobMenuThemeLabel">Dark Mode</div><div class="mob-menu-sub">Toggle theme</div></div>
      </button>
      <button class="mob-menu-item" onclick="closeMobMenu();exportAllData()">
        <div class="mob-menu-icon">💾</div>
        <div><div class="mob-menu-label">Export Data</div><div class="mob-menu-sub">Download backup</div></div>
      </button>
      <label class="mob-menu-item" style="cursor:pointer">
        <div class="mob-menu-icon">📂</div>
        <div><div class="mob-menu-label">Import Data</div><div class="mob-menu-sub">Restore backup</div></div>
        <input type="file" accept=".json" onchange="closeMobMenu();importAllData(this)" style="display:none">
      </label>
      <div class="mob-menu-sep"></div>
      <button class="mob-menu-item danger" onclick="closeMobMenu();switchProfile()">
        <div class="mob-menu-icon">⇄</div>
        <div><div class="mob-menu-label">Switch Profile</div><div class="mob-menu-sub">Change workspace</div></div>
      </button>
    </div>
    <div class="mob-drawer-foot">
      <div class="mob-drawer-version">A Level Revision Tracker</div>
    </div>
  </div>
</div>

<!-- PAGE -->
<div class="page">
  <div class="overview-tiles">
    <div class="summary">
      <div class="scard"><div class="snum" id="sAvg" style="color:var(--blue)">—</div><div class="slbl">Overall avg</div><div class="scard-bar"><div class="scard-bar-fill" id="sAvgB" style="background:var(--blue);width:0"></div></div></div>
      <div class="scard"><div class="snum" id="sRed" style="color:var(--red)">0</div><div class="slbl">Weak 1–3</div><div class="scard-bar"><div class="scard-bar-fill" id="sRedB" style="background:var(--red);width:0"></div></div></div>
      <div class="scard"><div class="snum" id="sOrg" style="color:var(--orange)">0</div><div class="slbl">Needs work 4–6</div><div class="scard-bar"><div class="scard-bar-fill" id="sOrgB" style="background:var(--orange);width:0"></div></div></div>
      <div class="scard"><div class="snum" id="sGrn" style="color:var(--green)">0</div><div class="slbl">Good 7–8</div><div class="scard-bar"><div class="scard-bar-fill" id="sGrnB" style="background:var(--green);width:0"></div></div></div>
      <div class="scard"><div class="snum" id="sTel" style="color:var(--teal)">0</div><div class="slbl">Mastered 9–10</div><div class="scard-bar"><div class="scard-bar-fill" id="sTelB" style="background:var(--teal);width:0"></div></div></div>
    </div>
  </div>
  <div class="alert" id="abox">
    <div class="alert-inner">
      <div class="alert-head"><div class="alert-icon">🎯</div><div><div class="alert-title">Priority Focus Areas</div><div class="alert-desc" id="aDesc"></div></div></div>
      <div class="alert-body" id="aBody"></div>
    </div>
  </div>
  <div class="charts">
    <div class="ccrd"><div class="ctitle">Chapter Averages</div><div class="csub">Tap a bar to expand</div><div class="barchart" id="barchart"></div></div>
    <div class="ccrd" style="position:relative"><div class="ctitle">Skill Radar</div><div class="csub">Hover to inspect · click to expand</div><svg id="radarSvg" viewBox="0 0 220 198"></svg><div class="rtip" id="rtip"></div></div>
  </div>
  <div class="grid" id="grid"></div>
  <div class="legend">
    <div class="litem"><div class="ldot" style="background:var(--red)"></div>1–3 Weak</div>
    <div class="litem"><div class="ldot" style="background:var(--orange)"></div>4–6 Needs work</div>
    <div class="litem"><div class="ldot" style="background:var(--green)"></div>7–8 Good</div>
    <div class="litem"><div class="ldot" style="background:var(--teal)"></div>9–10 Mastered</div>
  </div>
</div>

<!-- ADD QUESTION MODAL -->
<div class="modal-bg" id="addQModal" onclick="if(event.target===this)closeAddQ()">
  <div class="modal" style="width:min(580px,94vw)">
    <div class="modal-head">
      <div class="modal-title">Add Exam Question</div>
      <button class="modal-close" onclick="closeAddQ()">✕</button>
    </div>
    <div class="modal-body">
      <div class="aq-upload-grid">
        <div class="aq-zone" id="aqQZone" onclick="aqZoneTap('q',event)" ondblclick="document.getElementById('aqQFile').click()">
          <input type="file" id="aqQFile" accept="image/*" style="display:none" onchange="aqFileChosen(this,'q')">
          <div class="aq-zone-icon">📄</div>
          <div class="aq-zone-label">Question</div>
          <div class="aq-zone-sub">Tap to browse · or paste an image</div>
        </div>
        <div class="aq-zone" id="aqAZone" onclick="aqZoneTap('a',event)" ondblclick="if(aqAnsType==='img')document.getElementById('aqAFile').click()">
          <input type="file" id="aqAFile" accept="image/*" style="display:none" onchange="aqFileChosen(this,'a')">
          <div class="aq-zone-icon">✅</div>
          <div class="aq-zone-label">Answer <span style="font-weight:400;color:var(--muted)">(optional)</span></div>
          <div class="aq-zone-sub" id="aqASub">Tap to browse · or paste an image</div>
        </div>
        <div class="aq-ans-type">
          <div class="aq-ans-pill">
            <button class="aq-pill on" id="aqPillImg" onclick="setAnsType('img');event.stopPropagation()">Image</button>
            <button class="aq-pill" id="aqPillVid" onclick="setAnsType('video');event.stopPropagation()">Video link</button>
          </div>
          <input class="aq-vid" id="aqVidUrl" placeholder="Paste video URL (YouTube/Drive/etc.)" oninput="aqVidInput()" onclick="event.stopPropagation()" style="display:none">
          <div class="aq-vid-hint" id="aqVidHint" style="display:none">Tip: YouTube links will embed automatically.</div>
        </div>
      </div>
      <div class="aq-diff-section">
        <div class="aq-diff-label">Difficulty Rating</div>
        <div class="aq-diff-sub">How hard is this question? (optional)</div>
        <div class="aq-stars" id="aqStars"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeAddQ()">Cancel</button>
      <button class="btn btn-primary" id="aqSubmitBtn" onclick="submitAddQ()" disabled>Add Question</button>
    </div>
  </div>
</div>

<!-- ATTEMPT MODAL -->
<div class="modal-bg" id="attModal" onclick="if(event.target===this)closeAtt()">
  <div class="modal" style="width:min(500px,94vw)">
    <div class="modal-head">
      <div class="modal-title">Attempt Log</div>
      <button class="modal-close" onclick="closeAtt()">✕</button>
    </div>
    <div class="modal-body">
      <div class="att-new-section">
        <div class="att-new-title">Log New Attempt</div>
        <div class="att-score-row">
          <span class="att-score-label">Score:</span>
          <input class="att-score-in" id="attScore" type="number" min="0" placeholder="e.g. 7">
          <span class="att-out-label">out of</span>
          <input class="att-out-in" id="attOut" type="number" min="1" placeholder="e.g. 10">
        </div>
        <textarea class="att-note-in" id="attNote" rows="2" placeholder="Notes (optional) — what went wrong, what to review..."></textarea>
        <br><br>
        <button class="att-submit-btn" onclick="submitAttempt()">Log Attempt</button>
      </div>
      <div class="att-history-title">Attempt History</div>
      <div class="att-list" id="attList"></div>
    </div>
  </div>
</div>

<!-- QUESTION VIEWER MODAL -->
<div class="modal-bg" id="viewerModal" onclick="if(event.target===this)closeViewer()">
  <div class="modal" style="width:min(900px,96vw);max-height:92vh">
    <div class="viewer-nav">
      <button class="viewer-arrow" id="vPrev" onclick="viewerNav(-1)">‹</button>
      <div class="viewer-counter" id="vCounter">1 / 1</div>
      <button class="viewer-arrow" id="vNext" onclick="viewerNav(1)">›</button>
      <button class="viewer-att-btn" id="vAttBtn" onclick="toggleViewerAttempts()"><span>📝 Attempts</span><span class="viewer-att-badge" id="vAttBadge">0</span></button>
      <button class="modal-close" onclick="closeViewer()" style="margin-left:8px">✕</button>
    </div>
    <div class="viewer-body" id="viewerBody"></div>
    <div class="vatt" id="vAttPanel" onclick="event.stopPropagation()">
      <div class="vatt-h">
        <div>
          <div class="vatt-title" id="vAttTitle">Attempts</div>
          <div class="vatt-sub" id="vAttSub">—</div>
        </div>
        <button class="vatt-x" onclick="toggleViewerAttempts(false)">✕</button>
      </div>
      <div class="vatt-b">
        <div class="vatt-form">
          <div class="vatt-row">
            <input class="vatt-in" id="vAttScore" inputmode="decimal" placeholder="Score">
            <input class="vatt-in" id="vAttOut" inputmode="decimal" placeholder="Out of (optional)">
          </div>
          <textarea class="vatt-note" id="vAttNote" rows="2" placeholder="Notes (optional)..."></textarea>
          <button class="vatt-submit" onclick="submitViewerAttempt()">Log Attempt</button>
        </div>
        <div class="vatt-list-title">Attempt history</div>
        <div class="vatt-list" id="vAttList"></div>
      </div>
    </div>
    <div class="viewer-timer">
      <span class="vt-lbl">⏱ Timer</span>
      <div class="vt-time" id="vtTime">00:00</div>
      <button class="vtb" id="vtBtn" onclick="vtToggle()" style="background:#eef4ff;color:var(--blue)">▶</button>
      <button class="vtb" onclick="vtReset()" style="background:var(--light);color:var(--muted)">↺</button>
    </div>
  </div>
</div>

<!-- NOTES MODAL -->
<div id="noteModal" onclick="if(event.target===this)closeNote()">
  <div class="note-modal-box">
    <div class="note-modal-title" id="noteModalTitle">Notes</div>
    <div>
      <div class="note-toolbar" id="noteToolbar">
        <button class="ntb" title="Bold (Ctrl+B)" onmousedown="ntCmd('bold');return false"><b>B</b></button>
        <button class="ntb" title="Italic (Ctrl+I)" onmousedown="ntCmd('italic');return false"><i>I</i></button>
        <button class="ntb" title="Underline (Ctrl+U)" onmousedown="ntCmd('underline');return false"><u>U</u></button>
        <div class="ntb-sep"></div>
        <button class="ntb" title="Big heading" onmousedown="ntBlock('h2');return false">H1</button>
        <button class="ntb" title="Small heading" onmousedown="ntBlock('h3');return false">H2</button>
        <button class="ntb" title="Normal text" onmousedown="ntBlock('p');return false">¶</button>
        <div class="ntb-sep"></div>
        <button class="ntb" title="Bullet list" onmousedown="ntCmd('insertUnorderedList');return false">• List</button>
        <button class="ntb" title="Numbered list" onmousedown="ntCmd('insertOrderedList');return false">1. List</button>
        <div class="ntb-sep"></div>
        <button class="ntb" title="Insert image" onmousedown="ntInsertImg();return false">🖼</button>
        <input type="file" id="ntImgFile" accept="image/*" style="display:none" onchange="ntImgFileChosen(this)">
      </div>
      <div class="note-editor" id="noteEditor" contenteditable="true" data-placeholder="Add your notes, reminders, tips… bold, headings, images all supported"></div>
    </div>
    <div class="note-modal-foot">
      <button class="note-clear-btn" onclick="clearNote()">Clear</button>
      <button class="note-save-btn" onclick="saveNote()">Save</button>
    </div>
  </div>
</div>

<!-- FULLSCREEN PHOTO VIEWER -->
<div id="photoViewer">
  <div class="pv-bar">
    <div>
      <div class="pv-title" id="pvTitle">Question</div>
      <div class="pv-subtitle" id="pvSubtitle"></div>
    </div>
    <div class="pv-pill-wrap" id="pvPills" style="display:none">
      <button class="pv-pill on" id="pvPillQ" onclick="pvSwitch('q')">📄 Question</button>
      <button class="pv-pill" id="pvPillA" onclick="pvSwitch('a')">✅ Answer</button>
    </div>
    <button class="pv-close" onclick="closePV()">✕</button>
  </div>
  <div class="pv-canvas" id="pvCanvas">
    <img class="pv-img" id="pvImg" src="" alt="">
    <div class="pv-ans-cover gone" id="pvAnsCover" onclick="pvReveal()">
      <div class="pv-ans-cover-inner">
        <div class="pv-ans-icon">🔒</div>
        <div class="pv-ans-txt">Answer hidden</div>
        <div class="pv-ans-sub">Tap to reveal</div>
      </div>
    </div>
  </div>
  <div class="pv-bottom">
    <div class="pv-zoom-btns">
      <button class="pvb" onclick="pvZoomStep(-1)">−</button>
      <div class="pv-zoom-lbl" id="pvZoomLbl">100%</div>
      <button class="pvb" onclick="pvZoomStep(1)">+</button>
      <button class="pvb" onclick="pvZoomReset()" title="Reset">↺</button>
    </div>
    <div class="pv-hint">Scroll to zoom · drag to pan</div>
    <button class="pv-reveal-btn" id="pvRevealBtn" style="display:none" onclick="pvReveal()">👁 Reveal Answer</button>
  </div>
</div>

<script>
// ══ ALL DATA ══════════════════════════════════════════════════
const DATA = {
  maths_py1: [
    {id:"m1",ch:"1. Algebraic Expressions",sh:"Algebra",s:["Index laws","Expanding brackets","Factorising","Negative & fractional indices","Surds","Rationalising denominators"]},
    {id:"m2",ch:"2. Quadratics",sh:"Quadratics",s:["Solving quadratic equations","Completing the square","Functions","Quadratic graphs","The discriminant","Modelling with quadratics"]},
    {id:"m3",ch:"3. Equations & Inequalities",sh:"Inequalities",s:["Linear simultaneous equations","Quadratic simultaneous equations","Simultaneous equations on graphs","Linear inequalities","Quadratic inequalities","Inequalities on graphs","Regions"]},
    {id:"m4",ch:"4. Graphs & Transformations",sh:"Graphs",s:["Cubic graphs","Quartic graphs","Reciprocal graphs","Points of intersection","Translating graphs","Stretching graphs","Transforming functions"]},
    {id:"m5",ch:"5. Straight Line Graphs",sh:"Straight Lines",s:["y = mx + c","Equations of straight lines","Parallel & perpendicular lines","Length and area","Modelling with straight lines"]},
    {id:"m6",ch:"6. Circles",sh:"Circles",s:["Midpoints & perpendicular bisectors","Equation of a circle","Intersections of lines & circles","Tangent and chord properties","Circles and triangles"]},
    {id:"m7",ch:"7. Algebraic Methods",sh:"Alg. Methods",s:["Algebraic fractions","Dividing polynomials","The factor theorem","Mathematical proof","Methods of proof"]},
    {id:"m8",ch:"8. Binomial Expansion",sh:"Binomial",s:["Pascal's triangle","Factorial notation","The binomial expansion","Solving binomial problems","Binomial estimation"]},
    {id:"m9",ch:"9. Trigonometric Ratios",sh:"Trig Ratios",s:["The cosine rule","The sine rule","Areas of triangles","Solving triangle problems","Graphs of sin, cos & tan","Transforming trig graphs"]},
    {id:"m10",ch:"10. Trig Identities & Equations",sh:"Trig IDs",s:["Angles in all four quadrants","Exact trig values","Trigonometric identities","Simple trig equations","Harder trig equations","Equations and identities"]},
    {id:"m11",ch:"11. Vectors",sh:"Vectors",s:["Vectors","Representing vectors","Magnitude and direction","Position vectors","Solving geometric problems","Modelling with vectors"]},
    {id:"m12",ch:"12. Differentiation",sh:"Diff.",s:["Gradients of curves","Finding the derivative","Differentiating xⁿ","Differentiating quadratics","Differentiating multi-term functions","Gradients, tangents & normals","Increasing & decreasing functions","Second order derivatives","Stationary points","Sketching gradient functions","Modelling with differentiation"]},
    {id:"m13",ch:"13. Integration",sh:"Integration",s:["Integrating xⁿ","Indefinite integrals","Finding functions","Definite integrals","Areas under curves","Areas under the x-axis","Areas between curves & lines"]},
    {id:"m14",ch:"14. Exponentials & Logarithms",sh:"Exp & Log",s:["Exponential functions","y = eˣ","Exponential modelling","Logarithms","Laws of logarithms","Solving equations using logs","Working with natural logarithms","Logarithms and non-linear data"]},
  ],
  maths_py2: [
    {id:"p1",ch:"1. Algebraic Methods",sh:"Alg. Methods",s:["Proof by contradiction","Algebraic fractions","Partial fractions","Repeated factors","Algebraic division"]},
    {id:"p2",ch:"2. Functions & Graphs",sh:"Functions",s:["The modulus function","Functions and mappings","Composite functions","Inverse functions","y=|f(x)| and y=f(|x|)","Combining transformations","Solving modulus problems"]},
    {id:"p3",ch:"3. Sequences & Series",sh:"Sequences",s:["Arithmetic sequences","Arithmetic series","Geometric sequences","Geometric series","Sum to infinity","Sigma notation","Recurrence relations","Modelling with series"]},
    {id:"p4",ch:"4. Binomial Expansion",sh:"Binomial",s:["Expanding (1+x)ⁿ","Expanding (a+bx)ⁿ","Using partial fractions"]},
    {id:"p5",ch:"5. Radians",sh:"Radians",s:["Radian measure","Arc length","Areas of sectors & segments","Solving trig equations","Small angle approximations"]},
    {id:"p6",ch:"6. Trigonometric Functions",sh:"Trig Fns",s:["Secant, cosecant, cotangent","Graphs of sec, cosec, cot","Using sec, cosec, cot","Trigonometric identities","Inverse trig functions"]},
    {id:"p7",ch:"7. Trigonometry & Modelling",sh:"Trig Model",s:["Addition formulae","Angle addition formulae","Double-angle formulae","Solving trig equations","a·cosx ± b·sinx","Proving trig identities","Modelling with trig"]},
    {id:"p8",ch:"8. Parametric Equations",sh:"Parametric",s:["Parametric equations","Using trig identities","Curve sketching","Points of intersection","Modelling with parametrics"]},
    {id:"p9",ch:"9. Differentiation",sh:"Diff.",s:["Differentiating sinx & cosx","Diff. exponentials & logs","Chain rule","Product rule","Quotient rule","Diff. trig functions","Parametric differentiation","Implicit differentiation","Second derivatives","Rates of change"]},
    {id:"p10",ch:"10. Numerical Methods",sh:"Numerical",s:["Locating roots","Iteration","Newton–Raphson method","Applications to modelling"]},
    {id:"p11",ch:"11. Integration",sh:"Integration",s:["Integrating standard functions","Integrating f(ax+b)","Using trig identities","Reverse chain rule","Integration by substitution","Integration by parts","Partial fractions","Finding areas","Trapezium rule","Solving differential equations","Modelling with diff. equations"]},
    {id:"p12",ch:"12. Vectors",sh:"Vectors",s:["3D coordinates","Vectors in 3D","Solving geometric problems","Application to mechanics"]},
  ],
  maths_sm1: [
    {id:"s1",ch:"1. Data Collection",sh:"Data Coll.",s:["Populations and samples","Sampling","Non-random sampling","Types of data","The large data set"]},
    {id:"s2",ch:"2. Measures of Location & Spread",sh:"Loc & Spread",s:["Measures of central tendency","Other measures of location","Measures of spread","Variance and standard deviation","Coding"]},
    {id:"s3",ch:"3. Representations of Data",sh:"Data Reps",s:["Outliers","Box plots","Cumulative frequency","Histograms","Comparing data"]},
    {id:"s4",ch:"4. Correlation",sh:"Correlation",s:["Correlation","Linear regression"]},
    {id:"s5",ch:"5. Probability",sh:"Probability",s:["Calculating probabilities","Venn diagrams","Mutually exclusive & independent events","Tree diagrams"]},
    {id:"s6",ch:"6. Statistical Distributions",sh:"Distributions",s:["Probability distributions","The binomial distribution","Cumulative probabilities"]},
    {id:"s7",ch:"7. Hypothesis Testing",sh:"Hyp. Testing",s:["Hypothesis testing","Finding critical values","One-tailed tests","Two-tailed tests"]},
    {id:"m8",ch:"8. Modelling in Mechanics",sh:"Modelling",s:["Constructing a model","Modelling assumptions","Quantities and units","Working with vectors"]},
    {id:"m9",ch:"9. Constant Acceleration",sh:"Const. Accel.",s:["Displacement–time graphs","Velocity–time graphs","Constant acceleration formulae 1","Constant acceleration formulae 2","Vertical motion under gravity"]},
    {id:"m10",ch:"10. Forces & Motion",sh:"Forces",s:["Force diagrams","Forces as vectors","Forces and acceleration","Motion in 2 dimensions","Connected particles","Pulleys"]},
    {id:"m11",ch:"11. Variable Acceleration",sh:"Var. Accel.",s:["Functions of time","Using differentiation","Maxima and minima problems","Using integration","Constant acceleration formulae"]},
  ],
  maths_sm2: [
    {id:"t1",ch:"1. Regression, Correlation & Hypothesis Testing",sh:"Regression",s:["Exponential models","Measuring correlation","Hypothesis testing for zero correlation"]},
    {id:"t2",ch:"2. Conditional Probability",sh:"Cond. Prob.",s:["Set notation","Conditional probability","Cond. probs in Venn diagrams","Probability formulae","Tree diagrams"]},
    {id:"t3",ch:"3. Normal Distribution",sh:"Normal Dist.",s:["The normal distribution","Finding probabilities","Inverse normal distribution","Standard normal distribution","Finding μ and σ","Approximating a binomial","Hypothesis testing"]},
    {id:"v4",ch:"4. Moments",sh:"Moments",s:["Moments","Resultant moments","Equilibrium","Centres of mass","Tilting"]},
    {id:"v5",ch:"5. Forces & Friction",sh:"Forces",s:["Resolving forces","Inclined planes","Friction"]},
    {id:"v6",ch:"6. Projectiles",sh:"Projectiles",s:["Horizontal projection","Horizontal & vertical components","Projection at any angle","Projectile motion formulae"]},
    {id:"v7",ch:"7. Applications of Forces",sh:"App. Forces",s:["Static particles","Modelling with statics","Friction and static particles","Static rigid bodies","Dynamics and inclined planes","Connected particles"]},
    {id:"v8",ch:"8. Further Kinematics",sh:"Kinematics",s:["Vectors in kinematics","Vector methods with projectiles","Variable acceleration","Differentiating vectors","Integrating vectors"]},
  ],
  fm_cp1: [
    {id:"c1",ch:"1. Complex Numbers",sh:"Complex Nos.",s:["Imaginary and complex numbers","Multiplying complex numbers","Complex conjugation","Roots of quadratic equations","Solving cubic and quartic equations"]},
    {id:"c2",ch:"2. Argand Diagrams",sh:"Argand",s:["Argand diagrams","Modulus and argument","Modulus-argument form","Loci in the Argand diagram","Regions in the Argand diagram"]},
    {id:"c3",ch:"3. Series",sh:"Series",s:["Sums of natural numbers","Sums of squares and cubes"]},
    {id:"c4",ch:"4. Roots of Polynomials",sh:"Roots",s:["Roots of a quadratic","Roots of a cubic","Roots of a quartic","Expressions relating to roots","Linear transformations of roots"]},
    {id:"c5",ch:"5. Volumes of Revolution",sh:"Volumes",s:["Around the x-axis","Around the y-axis","Adding & subtracting volumes","Modelling with volumes"]},
    {id:"c6",ch:"6. Matrices",sh:"Matrices",s:["Introduction to matrices","Matrix multiplication","Determinants","Inverting a 2×2 matrix","Inverting a 3×3 matrix","Solving systems using matrices"]},
    {id:"c7",ch:"7. Linear Transformations",sh:"Lin. Trans.",s:["Transformations in 2D","Reflections and rotations","Enlargements and stretches","Successive transformations","Transformations in 3D","Inverse of a transformation"]},
    {id:"c8",ch:"8. Proof by Induction",sh:"Proof",s:["Proof by induction","Proving divisibility results","Proving statements with matrices"]},
    {id:"c9",ch:"9. Vectors",sh:"Vectors",s:["Line in 3D","Plane in 3D","Scalar product","Angles between lines & planes","Points of intersection","Finding perpendiculars"]},
  ],
  fm_cp2: [
    {id:"d1",ch:"1. Complex Numbers",sh:"Complex Nos.",s:["Exponential form","Multiplying and dividing","De Moivre's theorem","Trig identities","Sums of series","nth roots","Geometric problems"]},
    {id:"d2",ch:"2. Series",sh:"Series",s:["Method of differences","Higher derivatives","Maclaurin series","Series expansions of compound functions"]},
    {id:"d3",ch:"3. Methods in Calculus",sh:"Calculus",s:["Improper integrals","Mean value of a function","Diff. inverse trig functions","Int. inverse trig functions","Integrating using partial fractions"]},
    {id:"d4",ch:"4. Volumes of Revolution",sh:"Volumes",s:["Around the x-axis","Around the y-axis","Parametric curves","Modelling with volumes"]},
    {id:"d5",ch:"5. Polar Coordinates",sh:"Polar",s:["Polar coordinates & equations","Sketching curves","Area enclosed by polar curve","Tangents to polar curves"]},
    {id:"d6",ch:"6. Hyperbolic Functions",sh:"Hyperbolic",s:["Intro to hyperbolic functions","Inverse hyperbolic functions","Identities and equations","Differentiating hyperbolic functions","Integrating hyperbolic functions"]},
    {id:"d7",ch:"7. Differential Equations",sh:"Diff. Eqs.",s:["First-order diff. equations","Second-order homogeneous","Second-order non-homogeneous","Using boundary conditions"]},
    {id:"d8",ch:"8. Modelling with DEs",sh:"Modelling",s:["Modelling first-order DEs","Simple harmonic motion","Damped & forced harmonic motion","Coupled simultaneous DEs"]},
  ],
  fm_fmech1: [
    {id:"e1",ch:"1. Momentum & Impulse",sh:"Momentum",s:["Momentum in one direction","Conservation of momentum","Momentum as a vector"]},
    {id:"e2",ch:"2. Work, Energy & Power",sh:"Energy",s:["Work done","Kinetic and potential energy","Conservation of mechanical energy & work-energy principle","Power"]},
    {id:"e3",ch:"3. Elastic Strings & Springs",sh:"Elasticity",s:["Hooke's law and equilibrium problems","Hooke's law and dynamics problems","Elastic energy","Problems involving elastic energy"]},
    {id:"e4",ch:"4. Elastic Collisions in One Dimension",sh:"1D Collisions",s:["Direct impact and Newton's law of restitution","Direct collision with a smooth plane","Loss of kinetic energy","Successive direct impacts"]},
    {id:"e5",ch:"5. Elastic Collisions in Two Dimensions",sh:"2D Collisions",s:["Oblique impact with a fixed surface","Successive oblique impacts","Oblique impact of smooth spheres"]},
  ],
  fm_fstat1: [
    {id:"f1",ch:"1. Discrete Random Variables",sh:"Discrete RV",s:["Expected value of a discrete random variable","Variance of a discrete random variable","Expected value and variance of a function of X","Solving problems involving random variables"]},
    {id:"f2",ch:"2. Poisson Distributions",sh:"Poisson",s:["The Poisson distribution","Modelling with the Poisson distribution","Adding Poisson distributions","Mean and variance of a Poisson distribution","Mean and variance of the binomial distribution","Using the Poisson distribution to approximate the binomial"]},
    {id:"f3",ch:"3. Geometric & Negative Binomial",sh:"Geo & NegBin",s:["The geometric distribution","Mean and variance of a geometric distribution","The negative binomial distribution","Mean and variance of the negative binomial distribution"]},
    {id:"f4",ch:"4. Hypothesis Testing",sh:"Hyp. Testing",s:["Testing for the mean of a Poisson distribution","Finding critical regions for a Poisson distribution","Hypothesis testing for the parameter p of a geometric distribution","Finding critical regions for a geometric distribution"]},
    {id:"f5",ch:"5. Central Limit Theorem",sh:"CLT",s:["The central limit theorem","Applying the central limit theorem to other distributions"]},
    {id:"f6",ch:"6. Chi-Squared Tests",sh:"Chi-Squared",s:["Goodness of fit","Degrees of freedom and the chi-squared family","Testing a hypothesis","Testing goodness of fit with discrete data","Using contingency tables","Apply goodness-of-fit tests to geometric distributions"]},
    {id:"f7",ch:"7. Probability Generating Functions",sh:"PGFs",s:["Probability generating functions","PGFs of standard distributions","Mean and variance of a distribution","Sums of independent random variables"]},
    {id:"f8",ch:"8. Quality of Tests",sh:"Quality",s:["Type I and Type II errors","Finding Type I and Type II errors using the normal distribution","Calculate the size and power of a test","The power function"]},
  ],
};

// ══ STATE ════════════════════════════════════════════════════
let subject='maths', subTab='maths_py1', exp=new Set(), R={}, QS={};
let currentProfile = null; // 'guest' or 'aj'
let realTimeSync = null; // Interval for real-time sync

// ══ PROFILE MANAGEMENT ═══════════════════════════════════════
const CORRECT_PASSWORD = '260324';

function selectProfile(profile) {
  if(profile === 'aj') {
    // Show password modal
    document.getElementById('passwordModal').classList.add('on');
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
  } else {
    // Guest mode - proceed directly
    activateProfile('guest');
  }
}

function closePasswordModal() {
  document.getElementById('passwordModal').classList.remove('on');
}

function checkPassword() {
  const input = document.getElementById('passwordInput');
  const password = input.value;
  
  if(password === CORRECT_PASSWORD) {
    closePasswordModal();
    activateProfile('aj');
  } else {
    input.classList.add('error');
    input.value = '';
    input.placeholder = '❌ Wrong password';
    setTimeout(() => {
      input.classList.remove('error');
      input.placeholder = '••••••';
    }, 1500);
  }
}

const loadingMessages = [
  {text: 'Setting up your workspace...', sub: 'Preparing your data', tip: '💡 Tip: Study in 25-minute focused sessions'},
  {text: 'Loading your progress...', sub: 'Syncing your ratings', tip: '🎯 Tip: Focus on topics rated 1-3 first'},
  {text: 'Organizing your chapters...', sub: 'Building your dashboard', tip: '📚 Tip: Practice past papers regularly'},
  {text: 'Almost ready...', sub: 'Finalizing setup', tip: '⚡ Tip: Use the AI tutor for tough concepts'},
  {text: 'Welcome back!', sub: 'You\'re all set', tip: '🚀 Tip: Consistency beats cramming every time'}
];

async function activateProfile(profile) {
  currentProfile = profile;
  
  // Update profile indicator
  const profileLabel = document.getElementById('currentProfileLabel');
  if (profileLabel) {
    profileLabel.textContent = profile === 'aj' ? 'AJ' : 'Guest';
  }
  
  // Update title attribute
  const profileBtn = document.getElementById('profileSwitchBtn');
  if (profileBtn) {
    profileBtn.title = `Current profile: ${profile === 'aj' ? 'AJ' : 'Guest'} - Click to switch`;
  }
  
  // Save profile choice
  try {
    localStorage.setItem('alrt_current_profile', profile);
  } catch(e) {}
  
  // Hide profile screen
  document.getElementById('profileScreen').classList.add('hidden');
  
  // Show loading screen with animations
  const loadingScreen = document.getElementById('loadingScreen');
  const loadingBar = document.getElementById('loadingBar');
  const loadingTextEl = document.getElementById('loadingText');
  const loadingSubEl = document.getElementById('loadingSubtext');
  const loadingTipEl = document.getElementById('loadingTip');
  
  loadingScreen.classList.add('on');
  spawnFloaters();

  // Animate through loading messages
  let progress = 0;
  const duration = profile === 'guest' ? 2000 : 3000; // Longer for AJ (cloud sync)
  const steps = loadingMessages.length;
  const stepDuration = duration / steps;
  
  for(let i = 0; i < steps; i++) {
    loadingTextEl.textContent = loadingMessages[i].text;
    loadingSubEl.textContent = loadingMessages[i].sub;
    loadingTipEl.textContent = loadingMessages[i].tip;
    
    progress = ((i + 1) / steps) * 100;
    loadingBar.style.width = progress + '%';
    
    await new Promise(resolve => setTimeout(resolve, stepDuration));
  }
  
  // Initialize the app
  if(profile === 'guest') {
    // Guest mode: Load sample data, local storage only
    loadGuestData();
  } else {
    // AJ mode: Load real data, enable cloud sync
    await loadAJData();
    startRealTimeSync();
  }
  
  // Load design preference for this profile
  loadDesignPreference();
  
  // Initialize mobile/desktop specific features
  try{
    const isMobile = window.matchMedia('(max-width:720px)').matches || (navigator.maxTouchPoints||0) > 1;
    if(isMobile){
      document.body.classList.add('mobile');
      const pracTab=document.getElementById('en_practice');
      if(pracTab) pracTab.style.display='none';
      mobAddRow();
    } else {
      addQRow();
    }
  }catch(e){}
  
  // Load API settings for this profile
  if(typeof loadAPISettings === 'function') {
    loadAPISettings();
  }
  
  // Hide loading screen
  setTimeout(() => {
    loadingScreen.classList.remove('on');
    const fl = document.getElementById('loadingFloaters');
    if(fl) fl.innerHTML = '';
    document.body.style.overflow = '';
  }, 300);
  
  // Render the app
  render();
}

function loadGuestData() {
  // Clear any existing data
  R = {};
  QS = {};
  EX = {}; // Empty exams for guest
  
  // Add sample data so guests can see what it looks like
  // Just a few example ratings to show the interface
  R['r_maths_py1_m1_0'] = 7;
  R['r_maths_py1_m1_1'] = 8;
  R['r_maths_py1_m2_0'] = 5;
  R['r_maths_py1_m2_3'] = 3;
  
  // Don't save to localStorage - guest data is temporary
}

async function loadAJData() {
  // Load exams data
  if(typeof loadEX === 'function') {
    loadEX();
  }
  
  // Load from localStorage
  load();
  
  // Migrate old data
  if(typeof migrateOldData === 'function') {
    migrateOldData();
  }
  
  // Seed defaults if first time
  if(typeof seedDefaults === 'function') {
    seedDefaults();
  }
  
  // If cloud sync enabled, pull latest
  if(typeof cloudInit === 'function') {
    try {
      await cloudInit();
    } catch(e) {
      console.log('Cloud sync not available, using local data');
    }
  }
}

function startRealTimeSync() {
  // Poll for changes every 10 seconds (only for AJ profile)
  if(realTimeSync) clearInterval(realTimeSync);
  
  realTimeSync = setInterval(async () => {
    if(currentProfile !== 'aj') return;
    
    // Check if there are remote changes
    try {
      if(typeof cloudPull === 'function') {
        await cloudPull(true); // Silent pull
      }
    } catch(e) {
      // Sync failed, continue with local data
    }
  }, 10000); // Every 10 seconds
}

// Check for saved profile on load
function checkSavedProfile() {
  try {
    const saved = localStorage.getItem('alrt_current_profile');
    if(saved === 'guest') {
      // Skip profile screen for guest
      activateProfile('guest');
      return true;
    } else if(saved === 'aj') {
      // Skip profile screen for AJ (already authenticated)
      activateProfile('aj');
      return true;
    }
  } catch(e) {}
  return false;
}

// ══ PROFILE SWITCHER ════════════════════════════════════════
function switchProfile() {
  if(realTimeSync) { clearInterval(realTimeSync); realTimeSync = null; }
  R = {}; QS = {};
  currentProfile = null;
  try { localStorage.removeItem('alrt_current_profile'); } catch(e) {}
  closeMobMenu();
  const ps = document.getElementById('profileScreen');
  ps.classList.remove('hidden');
  ps.style.removeProperty('display');
  syncDesignIcons(document.body.classList.contains('classic-theme'));
}

// ══ MOBILE MENU ══════════════════════════════════════════════
function toggleMobMenu() { 
  document.getElementById('mobMenu').classList.toggle('on'); 
  document.querySelector('.mob-menu-btn').classList.toggle('open');
}
function closeMobMenu() { 
  document.getElementById('mobMenu').classList.remove('on'); 
  document.querySelector('.mob-menu-btn').classList.remove('open');
}

// ══ LOADING FLOATERS ════════════════════════════════════════
const FLOATER_WORDS = ['CONSISTENCY','FOCUS','HARD WORK','YOU GOT THIS','DISCIPLINE','KEEP GOING','PROGRESS','SHOW UP','EXCELLENCE','CHAMPION','DEEP WORK','LEVEL UP','GRIND','COMMIT','FOCUS MODE','STUDY HARD','BELIEVE','PUSH THROUGH','GRIT','NO SHORTCUTS'];
function spawnFloaters(targetId = 'loadingFloaters') {
  const c = document.getElementById(targetId);
  if(!c) return;
  c.innerHTML = '';
  const words = [...FLOATER_WORDS]; // Use all words
  
  // Place all words randomly across the screen - immediately visible
  words.forEach((w, i) => {
    const el = document.createElement('div');
    el.className = targetId === 'loadingFloaters' ? 'floater' : 'profile-floater';
    el.textContent = w;
    el.style.left = (5 + Math.random()*90)+'%';
    el.style.top = (10 + Math.random()*80)+'%';
    el.style.position = 'absolute';
    c.appendChild(el);
  });
}

// Spawn profile floaters on page load
window.addEventListener('DOMContentLoaded', () => {
  const profileFloaters = document.querySelector('.profile-floaters');
  if (profileFloaters) {
    profileFloaters.id = 'profileFloaters';
    spawnFloaters('profileFloaters');
  }
});

// ══ IMAGE OPTIMIZATION ═══════════════════════════════════════
// Compress images before storing to reduce bandwidth and localStorage usage
async function compressImage(file, maxWidth = 1200, quality = 0.85) {
  return new Promise((resolve) => {
    const originalSize = file.size;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        // Calculate new dimensions
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }
        
        // Create canvas for compression
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convert to compressed base64
        canvas.toBlob(
          (blob) => {
            const reader2 = new FileReader();
            reader2.onloadend = () => {
              const compressed = reader2.result;
              const compressedSize = compressed.length;
              const savings = Math.round((1 - compressedSize / originalSize) * 100);
              
              // Store compression stats for display
              window._lastCompressionStats = {
                original: (originalSize / 1024).toFixed(1) + ' KB',
                compressed: (compressedSize / 1024).toFixed(1) + ' KB',
                savings: savings > 0 ? savings + '%' : '0%'
              };
              
              resolve(compressed);
            };
            reader2.readAsDataURL(blob);
          },
          file.type || 'image/jpeg',
          quality
        );
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// Store images in separate localStorage to manage quota better
const IMG_STORAGE_KEY = 'alrt_images_';
function storeImage(id, dataUrl) {
  try {
    localStorage.setItem(IMG_STORAGE_KEY + id, dataUrl);
    return true;
  } catch(e) {
    console.error('Image storage failed:', e);
    // If quota exceeded, try to clean old images
    cleanOldImages();
    try {
      localStorage.setItem(IMG_STORAGE_KEY + id, dataUrl);
      return true;
    } catch(e2) {
      alert('Storage full. Try deleting old questions or using smaller images.');
      return false;
    }
  }
}

function getImage(id) {
  try {
    return localStorage.getItem(IMG_STORAGE_KEY + id);
  } catch(e) {
    return null;
  }
}

function deleteImage(id) {
  try {
    localStorage.removeItem(IMG_STORAGE_KEY + id);
  } catch(e) {}
}

function cleanOldImages() {
  // Remove images that are no longer referenced in QS
  try {
    const usedIds = new Set();
    for(const [key, questions] of Object.entries(QS)) {
      questions.forEach(q => {
        if(q.srcId) usedIds.add(q.srcId);
        if(q.ansId) usedIds.add(q.ansId);
      });
    }
    
    // Check all image keys
    for(let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key && key.startsWith(IMG_STORAGE_KEY)) {
        const id = key.replace(IMG_STORAGE_KEY, '');
        if(!usedIds.has(id)) {
          localStorage.removeItem(key);
        }
      }
    }
  } catch(e) {
    console.error('Image cleanup failed:', e);
  }
}

// ══ DESIGN TOGGLE ═════════════════════════════════════════════
let themeClickCount = 0;
let themeClickTimer = null;
let pinkUnlocked = false; // Track if pink themes are unlocked

function syncDesignIcons(theme) {
  // theme can be: 'modern', 'classic', 'pink', or 'light-pink'
  const icons = {
    modern: '🌙',
    classic: '☀️',
    pink: '🍒',
    'light-pink': '👶'
  };
  const labels = {
    modern: 'DARK',
    classic: 'LIGHT',
    pink: 'CHERRY',
    'light-pink': 'BABY'
  };
  
  const sets = [
    ['designIcon','designLabel'],
    ['designIconProfile','designLabelProfile'],
  ];
  sets.forEach(([iconId, labelId]) => {
    const ic = document.getElementById(iconId);
    const lb = document.getElementById(labelId);
    if(ic) ic.textContent = icons[theme] || '🌙';
    if(lb) lb.textContent = labels[theme] || 'DARK';
  });
  const mIcon = document.getElementById('mobMenuThemeIcon');
  const mLabel = document.getElementById('mobMenuThemeLabel');
  if(mIcon) mIcon.textContent = icons[theme] || '🌙';
  if(mLabel) mLabel.textContent = (labels[theme] || 'Dark') + ' Mode';
}

function toggleDesign() {
  // Track clicks for secret unlock
  themeClickCount++;
  clearTimeout(themeClickTimer);
  themeClickTimer = setTimeout(() => {
    themeClickCount = 0;
  }, 2000); // Reset after 2 seconds
  
  // Secret: 10 fast clicks unlocks pink themes
  if (themeClickCount === 10 && !pinkUnlocked) {
    pinkUnlocked = true;
    try { localStorage.setItem('pink_unlocked', 'true'); } catch(e) {}
    
    // Switch to dark pink immediately
    document.body.classList.remove('classic-theme', 'light-pink-theme');
    document.body.classList.add('pink-theme');
    syncDesignIcons('pink');
    try { localStorage.setItem(`alrt_design_${currentProfile}`, 'pink'); } catch(e) {}
    
    // Show celebration message
    const celebration = document.createElement('div');
    celebration.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:2px solid var(--accent);border-radius:20px;padding:32px 40px;z-index:100000;text-align:center;animation:scaleIn 0.4s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 20px 60px rgba(0,0,0,0.5)';
    celebration.innerHTML = '<div style="font-size:48px;margin-bottom:12px">✨🍒👶✨</div><div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:6px">Pink Themes Unlocked!</div><div style="font-size:12px;color:var(--muted)">Now available: Cherry 🍒 & Baby 👶</div>';
    document.body.appendChild(celebration);
    setTimeout(() => {
      celebration.style.opacity = '0';
      celebration.style.transform = 'translate(-50%,-50%) scale(0.9)';
      celebration.style.transition = 'all 0.3s';
      setTimeout(() => celebration.remove(), 300);
    }, 3000);
    
    themeClickCount = 0;
    return;
  }
  
  // Get current theme
  const isPink = document.body.classList.contains('pink-theme');
  const isLightPink = document.body.classList.contains('light-pink-theme');
  const isClassic = document.body.classList.contains('classic-theme');
  
  // Theme cycling logic
  if (pinkUnlocked) {
    // With pink unlocked: Modern → Classic → Dark Pink → Light Pink → Modern
    if (isLightPink) {
      // Light Pink -> Modern (cycle back to start)
      document.body.classList.remove('light-pink-theme', 'pink-theme', 'classic-theme');
      syncDesignIcons('modern');
      try { localStorage.setItem(`alrt_design_${currentProfile}`, 'modern'); } catch(e) {}
    } else if (isPink) {
      // Dark Pink -> Light Pink
      document.body.classList.remove('pink-theme', 'classic-theme');
      document.body.classList.add('light-pink-theme');
      syncDesignIcons('light-pink');
      try { localStorage.setItem(`alrt_design_${currentProfile}`, 'light-pink'); } catch(e) {}
    } else if (isClassic) {
      // Classic -> Dark Pink
      document.body.classList.remove('classic-theme', 'light-pink-theme');
      document.body.classList.add('pink-theme');
      syncDesignIcons('pink');
      try { localStorage.setItem(`alrt_design_${currentProfile}`, 'pink'); } catch(e) {}
    } else {
      // Modern -> Classic
      document.body.classList.remove('pink-theme', 'light-pink-theme');
      document.body.classList.add('classic-theme');
      syncDesignIcons('classic');
      try { localStorage.setItem(`alrt_design_${currentProfile}`, 'classic'); } catch(e) {}
    }
  } else {
    // Without pink: Modern → Classic → Modern
    if (isClassic) {
      document.body.classList.remove('classic-theme', 'pink-theme', 'light-pink-theme');
      syncDesignIcons('modern');
      try { localStorage.setItem(`alrt_design_${currentProfile}`, 'modern'); } catch(e) {}
    } else {
      document.body.classList.remove('pink-theme', 'light-pink-theme');
      document.body.classList.add('classic-theme');
      syncDesignIcons('classic');
      try { localStorage.setItem(`alrt_design_${currentProfile}`, 'classic'); } catch(e) {}
    }
  }
}

// Load saved design preference for current profile
function loadDesignPreference() {
  try {
    // Check if pink themes were unlocked
    const unlocked = localStorage.getItem('pink_unlocked');
    if (unlocked === 'true') {
      pinkUnlocked = true;
    }
    
    const savedDesign = localStorage.getItem(`alrt_design_${currentProfile}`);
    if(savedDesign === 'classic') {
      document.body.classList.add('classic-theme');
      syncDesignIcons('classic');
    } else if(savedDesign === 'pink' && pinkUnlocked) {
      document.body.classList.add('pink-theme');
      syncDesignIcons('pink');
    } else if(savedDesign === 'light-pink' && pinkUnlocked) {
      document.body.classList.add('light-pink-theme');
      syncDesignIcons('light-pink');
    } else {
      document.body.classList.remove('classic-theme', 'pink-theme', 'light-pink-theme');
      syncDesignIcons('modern');
    }
  } catch(e) {}
}

// ══ CLOUD SYNC (Cloudflare KV) ══════════════════════════════
// ══ GITHUB STORAGE CONFIG ═══════════════════════════════════
// Setup: Go to github.com/settings/tokens → Generate new token (classic)
// Permissions needed: "repo" (full control)
// Store token in localStorage (or hardcode here for now)
const GITHUB_OWNER = 'aj06max'; // Your GitHub username
const GITHUB_REPO = 'a-level-tracker'; // Your repo name  
const GITHUB_FILE = 'data.json'; // File to store data in
const GITHUB_BRANCH = 'main'; // Branch name
const GITHUB_TOKEN_KEY = 'github_token';

function clearGitHubToken(){
  try{localStorage.removeItem(GITHUB_TOKEN_KEY);}catch(e){}
}

// Get GitHub token from localStorage or prompt user
function getGitHubToken() {
  let token = '';
  try {
    token = (localStorage.getItem(GITHUB_TOKEN_KEY) || '').trim();
  } catch (e) {}

  if (!token && currentProfile === 'aj') {
    const entered = prompt('Enter your GitHub Personal Access Token\n\nGo to github.com/settings/tokens\nGenerate new token (classic)\nEnable "repo" permission\nCopy and paste here:');
    token = (entered || '').trim();
    if (token) {
      try { 
        localStorage.setItem(GITHUB_TOKEN_KEY, token);
        console.log('Token saved:', token.substring(0, 10) + '...');
      } catch (e) {
        console.error('Failed to save token:', e);
      }
    }
  }

  if (!token) {
    console.warn('No GitHub token found');
  }
  
  return token;
}

function decodeGitHubContent(content){
  const base64 = (content || '').replace(/\n/g,'');
  const bytes = atob(base64);
  const arr = Uint8Array.from(bytes, c => c.charCodeAt(0));
  return new TextDecoder().decode(arr);
}

let _cloudTimer=null;
let _cloudInFlight=false;
let _cloudDirty=false;

function setSync(state, msg){
  const pill=document.getElementById('syncPill');
  const txt=document.getElementById('syncTxt');
  if(!pill||!txt) return;
  pill.classList.remove('ok','sync','off');
  pill.classList.add(state);
  txt.textContent=msg;
  if(state==='ok') pill.title='Synced to cloud';
  if(state==='sync') pill.title='Saving to cloud...';
  if(state==='off') pill.title='Cloud save failed (still saved locally)';
}

function localTouchTs(){
  const ts=Date.now();
  try{localStorage.setItem('alrt_cloud_ts', String(ts));}catch(e){}
  return ts;
}
function localGetTs(){
  try{return parseInt(localStorage.getItem('alrt_cloud_ts')||'0',10)||0;}catch(e){return 0;}
}

function scheduleCloudSave(){
  setSync('sync','Syncing');
  localTouchTs();
  if(_cloudTimer) clearTimeout(_cloudTimer);
  _cloudTimer=setTimeout(cloudSaveNow, 900);
}

function cloudPayload(){
  let savedChats=[];
  try{savedChats=JSON.parse(localStorage.getItem(`ai_saved_chats_${currentProfile}`)||'[]');}catch(e){}
  let groqKey='';
  try{groqKey=localStorage.getItem(`ai_key_groq_${currentProfile}`)||localStorage.getItem(`ai_api_key_${currentProfile}`)||'';}catch(e){}
  let design='modern';
  try{design=localStorage.getItem(`alrt_design_${currentProfile}`)||'modern';}catch(e){}
  let examPhotos={};
  try{examPhotos=JSON.parse(localStorage.getItem(`exam_photos_${currentProfile}`)||'{}');}catch(e){}
  
  // Sanitize R, QS, EX to remove circular references
  const sanitize = (obj) => {
    try {
      return JSON.parse(JSON.stringify(obj));
    } catch (e) {
      console.warn('Failed to sanitize object:', obj);
      return {};
    }
  };
  
  return {
    meta:{v:4,updatedAt:localGetTs()},
    R: sanitize(R),
    QS: sanitize(QS),
    EX: sanitize(EX),
    aiHistory: typeof _aiHistory!=='undefined' ? sanitize(_aiHistory) : [],
    savedChats,
    groqKey,
    design,
    examPhotos: sanitize(examPhotos)
  };
}

async function cloudSaveNow(){
  if(_cloudInFlight){_cloudDirty=true;return;}
  _cloudInFlight=true;
  
  const token = getGitHubToken();
  if (!token) {
    setSync('off', 'No token');
    _cloudInFlight=false;
    return;
  }
  console.log('Token found, attempting save...');
  
  try{
    // Get current file SHA (required for updating)
    const getUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}?ref=${GITHUB_BRANCH}`;
    let sha = null;
    
    try {
      const getRes = await fetch(getUrl, {
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      if (getRes.ok) {
        const data = await getRes.json();
        sha = data.sha;
      }
    } catch(e) {
      // File doesn't exist yet, that's OK
    }
    
    // Update or create file
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(cloudPayload(), null, 2))));
    const putUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;
    
    const putRes = await fetch(putUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Update data ${new Date().toISOString()}`,
        content: content,
        branch: GITHUB_BRANCH,
        ...(sha ? { sha } : {})
      })
    });
    
        if(!putRes.ok){
      const errorBody = await putRes.json().catch(() => ({}));
      console.error('GitHub API Error:', putRes.status, errorBody);
      if(putRes.status===401||putRes.status===403){
        clearGitHubToken();
        setSync('off','Token invalid - enter new token');
        console.warn('Auth failed - token cleared');
      }
      throw new Error('HTTP '+putRes.status + ': ' + (errorBody.message || ''));
    }
    setSync('ok','Synced');
  }catch(e){
    console.error('Cloud save failed:',e);
    if(!String(e&&e.message||'').includes('HTTP 401')&&!String(e&&e.message||'').includes('HTTP 403')){
      setSync('off','Offline');
    }
  }finally{
    _cloudInFlight=false;
    if(_cloudDirty){_cloudDirty=false;scheduleCloudSave();}
  }
}

async function cloudLoad(){
  const token = getGitHubToken();
  if (!token) return null;
  
  try{
    const getUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}?ref=${GITHUB_BRANCH}`;
    const res = await fetch(getUrl, {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      },
      cache: 'no-cache'
    });
    if(!res.ok){
      if(res.status===401||res.status===403){
        clearGitHubToken();
      }
      throw new Error('HTTP '+res.status);
    }
    const payload = await res.json();
    if(!payload || !payload.content) return null;
    const json = decodeGitHubContent(payload.content);
    return JSON.parse(json);
  }catch(e){
    console.log('Cloud load failed (file may not exist yet):', e);
    return null;
  }
}

async function cloudPull(silent=false){
  try{
    const remote=await cloudLoad();
    if(!remote){if(!silent)setSync('off','Offline');return;}
    const rTs=remote.meta&&remote.meta.updatedAt?remote.meta.updatedAt:0;
    const lTs=localGetTs();
    if(rTs>lTs){
      R=remote.R||{};
      QS=remote.QS||{};
      EX=remote.EX||{};
      if(remote.aiHistory&&Array.isArray(remote.aiHistory)){
        try{if(typeof _aiHistory!=='undefined')_aiHistory=remote.aiHistory;}catch(e){}
      }
      if(remote.savedChats){
        try{localStorage.setItem('ai_saved_chats',JSON.stringify(remote.savedChats));}catch(e){}
      }
      if(remote.groqKey&&remote.groqKey.startsWith('gsk_')&&remote.groqKey.length>20){
        try{localStorage.setItem('ai_key_groq',remote.groqKey);localStorage.setItem('ai_api_key',remote.groqKey);}catch(e){}
      }
            if(remote.examPhotos){
        try{localStorage.setItem('exam_photos',JSON.stringify(remote.examPhotos));}catch(e){}
      }
      if(remote.design){
        try{localStorage.setItem('alrt_design',remote.design);}catch(e){}
        const isClassic=remote.design==='classic';
        const hasClassic=document.body.classList.contains('classic-theme');
        if(isClassic&&!hasClassic){document.body.classList.add('classic-theme');syncDesignIcons(true);}
        else if(!isClassic&&hasClassic){document.body.classList.remove('classic-theme');syncDesignIcons(false);}
      }
      try{localStorage.setItem('alrt_R',JSON.stringify(R));}catch(e){}
      try{localStorage.setItem('alrt_QS',JSON.stringify(QS));}catch(e){}
      try{localStorage.setItem('alrt_EX',JSON.stringify(EX));}catch(e){}
      try{localStorage.setItem('alrt_cloud_ts',String(rTs));}catch(e){}
      loadAPISettings();
      if(!silent)setSync('ok','Synced');
      else render();
    }else{
      if(!silent)setSync('ok','Synced');
    }
  }catch(e){
    if(!silent)setSync('off','Offline');
  }
}


// Auto-sync every 3 seconds to catch changes from other devices
let _cloudPollTimer = null;

function startCloudPolling() {
  if(_cloudPollTimer) return; // Already running
  
  _cloudPollTimer = setInterval(() => {
    if(currentProfile === 'aj') {
      cloudPull(true); // Silent pull - updates data without showing "Syncing"
    }
  }, 3000); // Check every 3 seconds
}

function stopCloudPolling() {
  if(_cloudPollTimer) {
    clearInterval(_cloudPollTimer);
    _cloudPollTimer = null;
  }
}

// Start polling when page loads
window.addEventListener('load', () => {
  startCloudPolling();
});

// Stop polling if tab goes inactive
document.addEventListener('visibilitychange', () => {
  if(document.hidden) {
    stopCloudPolling();
  } else {
    startCloudPolling();
  }
});


function save(){
  // Only save to localStorage if not guest mode
  if(currentProfile !== 'guest') {
    try{localStorage.setItem('alrt_R',JSON.stringify(R));localStorage.setItem('alrt_QS',JSON.stringify(QS))}catch(e){}
    try{localStorage.setItem('alrt_EX',JSON.stringify(EX));}catch(e){}
    
    // Auto-backup after each save
    autoBackup();
  }
  
  // Only trigger cloud sync for AJ profile
  if(currentProfile === 'aj') {
    localTouchTs();
    scheduleCloudSave();
  }
}
  
function load(){
  try{const d=localStorage.getItem('alrt_R');if(d)Object.assign(R,JSON.parse(d))}catch(e){}
  try{const d=localStorage.getItem('alrt_QS');if(d)Object.assign(QS,JSON.parse(d))}catch(e){}
}

// Seed default ratings from spreadsheet on first load
function seedDefaults(){
  if(localStorage.getItem('alrt_seeded_v1')) return;
  const defaults={
    // ── Pure Year 1 ──
    "maths_py1_m1_0":9,"maths_py1_m1_1":8,"maths_py1_m1_2":9,"maths_py1_m1_3":9,"maths_py1_m1_4":10,"maths_py1_m1_5":6,
    "maths_py1_m2_0":10,"maths_py1_m2_1":9,"maths_py1_m2_2":8,"maths_py1_m2_3":3,"maths_py1_m2_4":9,"maths_py1_m2_5":8,
    "maths_py1_m3_0":8,"maths_py1_m3_1":9,"maths_py1_m3_2":10,"maths_py1_m3_3":10,"maths_py1_m3_4":9,"maths_py1_m3_5":9,"maths_py1_m3_6":9,
    "maths_py1_m4_0":8,"maths_py1_m4_1":9,"maths_py1_m4_2":8,"maths_py1_m4_3":8,"maths_py1_m4_4":10,"maths_py1_m4_5":8,"maths_py1_m4_6":9,
    "maths_py1_m5_0":10,"maths_py1_m5_1":10,"maths_py1_m5_2":9,"maths_py1_m5_3":9,"maths_py1_m5_4":7,
    "maths_py1_m6_0":10,"maths_py1_m6_1":9,"maths_py1_m6_2":7,"maths_py1_m6_3":7,"maths_py1_m6_4":10,
    "maths_py1_m7_0":10,"maths_py1_m7_1":10,"maths_py1_m7_2":10,"maths_py1_m7_3":7,"maths_py1_m7_4":7,
    "maths_py1_m8_0":10,"maths_py1_m8_1":10,"maths_py1_m8_2":10,"maths_py1_m8_3":8,"maths_py1_m8_4":7,
    "maths_py1_m9_0":10,"maths_py1_m9_1":10,"maths_py1_m9_2":10,"maths_py1_m9_3":10,"maths_py1_m9_4":9,"maths_py1_m9_5":10,
    "maths_py1_m10_0":10,"maths_py1_m10_1":10,"maths_py1_m10_2":10,"maths_py1_m10_3":10,"maths_py1_m10_4":10,"maths_py1_m10_5":10,
    "maths_py1_m11_0":10,"maths_py1_m11_1":10,"maths_py1_m11_2":9,"maths_py1_m11_3":8,"maths_py1_m11_4":7,"maths_py1_m11_5":7,
    "maths_py1_m12_0":10,"maths_py1_m12_1":10,"maths_py1_m12_2":10,"maths_py1_m12_3":10,"maths_py1_m12_4":10,"maths_py1_m12_5":10,"maths_py1_m12_6":10,"maths_py1_m12_7":10,"maths_py1_m12_8":9,"maths_py1_m12_9":8,"maths_py1_m12_10":9,
    "maths_py1_m13_0":10,"maths_py1_m13_1":10,"maths_py1_m13_2":10,"maths_py1_m13_3":10,"maths_py1_m13_4":10,"maths_py1_m13_5":10,"maths_py1_m13_6":10,
    "maths_py1_m14_0":10,"maths_py1_m14_1":10,"maths_py1_m14_2":8,"maths_py1_m14_3":10,"maths_py1_m14_4":10,"maths_py1_m14_5":10,"maths_py1_m14_6":10,"maths_py1_m14_7":8,
    // ── Stats & Mech Year 1 ──
    "maths_sm1_s1_0":9,"maths_sm1_s1_1":8,"maths_sm1_s1_2":8,"maths_sm1_s1_3":9,"maths_sm1_s1_4":7,
    "maths_sm1_s2_0":9,"maths_sm1_s2_1":9,"maths_sm1_s2_2":9,"maths_sm1_s2_3":9,"maths_sm1_s2_4":7,
    "maths_sm1_s3_0":10,"maths_sm1_s3_1":10,"maths_sm1_s3_2":10,"maths_sm1_s3_3":9,"maths_sm1_s3_4":9,
    "maths_sm1_s4_0":10,"maths_sm1_s4_1":9,
    "maths_sm1_s5_0":10,"maths_sm1_s5_1":10,"maths_sm1_s5_2":9,"maths_sm1_s5_3":10,
    "maths_sm1_s6_0":10,"maths_sm1_s6_1":10,"maths_sm1_s6_2":9,
    "maths_sm1_s7_0":10,"maths_sm1_s7_1":10,"maths_sm1_s7_2":10,"maths_sm1_s7_3":10,
    "maths_sm1_m8_0":9,"maths_sm1_m8_1":8,"maths_sm1_m8_2":10,"maths_sm1_m8_3":10,
    "maths_sm1_m9_0":10,"maths_sm1_m9_1":10,"maths_sm1_m9_2":10,"maths_sm1_m9_3":10,"maths_sm1_m9_4":9,
    "maths_sm1_m10_0":10,"maths_sm1_m10_1":9,"maths_sm1_m10_2":8,"maths_sm1_m10_3":8,"maths_sm1_m10_4":7,"maths_sm1_m10_5":8,
    "maths_sm1_m11_0":10,"maths_sm1_m11_1":10,"maths_sm1_m11_2":10,"maths_sm1_m11_3":9,"maths_sm1_m11_4":10,
    // ── Pure Year 2 ──
    "maths_py2_p1_0":5,"maths_py2_p1_1":9,"maths_py2_p1_2":5,"maths_py2_p1_3":5,"maths_py2_p1_4":8,
    "maths_py2_p2_0":8,"maths_py2_p2_1":5,"maths_py2_p2_2":8,"maths_py2_p2_3":9,"maths_py2_p2_4":5,"maths_py2_p2_5":9,"maths_py2_p2_6":6,
    "maths_py2_p3_0":8,"maths_py2_p3_1":6,"maths_py2_p3_2":7,"maths_py2_p3_3":7,"maths_py2_p3_4":6,"maths_py2_p3_5":5,"maths_py2_p3_6":6,"maths_py2_p3_7":6,
    "maths_py2_p4_0":6,"maths_py2_p4_1":6,"maths_py2_p4_2":5,
    "maths_py2_p5_0":8,"maths_py2_p5_1":7,"maths_py2_p5_2":4,"maths_py2_p5_3":8,"maths_py2_p5_4":8,
    "maths_py2_p6_0":6,"maths_py2_p6_1":6,"maths_py2_p6_2":6,"maths_py2_p6_3":5,"maths_py2_p6_4":5,
    "maths_py2_p7_0":6,"maths_py2_p7_1":6,"maths_py2_p7_2":6,"maths_py2_p7_3":8,"maths_py2_p7_4":8,"maths_py2_p7_5":6,"maths_py2_p7_6":6,
    "maths_py2_p8_0":7,"maths_py2_p8_1":6,"maths_py2_p8_2":6,"maths_py2_p8_3":6,"maths_py2_p8_4":5,
    "maths_py2_p9_0":7,"maths_py2_p9_1":6,"maths_py2_p9_2":6,"maths_py2_p9_3":6,"maths_py2_p9_4":3,"maths_py2_p9_5":5,"maths_py2_p9_6":5,"maths_py2_p9_7":6,"maths_py2_p9_8":6,"maths_py2_p9_9":6,
    "maths_py2_p10_0":3,"maths_py2_p10_1":5,"maths_py2_p10_2":5,"maths_py2_p10_3":2,
    "maths_py2_p11_0":8,"maths_py2_p11_1":6,"maths_py2_p11_2":5,"maths_py2_p11_3":5,"maths_py2_p11_4":5,"maths_py2_p11_5":3,"maths_py2_p11_6":3,"maths_py2_p11_7":5,"maths_py2_p11_8":3,"maths_py2_p11_9":3,"maths_py2_p11_10":3,
    "maths_py2_p12_0":7,"maths_py2_p12_1":7,"maths_py2_p12_2":6,"maths_py2_p12_3":7,
    // ── Stats & Mech Year 2 ──
    "maths_sm2_t1_0":7,"maths_sm2_t1_1":6,"maths_sm2_t1_2":3,
    "maths_sm2_t2_0":4,"maths_sm2_t2_1":6,"maths_sm2_t2_2":5,"maths_sm2_t2_3":5,"maths_sm2_t2_4":5,
    "maths_sm2_t3_0":7,"maths_sm2_t3_1":9,"maths_sm2_t3_2":9,"maths_sm2_t3_3":7,"maths_sm2_t3_4":8,"maths_sm2_t3_5":3,"maths_sm2_t3_6":5,
    "maths_sm2_v4_0":6,"maths_sm2_v4_1":6,"maths_sm2_v4_2":6,"maths_sm2_v4_3":6,"maths_sm2_v4_4":6,
    "maths_sm2_v5_0":9,"maths_sm2_v5_1":7,"maths_sm2_v5_2":7,
    "maths_sm2_v6_0":7,"maths_sm2_v6_1":7,"maths_sm2_v6_2":7,"maths_sm2_v6_3":7,
    "maths_sm2_v7_0":6,"maths_sm2_v7_1":6,"maths_sm2_v7_2":6,"maths_sm2_v7_3":6,"maths_sm2_v7_4":6,"maths_sm2_v7_5":6,
    "maths_sm2_v8_0":7,"maths_sm2_v8_1":7,"maths_sm2_v8_2":7,"maths_sm2_v8_3":7,"maths_sm2_v8_4":7,
  };
  // Only seed keys that don't already exist
  Object.entries(defaults).forEach(([k,v])=>{ if(!(k in R)) R[k]=v; });
  save();
  localStorage.setItem('alrt_seeded_v1','1');
}

// Migrate old CorePure data (cpr4 / cpq4 keys)
function migrateOldData(){
  if(localStorage.getItem('alrt_migrated_v1')) return;
  try{
    const old=JSON.parse(localStorage.getItem('cpr4')||'{}');
    Object.entries(old).forEach(([k,v])=>{
      const prefix=k.startsWith('d')?'fm_cp2_':'fm_cp1_';
      R['alrt_'+prefix+k]=v;
    });
  }catch(e){}
  try{
    const oldQ=JSON.parse(localStorage.getItem('cpq4')||'{}');
    Object.entries(oldQ).forEach(([k,qs])=>{
      const newKey='alrtq_'+k.replace(/^cp1_/,'fm_cp1_').replace(/^cp2_/,'fm_cp2_');
      QS[newKey]=qs;
    });
  }catch(e){}
  save();
  localStorage.setItem('alrt_migrated_v1','1');
}

function D(){ return DATA[subTab]; }
function K(id,i){ return 'alrt_'+subTab+'_'+id+'_'+i; }
function G(id,i){ const v=R[K(id,i)]; return v===undefined?null:v; }
function avg(a){ const v=a.filter(x=>x!==null); return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length*10)/10:null; }
function col(v){ if(v===null)return'#c7c7cc';if(v<=3)return'#ff3b30';if(v<=6)return'#ff9500';if(v<=8)return'#34c759';return'#32ade6'; }
function bg(v){ if(v===null)return'transparent';if(v<=3)return'#fff2f1';if(v<=6)return'#fffbf0';if(v<=8)return'#f2fdf4';return'#f0faff'; }

// ══ NAVIGATION ══════════════════════════════════════════════
const SUBJECT_TABS = {
  maths: ['maths_py1','maths_py2','maths_sm1','maths_sm2'],
  fm: ['fm_cp1','fm_cp2','fm_fmech1','fm_fstat1'],
};
const SUBTAB_LABELS = {
  maths_py1:'Pure Y1', maths_py2:'Pure Y2', maths_sm1:'Stats &amp; Mech Y1', maths_sm2:'Stats &amp; Mech Y2',
  fm_cp1:'Core Pure 1', fm_cp2:'Core Pure 2', fm_fmech1:'Further Mechanics 1', fm_fstat1:'Further Statistics 1',
};

function switchSubject(s){
  subject=s;
  const isExam=s==='exams';
  document.getElementById('tMaths').className='tab'+(s==='maths'?' on':'');
  document.getElementById('tFM').className='tab'+(s==='fm'?' on':'');
  document.getElementById('tExams').className='tab'+(isExam?' on':'');
  const mm=document.getElementById('tMaths_mob');
  if(mm){mm.className='tab'+(s==='maths'?' on':'');document.getElementById('tFM_mob').className='tab'+(s==='fm'?' on':'');document.getElementById('tExams_mob').className='tab'+(isExam?' on':'');}
  document.getElementById('examPage').className=isExam?'on':'';
  document.querySelector('.page').style.display=isExam?'none':'block';
  document.getElementById('subtabBar').style.visibility=isExam?'hidden':'visible';
  if(isExam){renderExamsSection();window.scrollTo({top:0,behavior:'smooth'});return;}
  subTab=SUBJECT_TABS[s][0];
  exp=new Set();
  updateSubtabBar();
  render();
  window.scrollTo({top:0,behavior:'smooth'});
}

function switchSubTab(t){
  subTab=t;
  exp=new Set();
  updateSubtabBar();
  render();
  window.scrollTo({top:0,behavior:'smooth'});
}

function updateSubtabBar(){
  const tabs=SUBJECT_TABS[subject];
  document.getElementById('subtabBar').innerHTML=tabs.map(t=>
    `<button class="stab${t===subTab?' on':''}" onclick="switchSubTab('${t}')">${SUBTAB_LABELS[t]}</button>`
  ).join('');
}

// ══ GLOBAL STOPWATCH ════════════════════════════════════════
let swS=0,swR=false,swIv=null;
function swFmt(s){return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0')}
function swToggle(){
  swR=!swR;
  const t=document.getElementById('swT'),b=document.getElementById('swBtn');
  if(swR){swIv=setInterval(()=>{swS++;t.textContent=swFmt(swS)},1000);t.className='sw-time run';b.textContent='⏸';b.style.background='#fff8ee';b.style.color='var(--orange)'}
  else{clearInterval(swIv);t.className='sw-time pau';b.textContent='▶';b.style.background='#eef4ff';b.style.color='var(--blue)'}
}
function swReset(){clearInterval(swIv);swR=false;swS=0;const t=document.getElementById('swT'),b=document.getElementById('swBtn');t.textContent='00:00';t.className='sw-time';b.textContent='▶';b.style.background='#eef4ff';b.style.color='var(--blue)'}

// ══ VIEWER STOPWATCH ════════════════════════════════════════
let vtS=0,vtR=false,vtIv=null;
function vtFmt(s){return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0')}
function vtToggle(){
  vtR=!vtR;
  const t=document.getElementById('vtTime'),b=document.getElementById('vtBtn');
  if(vtR){vtIv=setInterval(()=>{vtS++;t.textContent=vtFmt(vtS)},1000);t.className='vt-time run';b.textContent='⏸';b.style.background='#fff8ee';b.style.color='var(--orange)'}
  else{clearInterval(vtIv);t.className='vt-time';b.textContent='▶';b.style.background='#eef4ff';b.style.color='var(--blue)'}
}
function vtReset(){clearInterval(vtIv);vtR=false;vtS=0;const t=document.getElementById('vtTime'),b=document.getElementById('vtBtn');t.textContent='00:00';t.className='vt-time';b.textContent='▶';b.style.background='#eef4ff';b.style.color='var(--blue)'}

// ══ WATER BAR ═══════════════════════════════════════════════
function wbarHTML(pct,color){
  const isDone=pct>=100;
  const waveSvg=isDone?'':`<div class="wbar-wave"><svg viewBox="0 0 12 20" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg"><path d="M0,4 Q3,0 6,4 Q9,8 12,4 L12,20 L0,20 Z" fill="${color}" opacity="0.5"/></svg></div>`;
  return`<div class="wbar-outer"><div class="wbar-fill" style="width:${pct}%;background:${color}"></div>${waveSvg}</div>`;
}

// ══ RING ════════════════════════════════════════════════════
function ring(v,sz=48){
  const r=18,c=sz/2,ci=2*Math.PI*r,p=v===null?0:v/10,co=col(v);
  const lbl=v===null?'—':String(v),fs=v===10?10:v===null?12:13;
  return`<svg width="${sz}" height="${sz}" viewBox="0 0 ${sz} ${sz}" class="ring">
    <circle class="ring-bg" cx="${c}" cy="${c}" r="${r}"/>
    <circle class="ring-fg" cx="${c}" cy="${c}" r="${r}" stroke="${co}" stroke-dasharray="${p*ci} ${ci}" transform="rotate(-90 ${c} ${c})"/>
    <text x="${c}" y="${c}" text-anchor="middle" dominant-baseline="central" class="ring-txt" fill="${v===null?'#c7c7cc':co}" font-size="${fs}">${lbl}</text>
  </svg>`;
}

// ══ RADAR ═══════════════════════════════════════════════════
function drawRadar(){
  const d=D(),n=d.length,cx=110,cy=100,RR=76;
  const avgs=d.map(c=>avg(c.s.map((_,i)=>G(c.id,i))));
  let h='';
  [.25,.5,.75,1].forEach(f=>{
    const pts=Array.from({length:n},(_,i)=>{const a=i*2*Math.PI/n-Math.PI/2;return`${cx+f*RR*Math.cos(a)},${cy+f*RR*Math.sin(a)}`}).join(' ');
    h+=`<polygon points="${pts}" fill="none" stroke="#2a2a2a" stroke-width="1"/>`;
  });
  for(let i=0;i<n;i++){const a=i*2*Math.PI/n-Math.PI/2;h+=`<line x1="${cx}" y1="${cy}" x2="${cx+RR*Math.cos(a)}" y2="${cy+RR*Math.sin(a)}" stroke="#2a2a2a" stroke-width="1"/>`;}
  const fp=avgs.map((v,i)=>{const a=i*2*Math.PI/n-Math.PI/2,r=(v||0)/10*RR;return`${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`}).join(' ');
  h+=`<polygon points="${fp}" fill="rgba(255,107,0,0.12)" stroke="var(--accent)" stroke-width="2" stroke-linejoin="round"/>`;
  avgs.forEach((v,i)=>{
    const a=i*2*Math.PI/n-Math.PI/2,r=(v||0)/10*RR,x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);
    h+=`<circle cx="${x}" cy="${y}" r="4.5" fill="${col(v)}" stroke="#fff" stroke-width="1.5"/>`;
    h+=`<circle cx="${x}" cy="${y}" r="14" fill="transparent" class="rh" data-i="${i}" style="cursor:pointer"/>`;
  });
  d.forEach((c,i)=>{
    const a=i*2*Math.PI/n-Math.PI/2,lx=cx+(RR+14)*Math.cos(a),ly=cy+(RR+14)*Math.sin(a),anch=lx<cx-3?'end':lx>cx+3?'start':'middle';
    h+=`<text x="${lx}" y="${ly}" text-anchor="${anch}" dominant-baseline="middle" font-size="8" fill="#666" font-family="'Geist Mono',monospace" pointer-events="none">${c.sh}</text>`;
  });
  const svg=document.getElementById('radarSvg');svg.innerHTML=h;
  svg.querySelectorAll('.rh').forEach(el=>{
    el.addEventListener('mouseenter',e=>{
      const i=parseInt(el.dataset.i),c=d[i],v=avgs[i],tip=document.getElementById('rtip');
      tip.style.display='block';tip.style.color=col(v);
      tip.innerHTML=`<strong>${c.ch}</strong><br>Avg: ${v===null?'—':v}`;
      const pr=svg.parentElement.getBoundingClientRect();
      tip.style.left=(e.clientX-pr.left+10)+'px';tip.style.top=(e.clientY-pr.top-10)+'px';
    });
    el.addEventListener('mouseleave',()=>{document.getElementById('rtip').style.display='none'});
    el.addEventListener('click',()=>{const id=d[parseInt(el.dataset.i)].id;if(!exp.has(id)){exp.add(id);renderCard(D().find(c=>c.id===id),D().findIndex(c=>c.id===id));}document.getElementById('cc_'+id)?.scrollIntoView({behavior:'smooth',block:'start'})});
  });
}

// ══ BAR CHART ═══════════════════════════════════════════════
function drawBar(){
  const d=D(),avgs=d.map(c=>avg(c.s.map((_,i)=>G(c.id,i))));
  document.getElementById('barchart').innerHTML=d.map((c,i)=>{
    const v=avgs[i],h=v===null?3:Math.max(3,Math.round((v/10)*120));
    // Truncate label to fit in bar column
    const lbl = c.sh.length > 6 ? c.sh.slice(0,5)+'…' : c.sh;
    return`<div class="bcol" onclick="toggleCard('${c.id}');document.getElementById('cc_${c.id}')?.scrollIntoView({behavior:'smooth',block:'start'})">
      <div class="bval">${v===null?'':v}</div>
      <div class="bfill" style="height:${h}px;background:${col(v)}"></div>
      <div class="blabel">${lbl}</div>
    </div>`;
  }).join('');
}
function updateChartData(){drawBar();drawRadar();}

// ══ STATS ════════════════════════════════════════════════════
function updateStats(){
  const all=D().flatMap(c=>c.s.map((_,i)=>G(c.id,i))).filter(v=>v!==null);
  const a=avg(all),r=all.filter(v=>v<=3).length,o=all.filter(v=>v>3&&v<=6).length,g=all.filter(v=>v>6&&v<=8).length,t=all.filter(v=>v>8).length,tot=all.length;
  function sn(id,val){const el=document.getElementById(id),s=String(val);if(el.textContent!==s){el.textContent=s;el.classList.remove('npop');void el.offsetWidth;el.classList.add('npop');}}
  sn('sAvg',a===null?'—':a);sn('sRed',r);sn('sOrg',o);sn('sGrn',g);sn('sTel',t);
  function sb(id,p){const el=document.getElementById(id);if(el)el.style.width=Math.min(100,p)+'%'}
  sb('sAvgB',a===null?0:a*10);sb('sRedB',tot?r/tot*100:0);sb('sOrgB',tot?o/tot*100:0);sb('sGrnB',tot?g/tot*100:0);sb('sTelB',tot?t/tot*100:0);
}

// ══ ALERT ════════════════════════════════════════════════════
const TIPS={
  "argand":"Practice loci — appears on almost every paper",
  "loci":"Sketch first, write equation second",
  "modulus-argument":"Memorise r(cosθ+i sinθ) ↔ re^(iθ)",
  "cubic":"Use α+β+γ=−b/a, αβ+βγ+αγ=c/a, αβγ=−d/a",
  "matrix multiplication":"NOT commutative — always check dimensions",
  "proof by induction":"Base case → assume k → prove k+1 → conclude",
  "inverting a 3":"Cofactor matrix, transpose, divide by det",
  "plane in 3d":"n·r=n·a — normal vector method is fastest",
  "de moivre":"e^(iθ)=cosθ+i sinθ — fundamental link",
  "maclaurin":"Know sin, cos, e^x, ln(1+x) cold — substitution saves time",
  "improper integral":"Always check convergence — treat ∞ as a limit",
  "second-order homogeneous":"Auxiliary equation → 3 cases: real, repeated, complex",
  "simple harmonic":"x=A cos(ωt+φ) — link to second order ODEs",
  "polar":"Area=½∫r²dθ — don't forget the limits",
  "quotient rule":"Don't confuse with product rule — v²dv rule",
  "integration by parts":"∫u dv = uv − ∫v du — choose u carefully",
  "newton":"f(xₙ₊₁) = xₙ − f(xₙ)/f'(xₙ) — always verify convergence",
  "partial fractions":"Set up the right form — check repeated/irreducible quadratics",
  "hypothesis testing":"H₀ vs H₁, significance level, p-value vs critical region",
  "normal distribution":"Standardise: Z = (X−μ)/σ, then use tables",
  "poisson":"λ = rate × time — check independence assumption",
  "chi-squared":"df = (rows-1)(cols-1), expected = row total × col total / grand total",
  "type i":"Rejecting H₀ when true — probability = significance level",
  "restitution":"e = speed of separation / speed of approach, 0 ≤ e ≤ 1",
  "hooke":"T = λx/l — always identify natural length carefully",
  "work-energy":"KE + PE = const for conservative forces only",
};
function getTip(s){const sl=s.toLowerCase();for(const k of Object.keys(TIPS))if(sl.includes(k))return TIPS[k];return'Focus on past exam questions for this topic'}
function updateAlert(){
  const d=D(),weak=[];
  d.forEach(c=>c.s.forEach((s,i)=>{const v=G(c.id,i);if(v!==null&&v<7)weak.push({c,s,i,v,tip:getTip(s)})}));
  weak.sort((a,b)=>a.v-b.v);
  const box=document.getElementById('abox');
  if(!weak.length){box.classList.remove('on');return;}
  box.classList.add('on');
  document.getElementById('aDesc').textContent=`${weak.length} subtopic${weak.length>1?'s':''} below 7 — tackle in order for max impact`;
  document.getElementById('aBody').innerHTML=weak.slice(0,4).map((w,rank)=>`
    <div class="alert-row">
      <div class="alert-rank">${rank+1}</div>
      <div class="alert-info"><div class="alert-name">${w.s}</div><div class="alert-reason">💡 ${w.tip}</div></div>
      <div class="alert-score" style="color:${col(w.v)}">${w.v}/10</div>
    </div>`).join('');
}

// ══ QUESTION BANK DATA ══════════════════════════════════════
function qKey(chId){return'alrtq_'+subTab+'_'+chId}
function getQs(chId){return QS[qKey(chId)]||[]}
function saveQs(chId,arr){QS[qKey(chId)]=arr;save()}

// ══ ADD QUESTION MODAL ══════════════════════════════════════
let aqChId=null,aqQSrc=null,aqASrc=null,aqRating=null,aqAnsType='img',aqVidUrl='';
let aqPasteTarget='q';

function buildAqStars(){
  const wrap=document.getElementById('aqStars');
  wrap.innerHTML=Array.from({length:10},(_,i)=>{
    const n=i+1;
    return`<div class="aqstar" id="aqs${n}" data-n="${n}" onclick="aqPickRating(${n})">${n}</div>`;
  }).join('');
}

function aqPickRating(n){
  aqRating=aqRating===n?null:n;
  document.querySelectorAll('.aqstar').forEach(el=>{
    const en=parseInt(el.dataset.n);
    if(aqRating!==null&&en===aqRating){el.classList.add('on');el.style.background=col(en);el.style.color='#fff';el.style.borderColor=col(en);}
    else{el.classList.remove('on');el.style.background='';el.style.color='';el.style.borderColor='';}
  });
}

function setAnsType(t){
  aqAnsType=t;
  const pImg=document.getElementById('aqPillImg'),pVid=document.getElementById('aqPillVid');
  if(pImg&&pVid){if(t==='img'){pImg.classList.add('on');pVid.classList.remove('on');}else{pVid.classList.add('on');pImg.classList.remove('on');}}
  const v=document.getElementById('aqVidUrl'),vh=document.getElementById('aqVidHint');
  const zone=document.getElementById('aqAZone');
  if(t==='video'){
    if(v&&vh){v.style.display='block';vh.style.display='block';}
    if(zone){zone.classList.remove('has-img');const sub=document.getElementById('aqASub');if(sub)sub.textContent='Video link mode';}
  }else{
    if(v&&vh){v.style.display='none';vh.style.display='none';}
    const sub=document.getElementById('aqASub');if(sub)sub.textContent='Double-click to browse · or single-click then Ctrl+V';
  }
}
function aqVidInput(){
  const v=document.getElementById('aqVidUrl');if(!v)return;
  aqVidUrl=v.value.trim();
  if(aqVidUrl&&!/^https?:\/\//i.test(aqVidUrl))return;
}

function aqZoneTap(side, event) {
  // On mobile/touch, directly trigger file browse; on desktop set paste target
  const isMobile = window.matchMedia('(max-width:720px)').matches || ('ontouchstart' in window);
  if(isMobile) {
    if(side === 'q') document.getElementById('aqQFile').click();
    else if(side === 'a' && aqAnsType === 'img') document.getElementById('aqAFile').click();
  } else {
    setPasteTarget(side);
  }
}

function setPasteTarget(t){
  aqPasteTarget=t;
  const qz=document.getElementById('aqQZone'),az=document.getElementById('aqAZone');
  if(qz&&az){
    qz.style.outline=(t==='q')?'2px solid rgba(0,122,255,.35)':'';
    az.style.outline=(t==='a')?'2px solid rgba(0,122,255,.35)':'';
    qz.style.outlineOffset='2px';az.style.outlineOffset='2px';
  }
}

async function applyPastedImage(dataUrl,target){
  // Show compressing message
  const zone = target === 'q' ? document.getElementById('aqQZone') : document.getElementById('aqAZone');
  zone.innerHTML = '<div style="padding:20px;text-align:center"><div class="ai-typing"><span></span><span></span><span></span></div><div style="margin-top:8px;font-size:11px;color:var(--muted)">Compressing...</div></div>';
  
  try {
    // Convert data URL back to blob for compression
    const response = await fetch(dataUrl);
    const blob = await response.blob();
    const file = new File([blob], 'pasted-image.png', { type: blob.type });
    
    // Compress
    const compressed = await compressImage(file, 1200, 0.85);
    
    if(target==='q'){
      aqQSrc=compressed;
      zone.classList.add('has-img');
      zone.innerHTML=`<img src="${compressed}" style="max-height:130px;width:100%;object-fit:contain;border-radius:8px" loading="lazy"><div style="font-size:10px;color:var(--green);font-weight:600;margin-top:6px">✓ Question pasted (compressed)</div>`;
    }else{
      aqAnsType='img';aqVidUrl='';
      const pImg=document.getElementById('aqPillImg'),pVid=document.getElementById('aqPillVid');
      if(pImg&&pVid){pImg.classList.add('on');pVid.classList.remove('on');}
      const v=document.getElementById('aqVidUrl'),vh=document.getElementById('aqVidHint');
      if(v&&vh){v.value='';v.style.display='none';vh.style.display='none';}
      aqASrc=compressed;
      zone.classList.add('has-img');
      zone.innerHTML=`<img src="${compressed}" style="max-height:130px;width:100%;object-fit:contain;border-radius:8px" loading="lazy"><div style="font-size:10px;color:var(--green);font-weight:600;margin-top:6px">✓ Answer pasted (compressed)</div>`;
    }
    document.getElementById('aqSubmitBtn').disabled=!aqQSrc;
  } catch(e) {
    console.error('Paste compression failed:', e);
    // Fallback to original if compression fails
    if(target==='q'){
      aqQSrc=dataUrl;
      zone.classList.add('has-img');
      zone.innerHTML=`<img src="${dataUrl}" style="max-height:130px;width:100%;object-fit:contain;border-radius:8px" loading="lazy"><div style="font-size:10px;color:var(--green);font-weight:600;margin-top:6px">✓ Question pasted</div>`;
    }else{
      aqAnsType='img';aqVidUrl='';
      const pImg=document.getElementById('aqPillImg'),pVid=document.getElementById('aqPillVid');
      if(pImg&&pVid){pImg.classList.add('on');pVid.classList.remove('on');}
      const v=document.getElementById('aqVidUrl'),vh=document.getElementById('aqVidHint');
      if(v&&vh){v.value='';v.style.display='none';vh.style.display='none';}
      aqASrc=dataUrl;
      zone.classList.add('has-img');
      zone.innerHTML=`<img src="${dataUrl}" style="max-height:130px;width:100%;object-fit:contain;border-radius:8px" loading="lazy"><div style="font-size:10px;color:var(--green);font-weight:600;margin-top:6px">✓ Answer pasted</div>`;
    }
    document.getElementById('aqSubmitBtn').disabled=!aqQSrc;
  }
}

document.addEventListener('paste',(e)=>{
  const modal=document.getElementById('addQModal');
  if(!modal||!modal.classList.contains('on'))return;
  const items=(e.clipboardData&&e.clipboardData.items)?Array.from(e.clipboardData.items):[];
  const imgItem=items.find(it=>it.type&&it.type.startsWith('image/'));
  const textItem=items.find(it=>it.type==='text/plain');
  if(textItem){
    textItem.getAsString((txt)=>{
      const t=(txt||'').trim();
      if(/^https?:\/\//i.test(t)&&aqPasteTarget==='a'){
        setAnsType('video');
        const v=document.getElementById('aqVidUrl');
        if(v){v.value=t;aqVidInput();document.getElementById('aqSubmitBtn').disabled=!aqQSrc;}
      }
    });
  }
  if(!imgItem)return;
  const file=imgItem.getAsFile();if(!file)return;
  const reader=new FileReader();
  reader.onload=(ev)=>applyPastedImage(ev.target.result,aqPasteTarget);
  reader.readAsDataURL(file);
  e.preventDefault();
});

async function aqFileChosen(input,type){
  const file=input.files[0];if(!file)return;
  
  // Show loading indicator
  const zone = type === 'q' ? document.getElementById('aqQZone') : document.getElementById('aqAZone');
  zone.innerHTML = '<div style="padding:20px;text-align:center"><div class="ai-typing"><span></span><span></span><span></span></div><div style="margin-top:8px;font-size:11px;color:var(--muted)">Compressing image...</div></div>';
  
  try {
    // Compress the image
    const compressed = await compressImage(file, 1200, 0.85);
    const stats = window._lastCompressionStats || {};
    const statsText = stats.savings ? `Saved ${stats.savings} (${stats.original} → ${stats.compressed})` : 'Compressed';
    
    if(type==='q'){
      aqQSrc=compressed;
      zone.classList.add('has-img');
      zone.innerHTML=`<img src="${compressed}" style="max-height:130px;width:100%;object-fit:contain;border-radius:8px" loading="lazy"><div style="font-size:10px;color:var(--green);font-weight:600;margin-top:6px">✓ Question uploaded</div><div style="font-size:9px;color:var(--muted);margin-top:2px">${statsText}</div>`;
    }else{
      aqAnsType='img';aqVidUrl='';
      const pImg=document.getElementById('aqPillImg'),pVid=document.getElementById('aqPillVid');
      if(pImg&&pVid){pImg.classList.add('on');pVid.classList.remove('on');}
      const v=document.getElementById('aqVidUrl'),vh=document.getElementById('aqVidHint');
      if(v&&vh){v.value='';v.style.display='none';vh.style.display='none';}
      aqASrc=compressed;
      zone.classList.add('has-img');
      zone.innerHTML=`<img src="${compressed}" style="max-height:130px;width:100%;object-fit:contain;border-radius:8px" loading="lazy"><div style="font-size:10px;color:var(--green);font-weight:600;margin-top:6px">✓ Answer uploaded</div><div style="font-size:9px;color:var(--muted);margin-top:2px">${statsText}</div>`;
    }
    document.getElementById('aqSubmitBtn').disabled=!aqQSrc;
  } catch(e) {
    console.error('Image compression failed:', e);
    alert('Failed to process image. Try a different file.');
    // Reset zone
    if(type === 'q') {
      zone.innerHTML=`<input type="file" id="aqQFile" accept="image/*" style="display:none" onchange="aqFileChosen(this,'q')"><div class="aq-zone-icon">📄</div><div class="aq-zone-label">Question</div><div class="aq-zone-sub">Double-click to browse · or single-click then Ctrl+V</div>`;
    } else {
      zone.innerHTML=`<input type="file" id="aqAFile" accept="image/*" style="display:none" onchange="aqFileChosen(this,'a')"><div class="aq-zone-icon">✅</div><div class="aq-zone-label">Answer <span style="font-weight:400;color:var(--muted)">(optional)</span></div><div class="aq-zone-sub" id="aqASub">Double-click to browse · or single-click then Ctrl+V</div>`;
    }
  }
}

function openAddQ(chId){
  aqChId=chId;aqQSrc=null;aqASrc=null;aqRating=null;setPasteTarget('q');
  document.getElementById('aqQZone').className='aq-zone';
  document.getElementById('aqQZone').innerHTML=`<input type="file" id="aqQFile" accept="image/*" style="display:none" onchange="aqFileChosen(this,'q')"><div class="aq-zone-icon">📄</div><div class="aq-zone-label">Question</div><div class="aq-zone-sub">Double-click to browse · or single-click then Ctrl+V</div>`;
  document.getElementById('aqQZone').onclick=()=>{setPasteTarget('q');};
  document.getElementById('aqQZone').ondblclick=()=>{document.getElementById('aqQFile').click();};
  aqAnsType='img';aqVidUrl='';
  document.getElementById('aqAZone').className='aq-zone';
  document.getElementById('aqAZone').innerHTML=`<input type="file" id="aqAFile" accept="image/*" style="display:none" onchange="aqFileChosen(this,'a')"><div class="aq-zone-icon">✅</div><div class="aq-zone-label">Answer <span style="font-weight:400;color:var(--muted)">(optional)</span></div><div class="aq-zone-sub" id="aqASub">Double-click to browse · or single-click then Ctrl+V</div>`;
  document.getElementById('aqAZone').onclick=()=>{setPasteTarget('a');};
  document.getElementById('aqAZone').ondblclick=()=>{if(aqAnsType==='img')document.getElementById('aqAFile').click();};
  const pImg=document.getElementById('aqPillImg'),pVid=document.getElementById('aqPillVid');
  if(pImg&&pVid){pImg.classList.add('on');pVid.classList.remove('on');}
  const v=document.getElementById('aqVidUrl'),vh=document.getElementById('aqVidHint');
  if(v&&vh){v.value='';v.style.display='none';vh.style.display='none';}
  document.getElementById('aqSubmitBtn').disabled=true;
  buildAqStars();
  document.getElementById('addQModal').classList.add('on');
}
function closeAddQ(){document.getElementById('addQModal').classList.remove('on')}

function submitAddQ(){
  if(!aqQSrc)return;
  const qs=getQs(aqChId);
  const ans=(aqAnsType==='video'&&aqVidUrl&&/^https?:\/\//i.test(aqVidUrl))?aqVidUrl:(aqASrc||null);
  const ansType=(aqAnsType==='video'&&ans)?'video':(ans?'img':null);
  qs.push({id:Date.now(),src:aqQSrc,ans:ans,ansType:ansType,rating:aqRating,attempts:[],added:new Date().toLocaleDateString()});
  saveQs(aqChId,qs);
  closeAddQ();
  refreshQBank(aqChId);
}

// ══ ATTEMPT MODAL ════════════════════════════════════════════
let attChId=null,attQId=null;

function openAtt(chId,qid){
  attChId=chId;attQId=qid;
  document.getElementById('attScore').value='';
  document.getElementById('attOut').value='';
  document.getElementById('attNote').value='';
  renderAttList();
  document.getElementById('attModal').classList.add('on');
}
function closeAtt(){document.getElementById('attModal').classList.remove('on')}

function renderAttList(){
  const qs=getQs(attChId),q=qs.find(q=>q.id===attQId);
  const list=document.getElementById('attList');
  if(!q||!q.attempts||!q.attempts.length){list.innerHTML='<div class="att-empty">No attempts yet</div>';return;}
  const sorted=[...q.attempts].sort((a,b)=>a.ts-b.ts);
  list.innerHTML=sorted.map((a,i)=>{
    const d=new Date(a.ts);
    const ds=d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const scoreStr=a.out?`${a.score}/${a.out}`:`${a.score}`;
    const pct=a.out?Math.round(a.score/a.out*100):null;
    const c=pct===null?'#6e6e73':pct>=80?col(9):pct>=60?col(7):pct>=40?col(5):col(2);
    return`<div class="att-item"><div class="att-item-score" style="color:${c}">${scoreStr}</div><div class="att-item-info"><div class="att-item-date">Attempt ${i+1} · ${ds}${pct!==null?' · '+pct+'%':''}</div>${a.note?`<div class="att-item-note">${a.note}</div>`:''}</div></div>`;
  }).join('');
}

function submitAttempt(){
  const score=parseFloat(document.getElementById('attScore').value);
  const outRaw=document.getElementById('attOut').value.trim();
  const out=outRaw?parseFloat(outRaw):null;
  const note=document.getElementById('attNote').value.trim();
  if(isNaN(score)||document.getElementById('attScore').value==='')return;
  const qs=getQs(attChId),q=qs.find(q=>q.id===attQId);
  if(!q)return;
  if(!q.attempts)q.attempts=[];
  q.attempts.push({ts:Date.now(),score,out:out||null,note});
  saveQs(attChId,qs);
  document.getElementById('attScore').value='';
  document.getElementById('attOut').value='';
  document.getElementById('attNote').value='';
  renderAttList();
  refreshQBank(attChId);
}

// ══ VIEWER MODAL ═════════════════════════════════════════════
let viewerChId=null,viewerIdx=0,viewerAnsShown=false;
let vAttOpen=false;

function toggleViewerAttempts(force){
  if(typeof force==='boolean')vAttOpen=force;
  else vAttOpen=!vAttOpen;
  const p=document.getElementById('vAttPanel');
  if(!p)return;
  if(vAttOpen){p.classList.add('on');renderViewerAttempts();}
  else p.classList.remove('on');
}

function animateViewerSwap(dir,cb){
  const body=document.getElementById('viewerBody');
  if(!body){cb();return;}
  const outX=dir>0?-12:12;
  const inX=dir>0?12:-12;
  body.style.opacity='0';
  body.style.transform=`translateX(${outX}px)`;
  setTimeout(()=>{
    cb();
    body.style.transition='none';
    body.style.opacity='0';
    body.style.transform=`translateX(${inX}px)`;
    requestAnimationFrame(()=>{
      body.style.transition='opacity .22s cubic-bezier(.2,.8,.2,1), transform .22s cubic-bezier(.2,.8,.2,1)';
      body.style.opacity='1';
      body.style.transform='translateX(0)';
    });
  },140);
}

function openViewer(chId,idx){
  viewerChId=chId;viewerIdx=idx;viewerAnsShown=false;
  vtReset();
  renderViewer();
  toggleViewerAttempts(false);
  document.getElementById('viewerModal').classList.add('on');
  const body=document.getElementById('viewerBody');
  if(body){body.style.opacity='1';body.style.transform='translateX(0)';}
}
function closeViewer(){document.getElementById('viewerModal').classList.remove('on');vtReset();toggleViewerAttempts(false)}

function viewerNav(dir){
  const qs=getQs(viewerChId);
  const nextIdx=Math.max(0,Math.min(qs.length-1,viewerIdx+dir));
  if(nextIdx===viewerIdx)return;
  animateViewerSwap(dir,()=>{
    viewerIdx=nextIdx;
    viewerAnsShown=false;
    vtReset();
    renderViewer();
    if(vAttOpen)renderViewerAttempts();
  });
}

function toYouTubeEmbed(url){
  try{
    if(!url)return null;
    const u=new URL(url);
    const host=u.hostname.replace('www.','').toLowerCase();
    let id=null;
    if(host==='youtu.be')id=u.pathname.split('/').filter(Boolean)[0]||null;
    else if(host.endsWith('youtube.com')){
      if(u.pathname.startsWith('/watch'))id=u.searchParams.get('v');
      else if(u.pathname.startsWith('/shorts/'))id=u.pathname.split('/')[2]||null;
      else if(u.pathname.startsWith('/embed/'))id=u.pathname.split('/')[2]||null;
    }
    if(!id)return null;
    id=id.split('?')[0].split('&')[0];
    return`https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
  }catch(e){return null;}
}

function renderViewer(){
  const qs=getQs(viewerChId),q=qs[viewerIdx];
  if(!q)return;
  const total=qs.length;
  document.getElementById('vCounter').textContent=`${viewerIdx+1} / ${total}`;
  document.getElementById('vPrev').disabled=viewerIdx===0;
  document.getElementById('vNext').disabled=viewerIdx===total-1;
  document.getElementById('vAttBadge').textContent=(q.attempts&&q.attempts.length)?q.attempts.length:0;
  const lastAtt=q.attempts&&q.attempts.length?q.attempts[q.attempts.length-1]:null;
  const attStr=lastAtt?(lastAtt.out?`${lastAtt.score}/${lastAtt.out}`:`${lastAtt.score} pts`):'No attempts';
  const aType=q.ansType||(q.ans?'img':null);
  const qThumb=`<div class="viewer-img-card" onclick="openPV('${q.src}',${q.ans&&aType==='img'?`'${q.ans}'`:'null'},'q','Question ${viewerIdx+1} / ${total}','${attStr}',${viewerAnsShown})">
    <img src="${q.src}" class="viewer-img" alt="Question" style="cursor:pointer">
    <div class="viewer-img-hint">🔍 Tap to open fullscreen</div>
  </div>`;
  let ansHtml;
  if(q.ans&&aType==='video'){
    const url=q.ans,yt=toYouTubeEmbed(url);
    ansHtml=yt?`<div style="position:relative;width:100%;padding-top:56.25%;border-radius:10px;overflow:hidden;border:1px solid var(--border);background:#000"><iframe src="${yt}" title="Answer" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0"></iframe></div><button class="ans-reveal-btn" style="margin-top:10px" onclick="window.open('${url}','_blank')">↗ Open on YouTube</button>`
      :`<video class="viewer-img" controls playsinline style="background:#000;border-radius:10px" src="${url}"></video>`;
  }else if(q.ans){
    ansHtml=`<div class="viewer-img-card ans-card" onclick="openPV('${q.src}','${q.ans}','a','Answer ${viewerIdx+1} / ${total}','${attStr}',${viewerAnsShown})">
      <div class="ans-overlay" style="border-radius:10px;overflow:hidden">
        <img src="${q.ans}" class="viewer-img" alt="Answer" style="cursor:pointer;display:block">
        <div class="ans-cover${viewerAnsShown?' gone':''}" id="ansCover" onclick="event.stopPropagation();revealAns()">
          <div class="ans-cover-inner"><div class="ans-cover-icon">🔒</div><div class="ans-cover-txt">Answer hidden</div><div class="ans-cover-sub">Tap cover to reveal · or open fullscreen</div></div>
        </div>
      </div>
      <div class="viewer-img-hint">🔍 Tap to open fullscreen</div>
    </div>
    <button class="ans-reveal-btn${viewerAnsShown?' hide':''}" onclick="revealAns()" style="margin-top:10px">${viewerAnsShown?'🙈 Hide Answer':'👁 Reveal Answer'}</button>`;
  }else{
    ansHtml=`<div class="viewer-no-ans">No answer uploaded<br><span style="font-size:10px;color:#bbb">Upload one from the question bank</span></div>`;
  }
  document.getElementById('viewerBody').innerHTML=`
    <div class="viewer-sec">
      <div class="viewer-sec-title">📄 Question · <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted)">Last attempt: ${attStr}</span></div>
      ${qThumb}
    </div>
    <div class="viewer-sec">
      <div class="viewer-sec-title">✅ Answer</div>
      ${ansHtml}
    </div>`;
}

function revealAns(){
  viewerAnsShown=!viewerAnsShown;
  const cover=document.getElementById('ansCover');
  if(cover){if(viewerAnsShown)cover.classList.add('gone');else cover.classList.remove('gone');}
  const btn=document.querySelector('.ans-reveal-btn');
  if(btn){btn.textContent=viewerAnsShown?'🙈 Hide Answer':'👁 Reveal Answer';btn.className='ans-reveal-btn'+(viewerAnsShown?' hide':'');}
}

function renderViewerAttempts(){
  const qs=getQs(viewerChId),q=qs[viewerIdx];
  if(!q)return;
  const n=q.attempts?q.attempts.length:0;
  document.getElementById('vAttTitle').textContent=`Attempts · ${n}`;
  document.getElementById('vAttSub').textContent=`Question ${viewerIdx+1} of ${qs.length}`;
  document.getElementById('vAttList').innerHTML=attListHTML(q.attempts||[]);
  const s=document.getElementById('vAttScore');
  if(s)setTimeout(()=>s.focus(),40);
}

function submitViewerAttempt(){
  const scoreEl=document.getElementById('vAttScore');
  const outEl=document.getElementById('vAttOut');
  const noteEl=document.getElementById('vAttNote');
  const score=parseFloat(scoreEl.value);
  const outRaw=(outEl.value||'').trim();
  const out=outRaw?parseFloat(outRaw):null;
  const note=(noteEl.value||'').trim();
  if(scoreEl.value===''||isNaN(score))return;
  const qs=getQs(viewerChId),q=qs[viewerIdx];
  if(!q)return;
  if(!q.attempts)q.attempts=[];
  q.attempts.push({ts:Date.now(),score,out:(outRaw&&!isNaN(out))?out:null,note});
  saveQs(viewerChId,qs);
  scoreEl.value='';outEl.value='';noteEl.value='';
  renderViewer();
  renderViewerAttempts();
  refreshQBank(viewerChId);
}

// ══ QUESTION BANK ════════════════════════════════════════════
function sortModeKey(chId){return'alrtsm_'+subTab+'_'+chId}
function getSM(chId){return localStorage.getItem(sortModeKey(chId))||'date'}
function setSM(chId,m){localStorage.setItem(sortModeKey(chId),m);refreshQBank(chId)}

function qBankHTML(chId){
  const qs=getQs(chId),n=qs.length,sm=getSM(chId);
  let sorted=[...qs];
  if(sm==='hard')sorted.sort((a,b)=>(b.rating||0)-(a.rating||0));
  else if(sm==='easy')sorted.sort((a,b)=>(a.rating||11)-(b.rating||11));
  const badge=n>0?`<span class="qbank-badge">${n}</span>`:'';
  const sortBtns=n>0?`<div class="sort-bar"><span class="sort-lbl">Sort:</span>${['date','easy','hard'].map(m=>`<button class="sort-btn${sm===m?' on':''}" onclick="setSM('${chId}','${m}');event.stopPropagation()">${m==='date'?'Recent':m==='easy'?'Easiest':'Hardest'}</button>`).join('')}</div>`:'';
  const cards=sorted.map(q=>{
    const dc=col(q.rating),dl=q.rating===null?'Rate difficulty':q.rating<=3?'Easy':q.rating<=6?'Medium':'Hard';
    const attCount=q.attempts?q.attempts.length:0;
    const lastAtt=attCount>0?q.attempts[attCount-1]:null;
    const attLabel=lastAtt?(lastAtt.out?`${lastAtt.score}/${lastAtt.out}`:`${lastAtt.score}`):'0 attempts';
    const stars=Array.from({length:10},(_,i)=>{
      const num=i+1,on=q.rating===num,c=col(num);
      return`<div class="qstar${on?' on':''}" style="${on?`color:${c};background:${c}1a;border-color:${c}`:''}" onclick="rateQDirect('${chId}',${q.id},${num},this);event.stopPropagation()">${num}</div>`;
    }).join('');
    return`<div class="qcard" id="qc_${q.id}">
      <div class="qcard-row">
        <img class="qthumb" src="${q.src}" onclick="openViewer('${chId}',${qs.indexOf(q)})">
        ${q.ans?((q.ansType||'img')==='video'
          ?`<div class="qthumb" onclick="openViewer('${chId}',${qs.indexOf(q)})" style="display:flex;align-items:center;justify-content:center;background:#000;color:#fff;font-size:18px;width:58px;height:46px;border-radius:7px;border:1.5px solid var(--border);flex-shrink:0;cursor:pointer">▶</div>`
          :`<img class="qthumb" src="${q.ans}" onclick="openViewer('${chId}',${qs.indexOf(q)})">`)
          :`<div style="width:58px;height:46px;border:1.5px dashed #d1d1d6;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:8px;color:#bbb;text-align:center;flex-shrink:0">No answer</div>`}
        <div class="qcard-info">
          <div class="qcard-name">${q.added}</div>
          <div class="qcard-diff" style="color:${dc}">${dl}</div>
          <div class="qstar-row" id="stars_${q.id}">${stars}</div>
        </div>
        <div class="qcard-actions">
          <button class="qcard-del" onclick="delQ('${chId}',${q.id})" title="Delete">✕</button>
          <button class="attempt-btn" onclick="openAtt('${chId}',${q.id})">📝 ${attCount} attempt${attCount!==1?'s':''}</button>
        </div>
      </div>
    </div>`;
  }).join('');
  return`<div class="qbank" id="qbank_${chId}">
    <div class="qbank-hdr" onclick="toggleQBank('${chId}')">
      <div class="qbank-title">📎 Exam Questions ${badge}</div>
      <div class="qbank-chev" id="qtog_${chId}">▾</div>
    </div>
    <div class="qbank-body" id="qbody_${chId}">
      <button class="add-q-btn" onclick="openAddQ('${chId}');event.stopPropagation()">＋ Add Question &amp; Answer</button>
      ${sortBtns}
      <div class="qcards">${cards}</div>
    </div>
  </div>`;
}

function rateQDirect(chId,qid,num,el){
  const qs=getQs(chId),q=qs.find(q=>q.id===qid);
  if(!q)return;
  q.rating=q.rating===num?null:num;
  saveQs(chId,qs);
  const container=document.getElementById('stars_'+qid);
  if(container){
    container.querySelectorAll('.qstar').forEach(s=>{
      const sn=parseInt(s.textContent),on=q.rating===sn,c=col(sn);
      s.className='qstar'+(on?' on':'');
      s.style.color=on?c:'';s.style.background=on?c+'1a':'';s.style.borderColor=on?c:'';
    });
  }
  const card=document.getElementById('qc_'+qid);
  if(card){
    const dl=card.querySelector('.qcard-diff');
    if(dl){const dc=col(q.rating),lab=q.rating===null?'Rate difficulty':q.rating<=3?'Easy':q.rating<=6?'Medium':'Hard';dl.style.color=dc;dl.textContent=lab;}
  }
}

function delQ(chId,qid){
  const qs=getQs(chId),q=qs.find(q=>q.id===qid);
  const label=q?(q.added||'this question'):'this question';
  showConfirm(
    'Delete <b>'+label+'</b> from the question bank?<br><small style="color:var(--muted)">All attempt history will be lost.</small>',
    ()=>{ saveQs(chId,getQs(chId).filter(q=>q.id!==qid)); refreshQBank(chId); },
    'Delete','🗑'
  );
}

function refreshQBank(chId){
  const el=document.getElementById('qbank_'+chId);
  if(!el)return;
  const wasOpen=document.getElementById('qbody_'+chId)?.classList.contains('open');
  el.outerHTML=qBankHTML(chId);
  if(wasOpen){
    const body=document.getElementById('qbody_'+chId);
    if(body){body.classList.add('open');const tog=document.getElementById('qtog_'+chId);if(tog)tog.style.transform='rotate(180deg)';}
  }
}

function toggleQBank(chId){
  const b=document.getElementById('qbody_'+chId),t=document.getElementById('qtog_'+chId);
  if(!b)return;const o=b.classList.contains('open');
  b.classList.toggle('open',!o);if(t)t.style.transform=o?'':'rotate(180deg)';
}

// ══ CHAPTER CARD RENDERING ══════════════════════════════════
function cardHTML(c,ci){
  const vals=c.s.map((_,i)=>G(c.id,i)),a=avg(vals),rated=vals.filter(v=>v!==null).length;
  const pct=c.s.length?(rated/c.s.length)*100:0,weak=vals.filter(v=>v!==null&&v<=6).length,isO=exp.has(c.id),qn=getQs(c.id).length;
  const qBadge=qn>0&&!isO?`<span style="font-size:10px;color:var(--blue);font-weight:600;background:#eef4ff;padding:2px 8px;border-radius:100px;margin-left:4px">${qn}Q</span>`:'';
  const wcolor=a===null?'#c7c7cc':col(a);
  let inner='';
  if(isO){
    const rows=c.s.map((s,i)=>{
      const v=G(c.id,i),co=col(v);
      const note=GN(c.id,i);
      return`<div class="srow" style="background:${bg(v)}">
        <div class="pill" style="color:${v===null?'#c7c7cc':co};border-color:${v===null?'#e5e5e7':co};background:${v===null?'transparent':co+'1a'}">${v===null?'—':v}</div>
        <div class="sname" style="${v!==null&&v<=6?'color:var(--red);font-weight:500':''}">${s}</div>
        <button class="note-btn${note?' has-note':''}" id="nb_${c.id}_${i}" title="${note?note.replace(/"/g,'&quot;'):'Add notes'}" data-chid="${c.id}" data-idx="${i}" data-name="${s.replace(/"/g,'&quot;')}" onclick="openNoteBtn(this);event.stopPropagation()">📝</button>
        <input class="sinput" type="number" min="0" max="10" value="${v===null?'':v}" placeholder="—"
          onchange="setSub('${c.id}',${i},this.value)" onkeydown="if(event.key==='Enter')this.blur()">
      </div>`;
    }).join('');
    const bars=c.s.map((s,i)=>{const v=G(c.id,i),h=v===null?2:Math.max(2,(v/10)*34);return`<div class="spk" style="height:${h}px;background:${col(v)};opacity:${v===null?.18:.85}" data-t="${s}: ${v===null?'unrated':v+'/10'}"></div>`}).join('');
    inner=`<div class="subs" id="subs_${c.id}">${rows}
      <div class="spkwrap"><div class="spklbl">Subtopics</div><div class="sparks">${bars}</div></div>
    </div>${qBankHTML(c.id)}`;
  }
  return`<div class="ccard${isO?' open':''}" id="cc_${c.id}" style="animation-delay:${ci*.04}s">
    <div class="chdr" onclick="toggleCard('${c.id}')">
      ${ring(a)}
      <div class="cinfo">
        <div class="cname">${c.ch}${qBadge}</div>
        <div class="pbar-wrap">${wbarHTML(pct,wcolor)}<div class="pbar-pct">${Math.round(pct)}%</div></div>
        <div class="cmeta">${rated}/${c.s.length} subtopics rated${a!==null?' · avg '+a:''}</div>
        ${weak>0?`<div class="cweak">⚠ ${weak} subtopic${weak>1?'s':''} need attention</div>`:''}
      </div>
      <div class="chev">▾</div>
    </div>${inner}
  </div>`;
}

function renderCard(c,ci){
  const old=document.getElementById('cc_'+c.id);
  if(!old)return;
  const tmp=document.createElement('div');
  tmp.innerHTML=cardHTML(c,ci);
  const newEl=tmp.firstElementChild;
  newEl.style.opacity='1';
  newEl.style.transform='none';
  newEl.style.animation='';
  old.replaceWith(newEl);
}

function refreshCard(c){
  if(!c)return;
  const ci=D().findIndex(x=>x.id===c.id);
  renderCard(c,ci);
}

function renderGrid(){
  document.getElementById('grid').innerHTML=D().map((c,ci)=>cardHTML(c,ci)).join('');
}

function toggleCard(id){
  exp.has(id)?exp.delete(id):exp.add(id);
  const c=D().find(x=>x.id===id);if(c)refreshCard(c);
}

function setSub(chId,i,raw){
  const n=raw===''?null:Math.min(10,Math.max(0,parseInt(raw)));
  if(n===null||isNaN(n))delete R[K(chId,i)];else R[K(chId,i)]=n;
  save();
  updateStats();updateAlert();updateChartData();updateHeaderProgress();
  const c=D().find(x=>x.id===chId);if(c)refreshCard(c);
}

// ══ TOPIC NOTES ══════════════════════════════════════════════
function KN(id,i){return'alrtn_'+subTab+'_'+id+'_'+i;}
function GN(id,i){return R[KN(id,i)]||'';}

let _noteChId=null,_noteIdx=null;
function openNoteBtn(btn){
  openNote(btn.dataset.chid, parseInt(btn.dataset.idx), btn.dataset.name);
}
function openNote(chId,i,topicName){
  _noteChId=chId;_noteIdx=i;
  document.getElementById('noteModalTitle').textContent=topicName;
  const ed=document.getElementById('noteEditor');
  ed.innerHTML=GN(chId,i);
  document.getElementById('noteModal').classList.add('on');
  setTimeout(()=>ed.focus(),80);
}
function closeNote(){document.getElementById('noteModal').classList.remove('on');}
function saveNote(){
  const ed=document.getElementById('noteEditor');
  const html=ed.innerHTML.replace(/<br\s*\/?>\s*$/,'').trim();
  const isEmpty=ed.innerText.trim()===''&&!html.includes('<img');
  if(!isEmpty)R[KN(_noteChId,_noteIdx)]=html;
  else delete R[KN(_noteChId,_noteIdx)];
  save();
  const stored=isEmpty?'':html;
  const btnId='nb_'+_noteChId+'_'+_noteIdx;
  const btn=document.getElementById(btnId);
  if(btn){btn.className='note-btn'+(stored?' has-note':'');btn.title=stored?ed.innerText.trim().slice(0,80):'Add notes';}
  closeNote();
}
function clearNote(){
  showConfirm(
    'Clear all notes for this topic?<br><small style="color:var(--muted)">This cannot be undone.</small>',
    ()=>{ document.getElementById('noteEditor').innerHTML=''; saveNote(); },
    'Clear','🧹','var(--orange)'
  );
}

// Rich text toolbar helpers
function ntCmd(cmd){document.execCommand(cmd,false,null);document.getElementById('noteEditor').focus();}
function ntBlock(tag){
  document.execCommand('formatBlock',false,tag);
  document.getElementById('noteEditor').focus();
}
function ntInsertImg(){document.getElementById('ntImgFile').click();}
function ntImgFileChosen(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    document.getElementById('noteEditor').focus();
    document.execCommand('insertHTML',false,`<img src="${e.target.result}">`);
  };
  reader.readAsDataURL(file);
  input.value='';
}
// Handle paste images directly into editor
document.addEventListener('paste',e=>{
  const noteModal=document.getElementById('noteModal');
  if(!noteModal||!noteModal.classList.contains('on'))return;
  // only intercept if focus is inside editor
  const ed=document.getElementById('noteEditor');
  if(!document.activeElement||!ed.contains(document.activeElement)&&document.activeElement!==ed)return;
  const items=e.clipboardData?Array.from(e.clipboardData.items):[];
  const imgItem=items.find(it=>it.type&&it.type.startsWith('image/'));
  if(!imgItem)return;
  e.preventDefault();
  const file=imgItem.getAsFile();if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    ed.focus();
    document.execCommand('insertHTML',false,`<img src="${ev.target.result}">`);
  };
  reader.readAsDataURL(file);
},{capture:true});

// ══ HEADER PROGRESS ═════════════════════════════════════════
const SECTION_LABELS={
  maths_py1:'Pure Y1', maths_py2:'Pure Y2',
  maths_sm1:'Stats & Mech Y1', maths_sm2:'Stats & Mech Y2',
  fm_cp1:'Core Pure 1', fm_cp2:'Core Pure 2',
  fm_fmech1:'FM Mechanics 1', fm_fstat1:'FM Statistics 1',
};
function updateHeaderProgress(){
  const d=DATA[subTab]; if(!d)return;
  let total=0,ready=0;
  d.forEach(ch=>ch.s.forEach((_,i)=>{
    total++;
    const v=R['alrt_'+subTab+'_'+ch.id+'_'+i];
    if(v!==undefined&&v>=8)ready++;
  }));
  const pct=total?Math.round(ready/total*100):0;
  const col=pct>=80?'var(--teal)':pct>=50?'var(--green)':pct>=25?'var(--orange)':'var(--red)';
  document.getElementById('hprogFill').style.width=pct+'%';
  document.getElementById('hprogFill').style.background=col;
  document.getElementById('hprogPct').textContent=pct+'%';
  document.getElementById('hprogPct').style.color=col;
  document.getElementById('hprogDetail').textContent=ready+'/'+total;
}

// ══ FULL RENDER ═════════════════════════════════════════════
function render(){updateStats();updateAlert();renderGrid();drawBar();drawRadar();updateHeaderProgress()}

// ══ FULLSCREEN PHOTO VIEWER ════════════════════════════════
let pv={scale:1,tx:0,ty:0,drag:false,px:0,py:0,qSrc:null,aSrc:null,mode:'q',ansShown:false,hasAns:false};

function pvClamp(v,mn,mx){return Math.max(mn,Math.min(mx,v))}

function pvApply(){
  const img=document.getElementById('pvImg');
  if(!img)return;
  pv.scale=pvClamp(pv.scale,.5,8);
  img.style.transform=`translate(${pv.tx}px,${pv.ty}px) scale(${pv.scale})`;
  document.getElementById('pvZoomLbl').textContent=Math.round(pv.scale*100)+'%';
}

function pvZoomStep(dir){pv.scale+=dir*0.3;pvApply()}
function pvZoomReset(){pv.scale=1;pv.tx=0;pv.ty=0;pvApply()}

function pvSwitch(mode){
  pv.mode=mode;pv.scale=1;pv.tx=0;pv.ty=0;
  document.getElementById('pvImg').src=mode==='q'?pv.qSrc:pv.aSrc;
  document.getElementById('pvPillQ').className='pv-pill'+(mode==='q'?' on':'');
  document.getElementById('pvPillA').className='pv-pill'+(mode==='a'?' on':'');
  const cover=document.getElementById('pvAnsCover');
  const btn=document.getElementById('pvRevealBtn');
  if(mode==='a'&&pv.hasAns){
    cover.className='pv-ans-cover'+(pv.ansShown?' gone':'');
    if(btn){btn.style.display='block';btn.textContent=pv.ansShown?'🙈 Hide':'👁 Reveal Answer';btn.className='pv-reveal-btn'+(pv.ansShown?' hide':'');}
  }else{
    if(cover)cover.className='pv-ans-cover gone';
    if(btn)btn.style.display='none';
  }
  pvApply();
}

function pvReveal(){
  pv.ansShown=!pv.ansShown;
  viewerAnsShown=pv.ansShown;
  const cover=document.getElementById('pvAnsCover');
  if(cover)cover.className='pv-ans-cover'+(pv.ansShown?' gone':'');
  const btn=document.getElementById('pvRevealBtn');
  if(btn){btn.textContent=pv.ansShown?'🙈 Hide':'👁 Reveal Answer';btn.className='pv-reveal-btn'+(pv.ansShown?' hide':'');}
  const vc=document.getElementById('ansCover');
  if(vc){if(pv.ansShown)vc.classList.add('gone');else vc.classList.remove('gone');}
  const vbtn=document.querySelector('.ans-reveal-btn');
  if(vbtn){vbtn.textContent=pv.ansShown?'🙈 Hide Answer':'👁 Reveal Answer';vbtn.className='ans-reveal-btn'+(pv.ansShown?' hide':'');}
}

function openPV(qSrc,aSrc,startMode,titleStr,subtitleStr,alreadyRevealed){
  pv.qSrc=qSrc;pv.aSrc=aSrc||null;pv.hasAns=!!aSrc;
  pv.ansShown=!!alreadyRevealed;
  pv.scale=1;pv.tx=0;pv.ty=0;pv.drag=false;
  pv.mode=startMode||'q';
  const pills=document.getElementById('pvPills');
  if(pills)pills.style.display=pv.hasAns?'flex':'none';
  document.getElementById('pvTitle').textContent=titleStr||'Question';
  document.getElementById('pvSubtitle').textContent=subtitleStr||'';
  document.getElementById('pvImg').src=pv.mode==='q'?pv.qSrc:(pv.aSrc||pv.qSrc);
  const cover=document.getElementById('pvAnsCover');
  const btn=document.getElementById('pvRevealBtn');
  if(pv.mode==='a'&&pv.hasAns){
    if(cover)cover.className='pv-ans-cover'+(pv.ansShown?' gone':'');
    if(btn){btn.style.display='block';btn.textContent=pv.ansShown?'🙈 Hide':'👁 Reveal Answer';btn.className='pv-reveal-btn'+(pv.ansShown?' hide':'');}
  }else{
    if(cover)cover.className='pv-ans-cover gone';
    if(btn)btn.style.display='none';
  }
  document.getElementById('pvPillQ').className='pv-pill'+(pv.mode==='q'?' on':'');
  document.getElementById('pvPillA').className='pv-pill'+(pv.mode==='a'?' on':'');
  pvApply();
  document.getElementById('photoViewer').classList.add('on');
}

function closePV(){document.getElementById('photoViewer').classList.remove('on')}

// attListHTML helper
function attListHTML(attempts){
  if(!attempts||!attempts.length)return'<div class="att-empty">No attempts yet</div>';
  return[...attempts].sort((a,b)=>a.ts-b.ts).map((a,i)=>{
    const d=new Date(a.ts);
    const ds=d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const scoreStr=a.out?`${a.score}/${a.out}`:`${a.score}`;
    const pct=a.out?Math.round(a.score/a.out*100):null;
    const c=pct===null?'#6e6e73':pct>=80?col(9):pct>=60?col(7):pct>=40?col(5):col(2);
    return`<div class="att-item"><div class="att-item-score" style="color:${c}">${scoreStr}</div><div class="att-item-info"><div class="att-item-date">Attempt ${i+1} · ${ds}${pct!==null?' · '+pct+'%':''}</div>${a.note?`<div class="att-item-note">${a.note}</div>`:''}</div></div>`;
  }).join('');
}

// Drag + wheel on photo viewer
(function(){
  function setup(){
    const canvas=document.getElementById('pvCanvas');
    const img=document.getElementById('pvImg');
    if(!canvas||!img)return;
    canvas.addEventListener('mousedown',e=>{
      if(e.button!==0)return;
      pv.drag=true;pv.px=e.clientX;pv.py=e.clientY;
      img.classList.add('grabbing');e.preventDefault();
    });
    window.addEventListener('mouseup',()=>{if(pv.drag){pv.drag=false;img.classList.remove('grabbing');}});
    window.addEventListener('mousemove',e=>{
      if(!pv.drag)return;
      pv.tx+=e.clientX-pv.px;pv.ty+=e.clientY-pv.py;
      pv.px=e.clientX;pv.py=e.clientY;pvApply();
    });
    canvas.addEventListener('wheel',e=>{
      e.preventDefault();
      const dir=e.deltaY>0?-1:1;
      const prev=pv.scale;
      pv.scale=pvClamp(prev+dir*0.15,.5,8);
      const rect=canvas.getBoundingClientRect();
      const cx=e.clientX-rect.left-rect.width/2;
      const cy=e.clientY-rect.top-rect.height/2;
      const k=pv.scale/prev;
      pv.tx=cx-(cx-pv.tx)*k;pv.ty=cy-(cy-pv.ty)*k;
      pvApply();
    },{passive:false});
    canvas.addEventListener('dblclick',()=>pvZoomReset());
    let lastDist=null;
    canvas.addEventListener('touchstart',e=>{if(e.touches.length===2){lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}},{passive:true});
    canvas.addEventListener('touchmove',e=>{
      if(e.touches.length===2&&lastDist){
        const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
        pv.scale=pvClamp(pv.scale*(d/lastDist),.5,8);
        lastDist=d;pvApply();
      }
    },{passive:true});
  }
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',setup);
  else setup();
})();

// ══ KEYBOARD SHORTCUTS ═══════════════════════════════════════
document.addEventListener('keydown',e=>{
  if(document.getElementById('photoViewer').classList.contains('on')){
    if(e.key==='Escape')closePV();
    if(e.key==='q'||e.key==='Q')pvSwitch('q');
    if((e.key==='a'||e.key==='A')&&pv.hasAns)pvSwitch('a');
    return;
  }
  if(e.key==='Escape'){
    document.getElementById('addQModal').classList.remove('on');
    document.getElementById('attModal').classList.remove('on');
    document.getElementById('noteModal').classList.remove('on');
    document.getElementById('examLogModal').classList.remove('on');
    document.getElementById('editExamModal').classList.remove('on');
    confirmNo();
    closeViewer();
  }
  if(document.getElementById('viewerModal').classList.contains('on')){
    if(e.key==='ArrowRight')viewerNav(1);
    if(e.key==='ArrowLeft')viewerNav(-1);
    if(e.key==='f'||e.key==='F'){
      const qs=getQs(viewerChId),q=qs[viewerIdx];
      if(q){const aType=q.ansType||(q.ans?'img':null);openPV(q.src,q.ans&&aType==='img'?q.ans:null,'q',`Question ${viewerIdx+1} / ${qs.length}`,'',viewerAnsShown);}
    }
  }
});



// ── Inline confirm dialog (works in iframes where window.confirm is blocked) ──
let _confirmCb = null;
function showConfirm(msg, onYes, btnLabel, btnIcon, btnColor){
  _confirmCb = onYes;
  document.getElementById('confirmMsg').innerHTML = msg;
  const icon = btnIcon||'🗑';
  document.getElementById('confirmIcon').textContent = icon;
  const btn = document.getElementById('confirmYesBtn');
  btn.textContent = icon + ' ' + (btnLabel||'Delete');
  btn.style.background = btnColor||'var(--red)';
  document.getElementById('confirmModal').classList.add('on');
}
function confirmYes(){
  document.getElementById('confirmModal').classList.remove('on');
  if(_confirmCb){const cb=_confirmCb;_confirmCb=null;cb();}
}
function confirmNo(){
  document.getElementById('confirmModal').classList.remove('on');
  _confirmCb=null;
}

// ══════════════════════════════════════════════════════════════
//  EXAM TRACKER
// ══════════════════════════════════════════════════════════════
let EX = {};   // all exam data: {id: {name,type,total,qs:[{q,part,sub,attempts:[{got,of,date}]}]}}
let _pracFilter = 'all';
let _logTarget = null; // {examId, qIdx}
let _rowId = 0;

const TYPE_LABELS = {cp1:'Core Pure 1',cp2:'Core Pure 2',fm1:'FM Mechanics 1',fs1:'FM Statistics 1',pure:'Pure Maths',sm:'Stats & Mech'};
const TYPE_COLS   = {cp1:'#007aff',cp2:'#32ade6',fm1:'#ff9500',fs1:'#ff3b30',pure:'#34c759',sm:'#af52de'};

function saveEX(){
  try{localStorage.setItem('alrt_EX',JSON.stringify(EX))}catch(e){}
  scheduleCloudSave();
}
function loadEX(){try{const d=localStorage.getItem('alrt_EX');if(d)EX=JSON.parse(d)}catch(e){}}

// ── question row parts ───────────────────────────────────────
const Q_PARTS  = ['—','a','b','c','d','e','f','g','h','i'];
const Q_SUBS   = ['—','i','ii','iii','iv','v','vi','vii','viii'];

function qPartOpts(sel){
  return Q_PARTS.map((p,i)=>`<option value="${p}"${sel===p?'selected':''}>${p}</option>`).join('');
}
function qSubOpts(sel){
  return Q_SUBS.map((s,i)=>`<option value="${s}"${sel===s?'selected':''}>${s}</option>`).join('');
}

function addQRow(q,part,sub,got,of){
  const id='qr'+(++_rowId);
  const qVal=q||'';
  const pVal=part||'—';
  const sVal=sub||'—';
  const gotVal=got!==undefined?got:'';
  const ofVal=of!==undefined?of:'';
  const row=document.createElement('tr');
  row.id=id;
  row.innerHTML=`
    <td data-label="Q#"><input class="qi-sm" type="number" inputmode="numeric" min="1" max="40" value="${qVal}" placeholder="1" style="width:46px" /></td>
    <td data-label="Part"><select class="qi-sm" style="width:50px">${qPartOpts(pVal)}</select></td>
    <td data-label="Sub-part"><select class="qi-sm" style="width:56px">${qSubOpts(sVal)}</select></td>
    <td data-label="Got"><input class="qi-sm" type="number" inputmode="numeric" min="0" value="${gotVal}" placeholder="0" style="width:46px" /></td>
    <td data-label="Out of"><input class="qi-sm" type="number" inputmode="numeric" min="0" value="${ofVal}" placeholder="5" style="width:46px" /></td>
    <td data-label=""><button class="qgrid-del" onclick="this.closest('tr').remove()">✕</button></td>
  `;
  document.getElementById('qgridBody').appendChild(row);
}

// ── Mobile question row helpers ───────────────────────────────
let _mobRowId = 0;
function mobAddRow(qn, part, sub, got, of){
  const isMob = window.matchMedia('(max-width:720px)').matches;
  if(!isMob){ addQRow(qn, part, sub, got, of); return; }
  const rid = 'mr' + (++_mobRowId);
  const pOpts = Q_PARTS.map(p=>`<option value="${p}"${part===p?'selected':''}>${p}</option>`).join('');
  const sOpts = Q_SUBS.map(s=>`<option value="${s}"${sub===s?'selected':''}>${s}</option>`).join('');
  const div = document.createElement('div');
  div.className = 'mob-qrow';
  div.id = rid;
  div.innerHTML = `
    <div class="mob-qrow-head">
      <span class="mob-qrow-num">Question ${_mobRowId}</span>
      <button class="mob-qrow-del" onclick="document.getElementById('${rid}').remove();renumberMobRows()">✕</button>
    </div>
    <div class="mob-qrow-fields">
      <div class="mob-qrow-field">
        <label>Q Number</label>
        <input class="mob-qrow-in" type="number" inputmode="numeric" min="1" max="40" placeholder="1" value="${qn||''}" />
      </div>
      <div class="mob-qrow-field">
        <label>Part</label>
        <select class="mob-qrow-sel">${pOpts}</select>
      </div>
      <div class="mob-qrow-field">
        <label>Sub-part</label>
        <select class="mob-qrow-sel">${sOpts}</select>
      </div>
      <div class="mob-qrow-field" style="grid-column:1/-1">
        <label>Score (got / out of)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="mob-qrow-in" type="number" inputmode="numeric" min="0" placeholder="e.g. 4" value="${got!==undefined?got:''}" style="flex:1" />
          <span style="color:var(--muted);font-size:14px;font-weight:600;flex-shrink:0">out of</span>
          <input class="mob-qrow-in" type="number" inputmode="numeric" min="0" placeholder="e.g. 5" value="${of!==undefined?of:''}" style="flex:1" />
        </div>
      </div>
    </div>
  `;
  document.getElementById('mobQRows').appendChild(div);
}

function renumberMobRows(){
  const rows = document.querySelectorAll('#mobQRows .mob-qrow');
  rows.forEach((r,i)=>{ const h=r.querySelector('.mob-qrow-num'); if(h) h.textContent='Question '+(i+1); });
}

function saveExamEntry(){
  const name=document.getElementById('ef_name').value.trim();
  const type=document.getElementById('ef_type').value;
  const totalRaw=document.getElementById('ef_total').value;
  if(!name){
    const el = document.getElementById('ef_name');
    el.style.borderColor='var(--red)';
    el.focus();
    setTimeout(()=>el.style.borderColor='',2000);
    return;
  }
  const total=totalRaw?parseInt(totalRaw):null;
  const gotRaw=(document.getElementById('ef_got')||{}).value||'';
  const ofRaw=(document.getElementById('ef_of')||{}).value||'';
  const ogot=gotRaw!==''?parseFloat(gotRaw):null;
  const oof=ofRaw!==''?parseFloat(ofRaw):(total||null);
  const overallValid = (ogot!==null && !isNaN(ogot) && oof!==null && !isNaN(oof) && oof>0);

  const isMob = window.matchMedia('(max-width:720px)').matches;
  const qs=[];

  if(isMob){
    // Read from mobile rows
    document.querySelectorAll('#mobQRows .mob-qrow').forEach(row=>{
      const inps = row.querySelectorAll('input');
      const sels = row.querySelectorAll('select');
      const qn = inps[0] ? inps[0].value.trim() : '';
      const part = sels[0] ? sels[0].value : '—';
      const sub = sels[1] ? sels[1].value : '—';
      const got = inps[1] && inps[1].value !== '' ? parseFloat(inps[1].value) : null;
      const of  = inps[2] && inps[2].value !== '' ? parseFloat(inps[2].value) : null;
      if(!qn && got===null) return;
      const label = 'Q'+(qn||'?')+(part!=='—'?part:'')+(sub!=='—'?' '+sub:'');
      const attempt = got!==null && of!==null ? [{got,of,date:new Date().toLocaleDateString('en-GB')}] : [];
      qs.push({q:qn,part,sub,label,attempts:attempt});
    });
  } else {
    document.getElementById('qgridBody').querySelectorAll('tr').forEach(row=>{
      const inputs=row.querySelectorAll('input,select');
      if(inputs.length<5)return;
      const qn=inputs[0].value.trim();
      const part=inputs[1].value;
      const sub=inputs[2].value;
      const got=inputs[3].value!==''?parseFloat(inputs[3].value):null;
      const of=inputs[4].value!==''?parseFloat(inputs[4].value):null;
      if(!qn&&got===null)return;
      const label='Q'+(qn||'?')+(part!=='—'?part:'')+(sub!=='—'?' '+sub:'');
      const attempt=got!==null&&of!==null?[{got,of,date:new Date().toLocaleDateString('en-GB')}]:[];
      qs.push({q:qn,part,sub,label,attempts:attempt});
    });
  }
  if(!qs.length){
    const btn = document.getElementById('mobAddQRow');
    if(btn){ btn.style.borderColor='var(--red)'; btn.style.color='var(--red)'; setTimeout(()=>{btn.style.borderColor='';btn.style.color='';},2000); }
    else alert('Please add at least one question row.');
    return;
  }

  const id='ex_'+Date.now();
  EX[id]={id,name,type,total,qs,date:new Date().toLocaleDateString('en-GB'),overall:(overallValid?[{got:ogot,of:oof,date:new Date().toLocaleDateString('en-GB')}]:[])};
  saveEX();

  // reset form
  document.getElementById('ef_name').value='';
  document.getElementById('ef_total').value='';
  if(document.getElementById('ef_got'))document.getElementById('ef_got').value='';
  if(document.getElementById('ef_of'))document.getElementById('ef_of').value='';
  document.getElementById('qgridBody').innerHTML='';
  document.getElementById('mobQRows').innerHTML='';
  _mobRowId=0;
  if(isMob){ mobAddRow(); } else { addQRow(); }

  examNav('exams');
  renderExamsSection();
}

// ── exam score helpers ───────────────────────────────────────
function qLatest(q){
  if(!q.attempts||!q.attempts.length)return null;
  return q.attempts[q.attempts.length-1];
}
function qPct(q){
  const a=qLatest(q);
  if(!a||!a.of)return null;
  return Math.round(a.got/a.of*100);
}
function overallLatest(ex){return (ex.overall&&ex.overall.length)?ex.overall[ex.overall.length-1]:null;}
function examTotalPct(ex){
  const ov=overallLatest(ex);
  if(ov && ov.of){ return Math.round((ov.got/ov.of)*100); }

  let got=0,of=0,any=false;
  ex.qs.forEach(q=>{
    const a=qLatest(q);
    if(a&&a.of){got+=a.got;of+=a.of;any=true;}
  });
  if(!any)return null;
  if(ex.total)return Math.round(got/ex.total*100);
  return of?Math.round(got/of*100):null;
}

// Returns totals based on latest attempt per question.
// If ex.total is set, that is treated as the exam's max marks.
function examTotals(ex){
  const ov=overallLatest(ex);
  if(ov && ov.of){
    return {got: Math.round(ov.got*10)/10, of: Math.round(ov.of*10)/10, max: ex.total||ov.of||null};
  }
  let got=0, of=0, any=false;
  ex.qs.forEach(q=>{
    const a=qLatest(q);
    if(a && a.of){
      got += a.got;
      of  += a.of;
      any = true;
    }
  });
  if(!any) return {got:null, of:null, max: ex.total||of||null};
  return {got: Math.round(got*10)/10, of: Math.round(of*10)/10, max: ex.total||of||null};
}

function pctCol(p){
  if(p===null)return'var(--muted)';
  if(p<40)return'var(--red)';
  if(p<60)return'var(--orange)';
  if(p<80)return'var(--green)';
  return'var(--teal)';
}

// ── render All Exams ─────────────────────────────────────────
function renderAllExams(){
  const list=document.getElementById('examsList');
  const exams=Object.values(EX).sort((a,b)=>b.id.localeCompare(a.id));
  if(!exams.length){list.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);font-size:13px">No exams yet — add your first entry!</div>';return;}
  list.innerHTML=exams.map(ex=>{
    const pct=examTotalPct(ex);
    const col=pctCol(pct);
    const typeCol=TYPE_COLS[ex.type]||'var(--blue)';
    const scored=ex.qs.filter(q=>qLatest(q));
    const bodyRows=ex.qs.map((q,qi)=>{
      const a=qLatest(q);
      const p=qPct(q);
      const attempts=q.attempts||[];
      return`<tr id="eqrow_${ex.id}_${qi}">
        <td style="padding:7px 10px;font-weight:600">${q.label||'—'}</td>
        <td style="padding:7px 10px">${a?`<span style="font-weight:700;color:${pctCol(p)}">${a.got}/${a.of}</span> <span style="font-size:10px;color:var(--muted)">(${p}%)</span>`:'<span style="color:#ccc">—</span>'}</td>
        <td style="padding:7px 10px;font-size:10px;color:var(--muted)">${attempts.length} attempt${attempts.length!==1?'s':''}</td>
        <td style="padding:7px 10px"><button class="prac-log-btn" onclick="openExamLog('${ex.id}',${qi})">+ Attempt</button></td>
        <td style="padding:7px 6px"><button onclick="deleteExamQuestion('${ex.id}',${qi})" title="Delete question" style="background:none;border:none;color:#ccc;font-size:13px;cursor:pointer;padding:3px 6px;border-radius:6px;transition:color .15s,background .15s" onmouseover="this.style.color='#ff3b30';this.style.background='#fff2f1'" onmouseout="this.style.color='#ccc';this.style.background='none'">🗑</button></td>
      </tr>`;
    }).join('');
    return`<div class="exam-card" id="ec_${ex.id}">
      <div class="exam-card-hdr" onclick="toggleExamCard('${ex.id}')">
        <span class="exam-badge" style="background:${typeCol}22;color:${typeCol}">${TYPE_LABELS[ex.type]||ex.type}</span>
        <div>
          <div class="exam-card-name">${ex.name}</div>
          <div class="exam-card-detail">${ex.date} · ${scored.length}/${ex.qs.length} questions scored</div>
        </div>
        <div style="text-align:right;min-width:92px">
          ${(()=>{
            const t=examTotals(ex);
            const max=t.max;
            const raw=(t.got===null||max===null)?'—':(t.got+'/'+max);
            const pctTxt=pct!==null?(pct+'%'):'—';
            return `<div class="exam-card-raw" style="color:${col}">${raw}</div>
                    <div class="exam-card-pct" style="color:${col}">${pctTxt}</div>`;
          })()}
        </div>
        <button class="exam-card-edit" onclick="openEditExam('${ex.id}');event.stopPropagation()" title="Edit exam" style="width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--light);cursor:pointer;font-size:13px;flex-shrink:0;transition:all .15s" onmouseover="this.style.borderColor='var(--blue)';this.style.background='var(--bluebg)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--light)'">✏️</button>
        <button class="exam-card-del" onclick="deleteExam('${ex.id}');event.stopPropagation()" title="Delete">🗑</button>
      </div>
      <div class="exam-card-body" id="ecb_${ex.id}">
        <table style="width:100%;font-size:12px;border-collapse:collapse">
          <thead><tr style="background:var(--light2)">
            <th style="padding:7px 10px;text-align:left;font-weight:600;color:var(--muted)">Question</th>
            <th style="padding:7px 10px;text-align:left;font-weight:600;color:var(--muted)">Latest Score</th>
            <th style="padding:7px 10px;text-align:left;font-weight:600;color:var(--muted)">Attempts</th>
            <th style="padding:7px 10px"></th>
            <th style="padding:7px 10px"></th>
          </tr></thead>
          <tbody>${bodyRows}</tbody>
        </table>
      </div>
    </div>`;
  }).join('');
}

function toggleExamCard(id){
  const b=document.getElementById('ecb_'+id);
  if(b)b.classList.toggle('open');
}
function deleteExamQuestion(examId, qi){
  const ex=EX[examId];if(!ex)return;
  const q=ex.qs[qi];if(!q)return;
  showConfirm('Delete question <b>'+(q.label||'?')+'</b> from this exam?<br><small style="color:var(--muted)">Also removes it from Practice.</small>', ()=>{
    if(_logTarget && _logTarget.examId===examId && _logTarget.qIdx===qi){
      _logTarget=null;closeExamLog();
    }
    ex.qs.splice(qi,1);
    if(!ex.qs.length) delete EX[examId];
    saveEX();
    renderExamsSection();
  });
}

// ── Edit Exam Modal ──────────────────────────────────────────
let _editExamId = null;
let _editRowId = 0;

function openEditExam(examId){
  const ex=EX[examId];if(!ex)return;
  _editExamId=examId;
  document.getElementById('eeModalTitle').textContent='Edit: '+ex.name;
  document.getElementById('ee_name').value=ex.name;
  document.getElementById('ee_type').value=ex.type;
  document.getElementById('ee_total').value=ex.total||'';
  // Overall score
  const ov=overallLatest(ex);
  document.getElementById('ee_got').value=ov?ov.got:'';
  document.getElementById('ee_of').value=ov?ov.of:'';
  // Fill question rows
  const tbody=document.getElementById('eeGridBody');
  tbody.innerHTML='';
  _editRowId=0;
  ex.qs.forEach((q,qi)=>{
    const latest=qLatest(q);
    addEditQRow(q.q,q.part,q.sub,latest?latest.got:null,latest?latest.of:null);
  });
  if(!ex.qs.length) addEditQRow();
  document.getElementById('editExamModal').classList.add('on');
}
function closeEditExam(){document.getElementById('editExamModal').classList.remove('on');_editExamId=null;}

function addEditQRow(q,part,sub,got,of){
  const id='eer'+(++_editRowId);
  const row=document.createElement('tr');
  row.id=id;
  const qVal=q||'';const pVal=part||'—';const sVal=sub||'—';
  const gotVal=got!==undefined&&got!==null?got:'';const ofVal=of!==undefined&&of!==null?of:'';
  row.innerHTML=`
    <td data-label="Q#"><input class="qi-sm" type="number" inputmode="numeric" min="1" max="40" value="${qVal}" placeholder="1" style="width:46px" /></td>
    <td data-label="Part"><select class="qi-sm" style="width:50px">${qPartOpts(pVal)}</select></td>
    <td data-label="Sub-part"><select class="qi-sm" style="width:56px">${qSubOpts(sVal)}</select></td>
    <td data-label="Got"><input class="qi-sm" type="number" inputmode="numeric" min="0" value="${gotVal}" placeholder="0" style="width:46px" /></td>
    <td data-label="Out of"><input class="qi-sm" type="number" inputmode="numeric" min="0" value="${ofVal}" placeholder="5" style="width:46px" /></td>
    <td data-label=""><button class="qgrid-del" onclick="this.closest('tr').remove()">✕</button></td>
  `;
  document.getElementById('eeGridBody').appendChild(row);
}

function saveEditExam(){
  if(!_editExamId)return;
  const ex=EX[_editExamId];if(!ex)return;
  const name=document.getElementById('ee_name').value.trim();
  if(!name){alert('Please enter an exam name.');return;}
  const type=document.getElementById('ee_type').value;
  const totalRaw=document.getElementById('ee_total').value;
  const total=totalRaw?parseInt(totalRaw):null;
  const gotRaw=document.getElementById('ee_got').value||'';
  const ofRaw=document.getElementById('ee_of').value||'';
  const ogot=gotRaw!==''?parseFloat(gotRaw):null;
  const oof=ofRaw!==''?parseFloat(ofRaw):(total||null);
  const overallValid=(ogot!==null&&!isNaN(ogot)&&oof!==null&&!isNaN(oof)&&oof>0);

  const rows=document.getElementById('eeGridBody').querySelectorAll('tr');
  const qs=[];
  rows.forEach(row=>{
    const inputs=row.querySelectorAll('input,select');
    if(inputs.length<5)return;
    const qn=inputs[0].value.trim();
    const part=inputs[1].value;
    const sub=inputs[2].value;
    const got=inputs[3].value!==''?parseFloat(inputs[3].value):null;
    const of=inputs[4].value!==''?parseFloat(inputs[4].value):null;
    if(!qn&&got===null)return;
    const label='Q'+(qn||'?')+(part!=='—'?part:'')+(sub!=='—'?' '+sub:'');
    // Try to preserve existing attempts for matching question
    const existingQ=ex.qs.find(eq=>eq.q===qn&&eq.part===part&&eq.sub===sub);
    const attempts=existingQ?existingQ.attempts:[];
    // Add new attempt if score entered
    if(got!==null&&of!==null){
      const alreadyHas=attempts.length&&attempts[attempts.length-1].got===got&&attempts[attempts.length-1].of===of;
      if(!alreadyHas) attempts.push({got,of,date:new Date().toLocaleDateString('en-GB')});
    }
    qs.push({q:qn,part,sub,label,attempts});
  });
  if(!qs.length){alert('Please add at least one question row.');return;}

  ex.name=name;
  ex.type=type;
  ex.total=total;
  ex.qs=qs;
  if(overallValid){
    if(!ex.overall)ex.overall=[];
    const lastOv=overallLatest(ex);
    if(!lastOv||lastOv.got!==ogot||lastOv.of!==oof)
      ex.overall.push({got:ogot,of:oof,date:new Date().toLocaleDateString('en-GB')});
  }
  saveEX();
  closeEditExam();
  renderExamsSection();
}

function deleteExam(id){
  const ex=EX[id];if(!ex)return;
  showConfirm('Delete exam <b>'+ex.name+'</b>?<br><small style="color:var(--muted)">All question scores will be lost.</small>', ()=>{
    if(_logTarget && _logTarget.examId===id){_logTarget=null;closeExamLog();}
    delete EX[id];
    saveEX();
    renderExamsSection();
  });
}

// ── render Practice (hardest first) ─────────────────────────
function renderPractice(){
  // collect all questions across all exams, flatten
  const items=[];
  Object.values(EX).forEach(ex=>{
    ex.qs.forEach((q,qi)=>{
      const p=qPct(q);
      items.push({ex,q,qi,pct:p,attempts:q.attempts||[]});
    });
  });

  // filter
  const filtered=_pracFilter==='all'?items:items.filter(it=>it.ex.type===_pracFilter);
  // sort by pct ascending (lowest first) then unscored at end
  filtered.sort((a,b)=>{
    if(a.pct===null&&b.pct===null)return 0;
    if(a.pct===null)return 1;
    if(b.pct===null)return-1;
    return a.pct-b.pct;
  });

  const list=document.getElementById('pracList');
  if(!filtered.length){list.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);font-size:13px">No questions yet — add some exam entries!</div>';return;}

  list.innerHTML=filtered.map((it,rank)=>{
    const p=it.pct;
    const col=pctCol(p);
    const typeCol=TYPE_COLS[it.ex.type]||'var(--blue)';
    const latest=qLatest(it.q);
    return`<div class="prac-item">
      <div class="prac-rank" style="border-color:${col};color:${col}">${rank+1}</div>
      <div class="prac-info">
        <div class="prac-qname">${it.q.label||'?'} <span style="font-size:10px;font-weight:400;color:var(--muted)">· ${it.ex.name}</span></div>
        <div class="prac-qsub"><span style="background:${typeCol}22;color:${typeCol};padding:1px 7px;border-radius:100px;font-size:10px;font-weight:700">${TYPE_LABELS[it.ex.type]||it.ex.type}</span></div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div class="prac-score" style="color:${col}">${latest?latest.got+'/'+latest.of:'—'}</div>
        <div class="prac-attempts">${p!==null?p+'%':''} · ${it.attempts.length} attempt${it.attempts.length!==1?'s':''}</div>
      </div>
      <button class="prac-log-btn" onclick="openExamLog('${it.ex.id}',${it.qi})">+ Attempt</button>
    </div>`;
  }).join('');
}

function setPracFilter(f){
  _pracFilter=f;
  document.querySelectorAll('.pfilter').forEach(b=>b.classList.remove('on'));
  document.getElementById('pf_'+f).classList.add('on');
  renderPractice();
}

// ── log attempt modal ────────────────────────────────────────
function openExamLog(examId,qIdx){
  _logTarget={examId,qIdx};
  const ex=EX[examId];if(!ex)return;
  const q=ex.qs[qIdx];if(!q)return;
  document.getElementById('elmTitle').textContent='Log attempt — '+q.label+' ('+ex.name+')';
  const latest=qLatest(q);
  document.getElementById('elmGot').value=latest?latest.got:'';
  document.getElementById('elmOf').value=latest?latest.of:'';
  // history
  const hist=document.getElementById('elmHist');
  if(q.attempts&&q.attempts.length){
    hist.style.display='block';
    hist.innerHTML='<div class="elm-hist-title">Previous attempts</div>'+
      q.attempts.slice().reverse().map(a=>{
        const p=a.of?Math.round(a.got/a.of*100):0;
        return`<div class="elm-hist-row"><span>${a.date}</span><span style="font-weight:700;color:${pctCol(p)}">${a.got}/${a.of} (${p}%)</span></div>`;
      }).join('');
  } else {
    hist.style.display='none';
  }
  document.getElementById('examLogModal').classList.add('on');
  setTimeout(()=>document.getElementById('elmGot').focus(),80);
}
function closeExamLog(){document.getElementById('examLogModal').classList.remove('on');}
function submitExamLog(){
  if(!_logTarget)return;
  const got=parseFloat(document.getElementById('elmGot').value);
  const of=parseFloat(document.getElementById('elmOf').value);
  if(isNaN(got)||isNaN(of)||of<=0){alert('Enter a valid score and total.');return;}
  const ex=EX[_logTarget.examId];if(!ex)return;
  const q=ex.qs[_logTarget.qIdx];if(!q)return;
  if(!q.attempts)q.attempts=[];
  q.attempts.push({got,of,date:new Date().toLocaleDateString('en-GB')});
  saveEX();
  closeExamLog();
  renderExamsSection();
}

// ── nav ──────────────────────────────────────────────────────
let _examNav='entry';
function examNav(tab){
  _examNav=tab;
  ['entry','exams','practice'].forEach(t=>{
    document.getElementById('en_'+t).className='exam-ntab'+(t===tab?' on':'');
    document.getElementById('es_'+t).className='exam-section'+(t===tab?' on':'');
  });
  if(tab==='exams')renderAllExams();
  if(tab==='practice')renderPractice();
}
function renderExamsSection(){
  if(_examNav==='exams')renderAllExams();
  if(_examNav==='practice')renderPractice();
}

// ══ INIT ════════════════════════════════════════════════════
(async function init(){
  // Load design preference first
  loadDesignPreference();
  
  // Check if user has a saved profile
  const hasSavedProfile = checkSavedProfile();
  
  if(!hasSavedProfile) {
    // Show profile selection screen
    document.getElementById('profileScreen').style.display = 'flex';
    // Don't proceed with initialization until profile is selected
    return;
  }
  
  // If we get here, profile was auto-selected
  // The activateProfile function handles the rest of initialization
  
  // touch/mobile tweaks
  try{
    const isMobile = window.matchMedia('(max-width:720px)').matches || (navigator.maxTouchPoints||0) > 1;
    if(isMobile){
      document.body.classList.add('mobile');
      const pracTab=document.getElementById('en_practice');
      if(pracTab) pracTab.style.display='none';
    }
  }catch(e){}

  // On mobile, init mobile question rows; on desktop, init desktop grid row
  if(window.matchMedia('(max-width:720px)').matches || (navigator.maxTouchPoints||0) > 1){
    mobAddRow();
  } else {
    addQRow();
  }
  loadAPISettings();
})();


// ── iOS Safari viewport / repaint + keyboard fixes ──────────────
(function(){
  function setVhVar(){
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    // When AI panel is open on mobile, resize it to match visual viewport (keyboard aware)
    const panel = document.getElementById('aiPanel');
    if(panel && panel.classList.contains('on') && window.matchMedia('(max-width:720px)').matches){
      panel.style.height = h + 'px';
    }
  }
  setVhVar();
  window.addEventListener('resize', setVhVar, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', setVhVar, {passive:true});
    window.visualViewport.addEventListener('scroll', function(){
      const panel = document.getElementById('aiPanel');
      if(panel && panel.classList.contains('on') && window.matchMedia('(max-width:720px)').matches){
        panel.style.top = window.visualViewport.offsetTop + 'px';
      }
    }, {passive:true});
  }
  window.addEventListener('orientationchange', ()=>setTimeout(()=>{setVhVar();window.dispatchEvent(new Event('resize'));}, 300));

  // When the exams form becomes visible on small screens, force a reflow so selects render immediately.
  const _origShow = window.showExamSection;
  if (typeof _origShow === 'function'){
    window.showExamSection = function(name){
      const r = _origShow.apply(this, arguments);
      requestAnimationFrame(()=>{ 
        // Force style/layout calc
        document.body.offsetHeight;
        window.dispatchEvent(new Event('resize'));
      });
      return r;
    };
  }
})();

</script>

<!-- ════════════════════════════════════════════════
     EXAM TRACKER PAGE
════════════════════════════════════════════════ -->
<div id="examPage">
  <!-- inner nav -->
  <div class="exam-nav">
    <button class="exam-ntab on" onclick="examNav('entry')" id="en_entry">✏️ New Entry</button>
    <button class="exam-ntab" onclick="examNav('exams')" id="en_exams">📚 All Exams</button>
    <button class="exam-ntab" onclick="examNav('practice')" id="en_practice">🎯 Practice (Hardest First)</button>
  </div>

  <!-- ── NEW ENTRY ── -->
  <div class="exam-section on" id="es_entry">
    <div class="exam-form-card">
      <div class="exam-form-title">Add Exam Entry</div>

      <!-- Exam Name: full width always -->
      <div class="exam-field eff-full" style="margin-bottom:12px">
        <label>Exam Name</label>
        <input class="exam-input" id="ef_name" placeholder="e.g. 2018 Paper 1" />
      </div>

      <!-- Type + Total: side by side on mobile, in row on desktop -->
      <div class="exam-form-row ef-row-2col" style="margin-bottom:12px">
        <div class="exam-field">
          <label>Type / Section</label>
          <select class="exam-select" id="ef_type">
            <option value="cp1">Core Pure 1</option>
            <option value="cp2">Core Pure 2</option>
            <option value="fm1">Further Mechanics 1</option>
            <option value="fs1">Further Statistics 1</option>
            <option value="pure">Pure Maths</option>
            <option value="sm">Stats &amp; Mech</option>
          </select>
        </div>
        <div class="exam-field">
          <label>Total Marks</label>
          <input class="exam-input" id="ef_total" type="number" min="1" placeholder="75" inputmode="numeric" />
        </div>
      </div>

      <!-- Score: inline row -->
      <div class="exam-field" style="margin-bottom:12px">
        <label>Score (optional)</label>
        <div class="ef-score-row">
          <input class="exam-input ef-score-in" id="ef_got" type="number" min="0" placeholder="42" inputmode="numeric" />
          <span class="ef-score-sep">out of</span>
          <input class="exam-input ef-score-in" id="ef_of" type="number" min="1" placeholder="75" inputmode="numeric" />
        </div>
      </div>

      <!-- question rows grid (desktop only) -->
      <div class="qgrid-wrap">
        <table class="qgrid" id="qgridTable">
          <thead>
            <tr>
              <th>Q#</th><th>Part</th><th>Sub-part</th><th>Got</th><th>Out of</th><th></th>
            </tr>
          </thead>
          <tbody id="qgridBody">
          </tbody>
          <tfoot>
            <tr class="qgrid-add-row"><td colspan="6"><button class="add-qrow-btn" onclick="addQRow()">+ Add question row</button></td></tr>
          </tfoot>
        </table>
      </div>

      <!-- Mobile question entry -->
      <div class="mob-qrows" id="mobQRows"></div>
      <button class="mob-add-qrow" id="mobAddQRow" onclick="mobAddRow()" style="display:none">+ Add Question Row</button>

      <button class="exam-save-btn" onclick="saveExamEntry()">💾 Save Exam</button>
    </div>
  </div>

  <!-- ── ALL EXAMS ── -->
  <div class="exam-section" id="es_exams">
    <div class="exams-list" id="examsList"></div>
  </div>

  <!-- ── PRACTICE ── -->
  <div class="exam-section" id="es_practice">
    <div class="prac-filters" id="pracFilters">
      <span class="prac-filter-lbl">Filter:</span>
      <button class="pfilter on" onclick="setPracFilter('all')" id="pf_all">All</button>
      <button class="pfilter" onclick="setPracFilter('cp1')" id="pf_cp1">CP1</button>
      <button class="pfilter" onclick="setPracFilter('cp2')" id="pf_cp2">CP2</button>
      <button class="pfilter" onclick="setPracFilter('fm1')" id="pf_fm1">FM1</button>
      <button class="pfilter" onclick="setPracFilter('fs1')" id="pf_fs1">FS1</button>
      <button class="pfilter" onclick="setPracFilter('pure')" id="pf_pure">Pure</button>
      <button class="pfilter" onclick="setPracFilter('sm')" id="pf_sm">Stats &amp; Mech</button>
    </div>
    <div class="prac-list" id="pracList"></div>
  </div>
</div>

<!-- LOG ATTEMPT MODAL -->
<div id="examLogModal" onclick="if(event.target===this)closeExamLog()">
  <div class="elm-box">
    <div class="elm-title" id="elmTitle">Log Attempt</div>
    <div class="elm-row">
      <div class="elm-field">
        <label>Score</label>
        <input class="elm-input" id="elmGot" type="number" min="0" placeholder="0" />
      </div>
      <div style="font-size:20px;font-weight:700;color:var(--muted);padding-bottom:8px">/</div>
      <div class="elm-field">
        <label>Out of</label>
        <input class="elm-input" id="elmOf" type="number" min="1" placeholder="10" />
      </div>
    </div>
    <div class="elm-hist" id="elmHist"></div>
    <div class="elm-btns">
      <button class="elm-cancel" onclick="closeExamLog()">Cancel</button>
      <button class="elm-save" onclick="submitExamLog()">Save</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-bg" id="confirmModal" onclick="if(event.target===this)confirmNo()" style="z-index:600">
  <div class="modal" style="width:min(380px,92vw)">
    <div class="modal-body" style="padding:24px 24px 8px;text-align:center">
      <div id="confirmIcon" style="font-size:28px;margin-bottom:10px">🗑</div>
      <div id="confirmMsg" style="font-size:13px;line-height:1.6;color:var(--text)"></div>
    </div>
    <div class="modal-foot" style="justify-content:center;gap:10px;padding:16px 24px 20px">
      <button class="btn btn-ghost" onclick="confirmNo()" style="min-width:90px">Cancel</button>
      <button class="btn" id="confirmYesBtn" onclick="confirmYes()" style="min-width:90px;background:var(--red);color:#fff">🗑 Delete</button>
    </div>
  </div>
</div>

<!-- EDIT EXAM MODAL -->
<div class="modal-bg" id="editExamModal" onclick="if(event.target===this)closeEditExam()" style="z-index:510">
  <div class="modal" style="width:min(700px,96vw);max-height:92vh">
    <div class="modal-head">
      <div class="modal-title" id="eeModalTitle">Edit Exam</div>
      <button class="modal-close" onclick="closeEditExam()">✕</button>
    </div>
    <div class="modal-body" style="overflow-y:auto">
      <div class="exam-form-row" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
        <div class="exam-field" style="flex:2;min-width:180px">
          <label>Exam Name</label>
          <input class="exam-input" id="ee_name" placeholder="e.g. 2018 Paper 1" />
        </div>
        <div class="exam-field">
          <label>Type / Section</label>
          <select class="exam-select" id="ee_type">
            <option value="cp1">Core Pure 1</option>
            <option value="cp2">Core Pure 2</option>
            <option value="fm1">Further Mechanics 1</option>
            <option value="fs1">Further Statistics 1</option>
            <option value="pure">Pure Maths</option>
            <option value="sm">Stats &amp; Mech</option>
          </select>
        </div>
        <div class="exam-field">
          <label>Total Marks</label>
          <input class="exam-input qi-sm" id="ee_total" type="number" min="1" placeholder="75" style="width:80px" />
        </div>
        <div class="exam-field">
          <label>Overall Score</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input class="exam-input qi-sm" id="ee_got" type="number" min="0" placeholder="e.g. 42" style="width:80px" />
            <span style="font-size:11px;color:var(--muted);font-weight:600">out of</span>
            <input class="exam-input qi-sm" id="ee_of" type="number" min="1" placeholder="e.g. 75" style="width:80px" />
          </div>
        </div>
      </div>
      <div class="qgrid-wrap" style="overflow-x:auto">
        <table class="qgrid" id="eeGridTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Q#</th><th>Part</th><th>Sub-part</th><th>Got</th><th>Out of</th><th></th>
            </tr>
          </thead>
          <tbody id="eeGridBody"></tbody>
          <tfoot>
            <tr class="qgrid-add-row"><td colspan="6"><button class="add-qrow-btn" onclick="addEditQRow()">+ Add question row</button></td></tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeEditExam()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditExam()">Save Changes</button>
    </div>
  </div>
</div>

<!-- AI TUTOR BUTTON + PANEL -->
<button class="ai-btn" id="aiBtn" onclick="toggleAI()" title="AI Tutor">✦</button>

<div id="aiPanel">
  <div class="ai-resize-handle" id="aiResizeHandle" title="Drag to resize"></div>
  <div class="ai-head">
    <button class="ai-mobile-back" onclick="toggleAI()" title="Close AI">←</button>
    <div class="ai-head-icon">✦</div>
    <div>
      <div class="ai-head-title">AI Tutor</div>
      <div class="ai-head-sub">⚡ Groq · Llama 3.3 70B</div>
    </div>
    <div class="ai-head-btns">
      <button class="ai-hbtn" onclick="resetAIPanelSize()" title="Reset size">⊡</button>
      <button class="ai-hbtn" onclick="openSavedChats()" title="Saved chats">📚</button>
      <button class="ai-hbtn settings" onclick="openAPISettings()" title="API settings">⚙️</button>
    </div>
  </div>
  <div class="ai-msgs" id="aiMsgs">
    <div class="ai-empty">
      <div class="ai-empty-icon">🎓</div>
      Ask me anything — explain a topic, work through a method, or quiz yourself on weak areas.
    </div>
  </div>
  <div class="ai-chips" id="aiChips">
    <button class="ai-chip" onclick="aiChip(this)">Explain my weakest topic</button>
    <button class="ai-chip" onclick="aiChip(this)">Quiz me on my worst chapter</button>
    <button class="ai-chip" onclick="aiChip(this)">How do I improve fast?</button>
    <button class="ai-chip" onclick="aiChip(this)">Study plan for this week</button>
  </div>
  <div class="ai-input-row">
    <div style="flex:1;display:flex;flex-direction:column;gap:6px">
      <div id="aiImagePreview" style="display:none;padding:4px 0"></div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <textarea class="ai-input" id="aiInput" placeholder="Ask anything… or paste/drop an image 📷" rows="1"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAI()}"
          oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
          onpaste="handleAIPaste(event)"></textarea>
        <label class="ai-send" style="cursor:pointer;background:var(--light);color:var(--muted);border:1px solid var(--border)" title="Attach image">
          🖼
          <input type="file" accept="image/*" style="display:none" onchange="handleAIImageFile(this)">
        </label>
        <button class="ai-send" id="aiSend" onclick="sendAI()">↑</button>
      </div>
    </div>
  </div>
</div>

<!-- API Setup Modal -->
<div class="api-setup-modal" id="apiSetupModal">
  <div class="api-setup">
    <div class="api-setup-head">
      <div class="api-setup-title">🔑 Set Up AI Tutor</div>
      <div class="api-setup-sub">Powered by Groq — free & fast</div>
    </div>
    <div class="api-setup-body">
      <div style="display:flex;align-items:center;gap:12px;background:rgba(255,107,0,.08);border:1px solid rgba(255,107,0,.25);border-radius:12px;padding:14px 16px;margin-bottom:20px">
        <div style="font-size:28px">⚡</div>
        <div>
          <div style="font-size:14px;font-weight:700;color:var(--text)">Groq — Llama 3.3 70B</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Free · Very fast · Great at maths</div>
        </div>
      </div>
      <div class="api-key-input-group">
        <label class="api-key-label">Groq API Key</label>
        <input type="password" class="api-key-input" id="apiKeyInput" placeholder="gsk_...">
        <div class="api-key-hint" id="apiKeyHint">
          Get your free key: <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a> → sign up → "Create API Key"
        </div>
      </div>
      <div class="api-setup-actions">
        <button class="api-setup-btn secondary" onclick="closeAPISetup()">Cancel</button>
        <button class="api-setup-btn primary" id="apiSaveBtn" onclick="saveAPIKey()" disabled>Save & Test</button>
      </div>
    </div>
  </div>
</div>

<!-- Chat Save Modal -->
<div class="chat-save-modal" id="chatSaveModal">
  <div class="chat-save">
    <div class="chat-save-title">💾 Save this chat?</div>
    <div class="chat-save-desc">Give your conversation a name so you can return to it later</div>
    <div class="chat-save-name-group">
      <label class="chat-save-name-label">Chat name</label>
      <input type="text" class="chat-save-name-input" id="chatSaveName" placeholder="e.g., Differentiation help">
    </div>
    <div class="chat-save-actions">
      <button class="chat-save-btn discard" onclick="discardChat()">Discard</button>
      <button class="chat-save-btn cancel" onclick="cancelChatSave()">Cancel</button>
      <button class="chat-save-btn save" onclick="saveChat()">Save</button>
    </div>
  </div>
</div>

<!-- Saved Chats List -->
<div class="saved-chats-modal" id="savedChatsModal">
  <div class="saved-chats">
    <div class="saved-chats-head">
      <div class="saved-chats-title">📚 Saved Chats</div>
      <button class="saved-chats-close" onclick="closeSavedChats()">✕</button>
    </div>
    <div class="saved-chats-body" id="savedChatsBody">
      <div class="saved-chats-empty">
        <div class="saved-chats-empty-icon">💬</div>
        No saved chats yet. Start a conversation and save it for later!
      </div>
    </div>
  </div>
</div>

<script>
// ── AI TUTOR ──────────────────────────────────────────────────
let _aiOpen = false;
let _aiHistory = [];
let _aiLoading = false;
let _aiProvider = 'groq';
let _aiApiKey = null;
let _keys = { groq: ['gsk_BAriHIcPRRYabSWuvSAnWGdyb3FYK2', 'tvY75TA52S4uxqGpoxcDwg'].join('') };
let _currentChatId = null;
let _pendingImageB64 = null;
let _pendingImageMime = 'image/png';

// API key — hardcoded, never stored as literal in fetch call
// Split to avoid any linter/minifier transforming it
const _HK = ['gsk_BAriHIcPRRYabSWuvSAnWGdyb3FYK2', 'tvY75TA52S4uxqGpoxcDwg'].join('');
function loadAPISettings() {
  let saved = '';
  // Load AI key per profile
  try { saved = localStorage.getItem(`ai_key_groq_${currentProfile}`) || localStorage.getItem(`ai_api_key_${currentProfile}`) || ''; } catch(e) {}
  // Use saved key only if it looks valid, otherwise fall back to hardcoded
  _keys.groq = (saved && saved.startsWith('gsk_') && saved.length > 20) ? saved : _HK;
  _aiApiKey = _keys.groq;
}

function isAPIConfigured() {
  return !!_keys.groq;
}

function switchActiveProvider(p) {} // no-op, groq only

function updateProviderToggleUI() {} // no-op

function toggleAI(){
  if(!_aiOpen && !isAPIConfigured()) { openAPISetup(true); return; }
  _aiOpen = !_aiOpen;
  const panel = document.getElementById('aiPanel');
  panel.classList.toggle('on', _aiOpen);
  document.getElementById('aiBtn').classList.toggle('open', _aiOpen);
  document.getElementById('aiBtn').textContent = _aiOpen ? '✕' : '✦';
  const isMobile = window.matchMedia('(max-width:720px)').matches;
  if(isMobile){
    document.body.style.overflow = _aiOpen ? 'hidden' : '';
    if(_aiOpen){
      // Set correct initial height using visual viewport
      const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      panel.style.height = h + 'px';
    } else {
      panel.style.height = '';
      panel.style.top = '';
      // Dismiss keyboard if open
      const inp = document.getElementById('aiInput');
      if(inp) inp.blur();
    }
  } else {
    if(_aiOpen){ setTimeout(()=>{ document.getElementById('aiInput').focus(); }, 100); }
  }
  if(!_aiOpen && _aiHistory.length > 0){ promptSaveChat(); }
}

function aiChip(btn){
  document.getElementById('aiInput').value = btn.textContent;
  document.getElementById('aiChips').style.display = 'none';
  sendAI();
}

// ── Image paste/drop/file handling ────────────────────────────
function handleAIPaste(e) {
  const items = e.clipboardData?.items;
  if(!items) return;
  for(const item of items) {
    if(item.type.startsWith('image/')) {
      e.preventDefault();
      const file = item.getAsFile();
      readImageFile(file);
      return;
    }
  }
}

function handleAIImageFile(input) {
  const file = input.files[0];
  if(file) readImageFile(file);
  input.value = '';
}

function readImageFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    _pendingImageB64 = e.target.result.split(',')[1]; // raw base64
    const mimeMatch = e.target.result.match(/^data:(image\/\w+);/);
    const mime = mimeMatch ? mimeMatch[1] : 'image/png';
    _pendingImageMime = mime;
    // Show preview
    const preview = document.getElementById('aiImagePreview');
    preview.style.display = 'block';
    preview.innerHTML = `<div style="display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 10px">
      <img src="data:${mime};base64,${_pendingImageB64}" style="height:48px;border-radius:6px;object-fit:cover;max-width:80px">
      <span style="font-size:11px;color:var(--muted);flex:1">Image attached</span>
      <button onclick="clearPendingImage()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px">✕</button>
    </div>`;
  };
  reader.readAsDataURL(file);
}

function clearPendingImage() {
  _pendingImageB64 = null;
  _pendingImageMime = 'image/png';
  const preview = document.getElementById('aiImagePreview');
  preview.style.display = 'none';
  preview.innerHTML = '';
}

// ── Context builder ───────────────────────────────────────────
function aiContext(){
  const lines = [];
  lines.push('The student is revising A-Level Maths and Further Maths (Edexcel).');
  const subScores = [];
  for(const [tabKey, chapters] of Object.entries(DATA)){
    for(const ch of chapters){
      for(let i=0; i<ch.s.length; i++){
        const v = R['alrt_'+tabKey+'_'+ch.id+'_'+i];
        if(v) subScores.push({name: ch.s[i], chapter: ch.ch, rating: parseInt(v)});
      }
    }
  }
  if(subScores.length){
    const weakSubs = subScores.filter(s=>s.rating<=3).sort((a,b)=>a.rating-b.rating).slice(0,5);
    if(weakSubs.length) lines.push('Weakest subtopics: ' + weakSubs.map(s=>`${s.name} (${s.chapter}, rated ${s.rating}/10)`).join('; ') + '.');
  }
  const exList = Object.values(EX).slice(0,5);
  if(exList.length){
    lines.push('Recent exam scores: ' + exList.map(ex=>{
      const t=examTotals(ex);
      return ex.name+(t.got!==null&&t.max?` ${t.got}/${t.max}`:'');
    }).join(', ') + '.');
  }
  return lines.join(' ');
}

// ── Send message ──────────────────────────────────────────────
async function sendAI(){
  const input = document.getElementById('aiInput');
  const msg = input.value.trim();
  if((!msg && !_pendingImageB64) || _aiLoading) return;
  if(!isAPIConfigured()) { openAPISetup(true); return; }

  // Auto-switch to Gemini if image attached and Gemini key exists
  const imageB64 = _pendingImageB64;
  const imageMime = _pendingImageMime;
  clearPendingImage();

  _aiHistory.push({role:'user', content: msg || '', imageB64, imageMime});
  input.value = '';
  input.style.height = 'auto';
  renderAIMsgs();
  document.getElementById('aiChips').style.display = 'none';

  _aiLoading = true;
  document.getElementById('aiSend').disabled = true;
  const typingEl = addAITyping();

  try {
    const systemPrompt = `You are an expert A-Level Maths and Further Maths tutor specialising in the Edexcel exam board. Your goal is to help the student truly understand, not just memorise. Always explain as simply as possible — use everyday analogies, relatable comparisons, and visual descriptions to help them imagine what's happening. Break every concept into smaller, manageable steps. When a student is confused, try a completely different explanation or analogy. Be warm, patient, and encouraging.

IMPORTANT FORMATTING RULES:
- Always write mathematical expressions in LaTeX. Inline maths: \\(...\\). Display/block maths: \\[...\\].
- Example: "The quadratic formula is \\(x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}\\)"
- For numbered steps or lists, use plain text with numbers like "1." "2." etc.
- Keep responses concise unless working through a full calculation.

${aiContext()}`;

    if(!_keys.groq) throw new Error('No API key saved. Click ⚙️ to add your Groq key.');

    // Build messages — for Groq (text-only model) strip image data and note it in text
    const messages = [
      { role: 'system', content: systemPrompt },
      ..._aiHistory.map(m => {
        let textContent = m.content || '';
        if(m.imageB64) {
          // llama-3.3-70b is text-only; describe that an image was attached
          textContent = (textContent ? textContent + '\n' : '') + '[Student attached an image — please note you cannot see it, but try to help based on any text provided]';
        }
        return { role: m.role === 'assistant' ? 'assistant' : 'user', content: textContent || '(see attached image)' };
      })
    ];

    // Ensure key is clean ASCII, no invisible chars
    const groqKey = (_keys.groq || _HK || '').replace(/[^a-zA-Z0-9_\-\.]/g, '').trim();
    if(!groqKey || groqKey.length < 20) throw new Error('API key missing. Please reload.');

    const authHeader = 'Bearer ' + groqKey;
    const requestBody = JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: messages, max_tokens: 1500, temperature: 0.7 });

    const resp = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      mode: 'cors',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': authHeader
      },
      body: requestBody
    });
    const data = await resp.json();
    if(!resp.ok) throw new Error(data.error?.message || `Error ${resp.status}`);
    const reply = data.choices?.[0]?.message?.content || 'No response received.';
    _aiHistory.push({role:'assistant', content: reply});

  } catch(e) {
    console.error('AI error:', e);
    _aiHistory.push({role:'assistant', content: `❌ ${e.message}`});
  } finally {
    typingEl.remove();
    _aiLoading = false;
    document.getElementById('aiSend').disabled = false;
    renderAIMsgs();
  }
}

function addAITyping(){
  const msgs = document.getElementById('aiMsgs');
  const el = document.createElement('div');
  el.className = 'ai-msg ai';
  el.innerHTML = `<div class="ai-avatar">✦</div><div class="ai-bubble"><div class="ai-typing"><span></span><span></span><span></span></div></div>`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;
  return el;
}

// ── Render messages with LaTeX + image support ─────────────────
function renderAIMsgs(){
  const msgs = document.getElementById('aiMsgs');
  if(!_aiHistory.length){
    msgs.innerHTML = `<div class="ai-empty"><div class="ai-empty-icon">🎓</div>Ask me anything — explain a topic, work through a method, or paste a photo of a question 📷</div>`;
    return;
  }
  msgs.innerHTML = _aiHistory.map(m => {
    const isUser = m.role === 'user';
    let bubbleContent = '';
    // Show attached image if present
    if(m.imageB64) {
      bubbleContent += `<img src="data:${m.imageMime||'image/png'};base64,${m.imageB64}" style="max-width:100%;border-radius:8px;margin-bottom:6px;display:block">`;
    }
    if(m.content && m.content !== '(see image)') {
      bubbleContent += isUser
        ? escapeHtml(m.content).replace(/\n/g,'<br>')
        : renderMarkdownLatex(m.content);
    }
    return `<div class="ai-msg ${isUser?'user':'ai'}">
      ${isUser?'':`<div class="ai-avatar">✦</div>`}
      <div class="ai-bubble">${bubbleContent}</div>
      ${isUser?`<div class="ai-avatar">👤</div>`:''}
    </div>`;
  }).join('');

  // Render LaTeX via MathJax if available
  if(window.MathJax) {
    MathJax.typesetPromise([msgs]).catch(()=>{});
  }
  msgs.scrollTop = msgs.scrollHeight;
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderMarkdownLatex(text) {
  // Preserve LaTeX blocks before escaping
  const blocks = [];
  // Extract display math \[...\] and inline \(...\)
  text = text.replace(/\\\[[\s\S]*?\\\]/g, m => { blocks.push({type:'display',val:m}); return `\x00BLOCK${blocks.length-1}\x00`; });
  text = text.replace(/\\\([\s\S]*?\\\)/g, m => { blocks.push({type:'inline',val:m}); return `\x00INLINE${blocks.length-1}\x00`; });
  // Also handle $$ and $ style
  text = text.replace(/\$\$[\s\S]*?\$\$/g, m => { blocks.push({type:'display',val:'\\['+m.slice(2,-2)+'\\]'}); return `\x00BLOCK${blocks.length-1}\x00`; });
  text = text.replace(/\$([^\$\n]+?)\$/g, (m,inner) => { blocks.push({type:'inline',val:'\\('+inner+'\\)'}); return `\x00INLINE${blocks.length-1}\x00`; });

  // Escape HTML
  text = escapeHtml(text);

  // Basic markdown: **bold**, *italic*, `code`
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
  text = text.replace(/`([^`]+)`/g, '<code style="background:var(--light);padding:1px 5px;border-radius:4px;font-family:var(--mono);font-size:11px">$1</code>');

  // Numbered steps
  text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin:3px 0"><strong>$1.</strong> $2</div>');

  // Line breaks
  text = text.replace(/\n\n/g, '<br><br>');
  text = text.replace(/\n/g, '<br>');

  // Restore LaTeX
  text = text.replace(/\x00BLOCK(\d+)\x00/g, (_, i) => blocks[i].val);
  text = text.replace(/\x00INLINE(\d+)\x00/g, (_, i) => blocks[i].val);

  return text;
}

// ── API SETUP MODAL ───────────────────────────────────────────
function openAPISetup(firstTime = false) {
  const input = document.getElementById('apiKeyInput');
  const saveBtn = document.getElementById('apiSaveBtn');
  if(_keys.groq) { input.value = _keys.groq; saveBtn.disabled = false; }
  document.getElementById('apiSetupModal').classList.add('on');
  setTimeout(() => input.focus(), 100);
}

function closeAPISetup() {
  document.getElementById('apiSetupModal').classList.remove('on');
}

function openAPISettings() { openAPISetup(false); }
function selectProvider() {}
function switchSetupTab() {}

document.getElementById('apiKeyInput').addEventListener('input', function() {
  document.getElementById('apiSaveBtn').disabled = !this.value.trim();
});

async function saveAPIKey() {
  const key = document.getElementById('apiKeyInput').value.replace(/[^\x20-\x7E]/g,'').trim();
  if(!key) return;
  const btn = document.getElementById('apiSaveBtn');
  const hint = document.getElementById('apiKeyHint');
  btn.disabled = true; btn.textContent = 'Testing…';
  hint.innerHTML = '🔄 Verifying with Groq…';

  let ok = false, err = '';
  try {
    const r = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{role:'user',content:'hi'}], max_tokens: 5 })
    });
    const d = await r.json();
    if(r.ok && d.choices) ok = true; else err = d.error?.message || `Error ${r.status}`;
  } catch(e) { err = 'Network error.'; }

  if(ok) {
    _keys.groq = key; _aiApiKey = key;
    try { localStorage.setItem('ai_key_groq', key); localStorage.setItem('ai_api_key', key); } catch(e) {}
    hint.innerHTML = '✅ <span style="color:var(--green)">Connected! Groq is ready.</span>';
    btn.textContent = '✓ Saved';
    setTimeout(() => {
      closeAPISetup(); btn.disabled = false; btn.textContent = 'Save & Test';
      if(!_aiOpen) {
        _aiOpen = true;
        document.getElementById('aiPanel').classList.add('on');
        document.getElementById('aiBtn').classList.add('open');
        document.getElementById('aiBtn').textContent = '✕';
        document.getElementById('aiInput').focus();
      }
    }, 800);
  } else {
    hint.innerHTML = `❌ <span style="color:var(--red)">${err}</span><br>
      <small style="color:var(--muted)">Get your key at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></small><br><br>
      <button onclick="forceSaveAPIKey('${key.replace(/'/g,"\\'")}'"
        style="background:var(--light);border:1px solid var(--border);border-radius:7px;padding:5px 12px;font-size:11px;cursor:pointer;color:var(--muted)">Save anyway (skip test)</button>`;
    btn.disabled = false; btn.textContent = 'Save & Test';
  }
}

function forceSaveAPIKey(key) {
  _keys.groq = key; _aiApiKey = key;
  try { localStorage.setItem('ai_key_groq', key); localStorage.setItem('ai_api_key', key); } catch(e) {}
  document.getElementById('apiKeyHint').innerHTML = '✅ <span style="color:var(--green)">Key saved — try sending a message.</span>';
  setTimeout(() => {
    closeAPISetup();
    if(!_aiOpen) {
      _aiOpen = true;
      document.getElementById('aiPanel').classList.add('on');
      document.getElementById('aiBtn').classList.add('open');
      document.getElementById('aiBtn').textContent = '✕';
      document.getElementById('aiInput').focus();
    }
  }, 800);
}

// compat stubs
function saveProviderKey(p) { saveAPIKey(); }
function forceSave(p, k) { forceSaveAPIKey(k); }
// ── CHAT SESSION MANAGEMENT ───────────────────────────────────
function promptSaveChat() {
  if(_aiHistory.length === 0) return;
  
  // Generate default name from first user message
  const firstMsg = _aiHistory.find(m => m.role === 'user');
  const defaultName = firstMsg ? firstMsg.content.substring(0, 40) + (firstMsg.content.length > 40 ? '...' : '') : 'Chat session';
  
  document.getElementById('chatSaveName').value = defaultName;
  document.getElementById('chatSaveModal').classList.add('on');
}

function cancelChatSave() {
  document.getElementById('chatSaveModal').classList.remove('on');
}

function saveChat() {
  const name = document.getElementById('chatSaveName').value.trim();
  if(!name || _aiHistory.length === 0) return;
  
  // Load existing chats for this profile
  let chats = [];
  try {
    chats = JSON.parse(localStorage.getItem(`ai_saved_chats_${currentProfile}`) || '[]');
  } catch(e) {}
  
  // Create new chat
  const chat = {
    id: Date.now().toString(),
    name: name,
    provider: _aiProvider,
    messages: _aiHistory,
    date: new Date().toISOString(),
    preview: _aiHistory.find(m => m.role === 'user')?.content.substring(0, 100) || ''
  };
  
  chats.unshift(chat);
  
  // Save for this profile
  try {
    localStorage.setItem(`ai_saved_chats_${currentProfile}`, JSON.stringify(chats));
  } catch(e) {
    alert('Failed to save chat: storage full');
  }
  
  // Clear current chat
  _aiHistory = [];
  renderAIMsgs();
  document.getElementById('aiChips').style.display = 'flex';
  
  document.getElementById('chatSaveModal').classList.remove('on');
}

function discardChat() {
  _aiHistory = [];
  renderAIMsgs();
  document.getElementById('aiChips').style.display = 'flex';
  document.getElementById('chatSaveModal').classList.remove('on');
}

function openSavedChats() {
  let chats = [];
  try {
    chats = JSON.parse(localStorage.getItem(`ai_saved_chats_${currentProfile}`) || '[]');
  } catch(e) {}
  
  const body = document.getElementById('savedChatsBody');
  
  if(chats.length === 0) {
    body.innerHTML = '<div class="saved-chats-empty"><div class="saved-chats-empty-icon">💬</div>No saved chats yet. Start a conversation and save it for later!</div>';
  } else {
    body.innerHTML = chats.map(chat => {
      const date = new Date(chat.date);
      const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const msgCount = chat.messages.length;
      const providerIcon = chat.provider === 'claude' ? '🧠' : '💬';
      
      return `
        <div class="saved-chat-item">
          <div class="saved-chat-name">${chat.name}</div>
          <div class="saved-chat-meta">${providerIcon} ${msgCount} messages · ${dateStr}</div>
          <div class="saved-chat-preview">${chat.preview}</div>
          <div class="saved-chat-actions">
            <button class="saved-chat-action" onclick="loadChat('${chat.id}')">Load</button>
            <button class="saved-chat-action delete" onclick="deleteChat('${chat.id}')">Delete</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  document.getElementById('savedChatsModal').classList.add('on');
}

function closeSavedChats() {
  document.getElementById('savedChatsModal').classList.remove('on');
}

function loadChat(chatId) {
  let chats = [];
  try {
    chats = JSON.parse(localStorage.getItem('ai_saved_chats') || '[]');
  } catch(e) {}
  
  const chat = chats.find(c => c.id === chatId);
  if(!chat) return;
  
  // Check if current chat has unsaved messages
  if(_aiHistory.length > 0) {
    if(!confirm('Load this chat? Your current conversation will be discarded.')) {
      return;
    }
  }
  
  // Load chat
  _aiHistory = chat.messages;
  _aiProvider = chat.provider;
  renderAIMsgs();
  document.getElementById('aiChips').style.display = 'none';
  
  closeSavedChats();
  
  // Open AI panel if not open
  if(!_aiOpen) {
    _aiOpen = true;
    document.getElementById('aiPanel').classList.add('on');
    document.getElementById('aiBtn').classList.add('open');
    document.getElementById('aiBtn').textContent = '✕';
  }
}

function deleteChat(chatId) {
  if(!confirm('Delete this chat permanently?')) return;
  
  let chats = [];
  try {
    chats = JSON.parse(localStorage.getItem('ai_saved_chats') || '[]');
  } catch(e) {}
  
  chats = chats.filter(c => c.id !== chatId);
  
  try {
    localStorage.setItem('ai_saved_chats', JSON.stringify(chats));
  } catch(e) {}
  
  openSavedChats(); // Refresh list
}

// ── EXPORT / IMPORT ALL DATA ──────────────────────────────────
function exportAllData() {
  try {
    const exportData = {
      version: 1,
      exportedAt: new Date().toISOString(),
      profile: currentProfile,
      R: R,
      QS: QS,
      EX: EX,
      notes: {},
      savedChats: [],
      theme: localStorage.getItem(`alrt_design_${currentProfile}`) || 'modern',
      pinkUnlocked: localStorage.getItem('pink_unlocked') === 'true'
    };
    // Grab all alrtn_ (notes) keys from R
    for (const [k, v] of Object.entries(R)) {
      if (k.startsWith('alrtn_')) exportData.notes[k] = v;
    }
    // Grab saved chats for this profile
    try {
      exportData.savedChats = JSON.parse(localStorage.getItem(`ai_saved_chats_${currentProfile}`) || '[]');
    } catch(e) {}
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `alevel-tracker-${currentProfile}-` + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    console.log('✅ Data exported successfully');
  } catch(e) {
    alert('Export failed: ' + e.message);
  }
}

// Auto-export to localStorage backup (runs after each save)
function autoBackup() {
  try {
    const backupData = {
      version: 1,
      backedUpAt: new Date().toISOString(),
      profile: currentProfile,
      R: R,
      QS: QS,
      EX: EX
    };
    localStorage.setItem(`alrt_autobackup_${currentProfile}`, JSON.stringify(backupData));
    console.log('🔄 Auto-backup completed');
  } catch(e) {
    console.warn('Auto-backup failed:', e.message);
  }
}

// Restore from auto-backup
function restoreAutoBackup() {
  try {
    const backupData = JSON.parse(localStorage.getItem(`alrt_autobackup_${currentProfile}`));
    if (!backupData || !backupData.R || !backupData.QS) {
      alert('❌ No auto-backup found for this profile.');
      return;
    }
    
    const backupDate = backupData.backedUpAt ? new Date(backupData.backedUpAt).toLocaleString() : 'unknown';
    
    if (!confirm(`Restore auto-backup from ${backupDate}?\n\nThis will restore your last saved state.`)) {
      return;
    }
    
    R = backupData.R;
    QS = backupData.QS;
    EX = backupData.EX || {};
    
    save();
    render();
    
    alert('✅ Auto-backup restored successfully!');
  } catch(e) {
    alert('❌ Restore failed: ' + e.message);
  }
}

function importAllData(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.R || !data.QS) {
        alert('❌ Invalid backup file — missing data.');
        return;
      }
      
      const backupProfile = data.profile || 'unknown';
      const backupDate = data.exportedAt ? new Date(data.exportedAt).toLocaleString() : 'unknown date';
      
      if (!confirm(`Import backup from ${backupDate}?\n\nProfile: ${backupProfile}\nCurrent profile: ${currentProfile}\n\nThis will MERGE with your current data (existing entries kept, imported entries added/updated).`)) {
        input.value = '';
        return;
      }
      
      // Merge R (ratings, notes)
      Object.assign(R, data.R);
      
      // Merge QS (question bank) — add questions not already present
      for (const [k, qs] of Object.entries(data.QS)) {
        if (!QS[k]) {
          QS[k] = qs;
        } else {
          const existingIds = new Set(QS[k].map(q => q.id));
          for (const q of qs) {
            if (!existingIds.has(q.id)) QS[k].push(q);
          }
        }
      }
      
      // Merge EX (exams)
      if (data.EX) Object.assign(EX, data.EX);
      
      // Merge saved chats for current profile
      if (data.savedChats && data.savedChats.length) {
        let existing = [];
        try { existing = JSON.parse(localStorage.getItem(`ai_saved_chats_${currentProfile}`) || '[]'); } catch(e) {}
        const existingChatIds = new Set(existing.map(c => c.id));
        for (const chat of data.savedChats) {
          if (!existingChatIds.has(chat.id)) existing.push(chat);
        }
        try { localStorage.setItem(`ai_saved_chats_${currentProfile}`, JSON.stringify(existing)); } catch(e) {}
      }
      
      // Import theme if present
      if (data.theme) {
        try { localStorage.setItem(`alrt_design_${currentProfile}`, data.theme); } catch(e) {}
      }
      
      // Import pink unlock status
      if (data.pinkUnlocked) {
        try { localStorage.setItem('pink_unlocked', 'true'); } catch(e) {}
        pinkUnlocked = true;
      }
      
      // Save and re-render
      save();
      render();
      
      alert('✅ Data imported successfully! Your notes, ratings, exam scores, and question bank have been restored.');
    } catch(e) {
      alert('❌ Import failed: ' + e.message);
    }
    input.value = '';
  };
  reader.readAsText(file);
}

// ── AI PANEL RESIZE ───────────────────────────────────────────
const AI_DEFAULT_W = 380;
const AI_DEFAULT_H = 520;

function resetAIPanelSize() {
  const panel = document.getElementById('aiPanel');
  panel.style.width = AI_DEFAULT_W + 'px';
  panel.style.maxHeight = AI_DEFAULT_H + 'px';
  panel.style.height = '';
  panel.style.bottom = '88px';
  panel.style.right = '24px';
}

(function initAIResize() {
  const handle = document.getElementById('aiResizeHandle');
  const panel = document.getElementById('aiPanel');
  let startX, startY, startW, startH, startBottom, startRight;

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    const rect = panel.getBoundingClientRect();
    startX = e.clientX;
    startY = e.clientY;
    startW = rect.width;
    startH = rect.height;
    startBottom = window.innerHeight - rect.bottom;
    startRight = window.innerWidth - rect.right;

    panel.classList.add('resizing');

    function onMove(e) {
      const dx = startX - e.clientX; // dragging left = wider
      const dy = startY - e.clientY; // dragging up = taller
      const newW = Math.max(280, Math.min(window.innerWidth - 48, startW + dx));
      const newH = Math.max(200, Math.min(window.innerHeight - 120, startH + dy));
      panel.style.width = newW + 'px';
      panel.style.maxHeight = newH + 'px';
      panel.style.height = newH + 'px';
    }

    function onUp() {
      panel.classList.remove('resizing');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Touch support
  handle.addEventListener('touchstart', e => {
    const touch = e.touches[0];
    const rect = panel.getBoundingClientRect();
    startX = touch.clientX; startY = touch.clientY;
    startW = rect.width; startH = rect.height;
    panel.classList.add('resizing');

    function onMove(e) {
      const t = e.touches[0];
      const dx = startX - t.clientX;
      const dy = startY - t.clientY;
      panel.style.width = Math.max(280, Math.min(window.innerWidth - 48, startW + dx)) + 'px';
      const newH = Math.max(200, Math.min(window.innerHeight - 120, startH + dy));
      panel.style.maxHeight = newH + 'px';
      panel.style.height = newH + 'px';
    }
    function onUp() {
      panel.classList.remove('resizing');
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
    }
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend', onUp);
  });
})();

// Load API settings on init
loadAPISettings();

// ═══════════════════════════════════════════════════════════
// MOBILE OPTIMIZATIONS
// ═══════════════════════════════════════════════════════════

// Mobile: Header auto-hide on scroll
let lastScrollY = 0;
let ticking = false;
let scrollThreshold = 50;
let tilesHidden = false;

function updateMobileHeader() {
  if (window.innerWidth > 720) return; // Mobile only
  
  const currentScrollY = window.scrollY;
  const header = document.querySelector('.header');
  const overviewTiles = document.querySelector('.overview-tiles');
  const grid = document.querySelector('.grid');
  
  if (!header) return;
  
  // Show header on scroll up, hide on scroll down
  if (currentScrollY > lastScrollY && currentScrollY > scrollThreshold) {
    // Scrolling down
    header.classList.add('header-hidden');
    header.classList.remove('header-show');
    
    // Hide tiles when scrolling down past 150px
    if (overviewTiles && currentScrollY > 150 && !tilesHidden) {
      overviewTiles.classList.add('tiles-hidden');
      tilesHidden = true;
      
      // Zoom in grid
      if (grid) {
        grid.style.transform = 'scale(1.1)';
        grid.style.transformOrigin = 'top center';
        grid.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
      }
    }
  } else {
    // Scrolling up
    header.classList.remove('header-hidden');
    header.classList.add('header-show');
    
    // Show tiles when scrolling back up
    if (overviewTiles && currentScrollY < 100) {
      overviewTiles.classList.remove('tiles-hidden');
      tilesHidden = false;
      
      // Reset grid zoom
      if (grid) {
        grid.style.transform = 'scale(1)';
      }
    }
  }
  
  lastScrollY = currentScrollY;
  ticking = false;
}

function requestMobileHeaderUpdate() {
  if (!ticking) {
    window.requestAnimationFrame(updateMobileHeader);
    ticking = true;
  }
}

if (window.innerWidth <= 720) {
  window.addEventListener('scroll', requestMobileHeaderUpdate, {passive: true});
}

// Mobile: Subject popup (for Maths/Further Maths subtabs)
function showSubjectPopup(subject) {
  if (window.innerWidth > 720) {
    console.log('showSubjectPopup: Not mobile, skipping');
    return; // Only on mobile
  }
  
  console.log('showSubjectPopup called for:', subject, 'windowWidth:', window.innerWidth);
  
  const popup = document.getElementById('subjectPopup');
  const optionsContainer = document.getElementById('subjectPopupOptions');
  
  if (!popup) {
    console.error('Popup element not found!');
    return;
  }
  
  if (!optionsContainer) {
    console.error('Options container not found!');
    return;
  }
  
  // Define subtabs for each subject (matching desktop structure exactly)
  const subtabs = {
    'maths': [
      {id: 'maths_py1', label: 'Pure Year 1', icon: '📐'},
      {id: 'maths_py2', label: 'Pure Year 2', icon: '📊'},
      {id: 'maths_sm1', label: 'Stats & Mech Y1', icon: '📈'},
      {id: 'maths_sm2', label: 'Stats & Mech Y2', icon: '⚙️'}
    ],
    'further': [
      {id: 'fm_cp1', label: 'Core Pure 1', icon: '🔬'},
      {id: 'fm_cp2', label: 'Core Pure 2', icon: '🧮'},
      {id: 'fm_fmech1', label: 'Further Mechanics 1', icon: '⚡'},
      {id: 'fm_fstat1', label: 'Further Statistics 1', icon: '🎯'}
    ]
  };
  
  const options = subtabs[subject] || [];
  
  console.log('Found', options.length, 'options for subject:', subject);
  
  if (options.length === 0) {
    console.error('No options found for subject:', subject);
    return;
  }
  
  optionsContainer.innerHTML = options.map(opt => `
    <div class="subject-option" onclick="selectSubject('${subject}', '${opt.id}')">
      <span>${opt.icon} ${opt.label}</span>
      <span class="subject-option-arrow">→</span>
    </div>
  `).join('');
  
  popup.classList.add('on');
  document.body.style.overflow = 'hidden';
  
  console.log('Popup displayed with class "on", innerHTML length:', optionsContainer.innerHTML.length);
}

function selectSubject(subject, subtabId) {
  console.log('selectSubject called:', subject, subtabId);
  closeSubjectPopup();
  
  // Temporarily bypass the popup for this selection
  window._bypassMobilePopup = true;
  
  // Hide page content to prevent flash
  const page = document.querySelector('.page');
  if (page) page.style.opacity = '0';
  
  // Switch to the main subject first
  if (typeof switchSubject === 'function') {
    switchSubject(subject === 'maths' ? 'maths' : 'fm');
  }
  
  // Immediately switch to the specific subtab (no delay)
  if (typeof switchSubTab === 'function') {
    switchSubTab(subtabId);
  }
  
  // Show page content after switching
  requestAnimationFrame(() => {
    if (page) page.style.opacity = '1';
  });
  
  // Reset bypass flag
  setTimeout(() => {
    window._bypassMobilePopup = false;
  }, 300);
}

function closeSubjectPopup() {
  const popup = document.getElementById('subjectPopup');
  if (popup) {
    popup.classList.remove('on');
    document.body.style.overflow = '';
  }
}

// Mobile: Topic modal (full screen zoom-in for topic cards)
let currentTopicData = null;

function showTopicModal(subjectKey, topicKey) {
  if (window.innerWidth > 720) return false; // Only on mobile, let desktop handle it normally
  
  // Just call the desktop pick function directly - it already handles everything
  if (typeof pick === 'function') {
    pick(subjectKey, topicKey);
    return true;
  }
  
  console.error('pick() function not found');
  return false;
}

function closeTopicModal() {
  const modal = document.getElementById('topicModal');
  if (modal) {
    modal.classList.remove('on');
    document.body.style.overflow = '';
    currentTopicData = null;
    render(); // Re-render to update any changes
  }
}

// Mobile: Intercept topic card clicks on mobile
document.addEventListener('click', function(e) {
  if (window.innerWidth > 720) return;
  
  const topicCard = e.target.closest('.scard');
  if (topicCard && topicCard.classList.contains('topic-card')) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    const subjectKey = topicCard.dataset.subject;
    const topicKey = topicCard.dataset.topic;
    
    if (subjectKey && topicKey) {
      console.log('Opening topic modal for:', subjectKey, topicKey);
      showTopicModal(subjectKey, topicKey);
    }
    return false;
  }
}, true);

// Mobile: Intercept main subject clicks to show popup for maths/further
window._mobileDebug = true; // Enable debug logging
window._bypassMobilePopup = false; // Initialize to false

const originalSwitchSubject = window.switchSubject;
if (typeof originalSwitchSubject === 'function') {
  window.switchSubject = function(subject) {
    if (window._mobileDebug) {
      console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
      console.log('📱 switchSubject intercepted');
      console.log('  Subject:', subject);
      console.log('  Window width:', window.innerWidth);
      console.log('  Is mobile?:', window.innerWidth <= 720);
      console.log('  Bypass flag:', window._bypassMobilePopup);
      console.log('  Will show popup?:', window.innerWidth <= 720 && (subject === 'maths' || subject === 'fm') && !window._bypassMobilePopup);
    }
    
    // Only show popup if we're on mobile, it's maths/further, and not bypassing
    if (window.innerWidth <= 720 && (subject === 'maths' || subject === 'fm') && !window._bypassMobilePopup) {
      if (window._mobileDebug) console.log('  ✅ Calling showSubjectPopup');
      showSubjectPopup(subject === 'maths' ? 'maths' : 'further');
      return;
    }
    if (window._mobileDebug) console.log('  ℹ️ Calling original function');
    originalSwitchSubject(subject);
  };
  console.log('✅ Mobile switchSubject override installed');
} else {
  console.error('❌ switchSubject function not found!');
}

// Safety: If bypass flag gets stuck, reset it after 2 seconds of no activity
let bypassResetTimer;
document.addEventListener('click', () => {
  if (window._bypassMobilePopup) {
    clearTimeout(bypassResetTimer);
    bypassResetTimer = setTimeout(() => {
      if (window._bypassMobilePopup) {
        console.warn('⚠️ Bypass flag was stuck - forcing reset');
        window._bypassMobilePopup = false;
      }
    }, 2000);
  }
});


// Mobile: Update render function to add data attributes to topic cards
const originalRender = window.render;
if (typeof originalRender === 'function') {
  window.render = function() {
    originalRender();
    
    // Add data attributes to topic cards for mobile
    if (window.innerWidth <= 720) {
      document.querySelectorAll('.scard').forEach(card => {
        const onclick = card.getAttribute('onclick');
        if (onclick) {
          const match = onclick.match(/pick\('(\w+)','(\w+)'\)/);
          if (match) {
            card.dataset.subject = match[1];
            card.dataset.topic = match[2];
            card.classList.add('topic-card');
          }
        }
      });
    }
  };
}

// Debug: Log when mobile optimizations are loaded
console.log('Mobile optimizations loaded. Width:', window.innerWidth, 'isMobile:', window.innerWidth <= 720);

</script>

<!-- Mobile Subject Selection Popup -->
<div id="subjectPopup" class="subject-popup" onclick="closeSubjectPopup()">
  <div class="subject-popup-content" onclick="event.stopPropagation()">
    <div class="subject-popup-close" onclick="closeSubjectPopup()">×</div>
    <div class="subject-popup-title">Select Topic Area</div>
    <div class="subject-popup-subtitle">Choose a subject to view</div>
    <div class="subject-popup-options" id="subjectPopupOptions">
      <!-- Options will be inserted by JavaScript -->
    </div>
  </div>
</div>

<!-- Mobile Topic Modal (Full Screen) -->
<div id="topicModal" class="topic-modal" onclick="closeTopicModal()">
  <div class="topic-modal-content" onclick="event.stopPropagation()">
    <div class="topic-modal-header">
      <div class="topic-modal-title" id="topicModalTitle">Topic</div>
      <div class="topic-modal-close" onclick="closeTopicModal()">×</div>
    </div>
    <div class="topic-modal-body" id="topicModalBody">
      <!-- Topic content will be inserted here -->
    </div>
  </div>
</div>

<!-- Mobile AI Toggle Button -->
<button class="ai-toggle" id="aiToggleBtn" onclick="toggleAIPanel()" style="display: none;">✨</button>

</body>
</html>
